<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet1.css">
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css"><link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
		<link rel="stylesheet" href="css/leaflet-search.css">
		<link rel="stylesheet" href="css/style.css">
        <!--link rel="stylesheet" href="css/range.css"-->
        <link rel="stylesheet" href="css/Control.OSMGeocoder.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
		<style id="workAround">
		</style>
		<style>
			html, body, #map {
				width: 100%;
				height: 100%;
				padding: 0;
				margin: 0;
				z-index: 100;
			}
			#loader {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100%;
				background-color: rgba(255, 255, 255, 0.7);
				z-index: 2000;
			}
			#loader img {
				width: 200px;
				height: 200px;
				border-radius: 100px;
				position: absolute;
				top: 50%;
				left: 50%;
				margin: -100px 0 0 -100px;
				z-index: 9999;
			}
        </style>
		<!--style type='text/css'>
			#btn-spin {
			  position: absolute;
			  left: 200px;
			  z-index: 10;
			  font-size: 1.5em;
			}
			.help {
				font-size: 1.5em;
				position: absolute;
				top:0;
				left: 0;
				right: 0;
				height: 30px;
				z-index: 10;
				background-color: rgba(0,0,0,0.5);
				color: white;
				padding: 10px;
				margin: 0px;
				text-align: center;
			}
			.help a.sources {
				float: left;
				margin-left: 50px;
				color: white;
			}
			.help a.logo {
				float: right;
			}
			.help a.logo img {
				height: 30px;
			}	
		</style-->
        <title>2019 Polish parliamentary election - Sejm</title>
    </head>
    <body>
        <div id="map">
			<div id='loader'>
				<p style="color: black; padding: 20px; font-size: 32px; display: block; position: absolute; top: 20%; width: 100%; text-align: center;">Loading map data...</p>
				<img src='images/200.gif' alt='loader' />
			</div>
			<div class="modal"><!-- Place at bottom of page --></div>
        </div>
		<script src="js/jquery-3.5.1.min.js"></script>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script><script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
		<script src="js/leaflet-side-by-side.min.js"></script>
		<script src="js/tinyqueue.min.js"></script>
        <script src="js/polylabel.js"></script>
		<script src="js/leaflet-search.src.js"></script>
		<script src="js/Chart.min_.js"></script>
		<script src="js/regression.min.js"></script>
		<script type='text/javascript' src="js/leaflet.spin.min.js"></script>
		<script src="js/spin.js"></script>
		
        <!--script src="data/GminydemDPolygon_0.js"></script-->
        <script src="data/GminydemDPolygon_1.js"></script>
        <!--script src="data/GminydemDPolygon_2.js"></script-->
		<script src="data/Powiaty_Simplified_6.js"></script>
		<script src="data/Okr.js"></script>
		
        <script>
		var layers = {};
		var r_layers = {};
		var layer_code = 1465011;
		var l1, l2, l3, l4, l5;
		var already_filtered = true;
		var block_cl_pop = false;
		var pop_op=false;
		var party = 0;
		var px;
		
		var pointBackgroundColors = [];
		var pointFBackgroundColors = [];
		var pointBBackgroundColors = [];
		var pointRBackgroundColors = [];
		var pointRFBackgroundColors = [];
		var pointRBBackgroundColors = [];
		var pointRBBorderColors = [];
		var pointRadiuses = [];
		var pointBorderColors = [];
		var pointBBorderColors = [];
		var pointBorderWidths = [];
		var current_KOD = '1465011';
		var gminList = [];
		var powList = [];
		var kodList = [];
		var pow_ats = {};
		var pow_ats2 = {};
		var okrs = {};
		var okrs2 = {};
		
		var JEkod = {};
		var JEnazwa = {};
		var JEudzial = {};
		var JEkolor ={};
		var OEkod = {};
		var OEnazwa = {};
		var OEudzial = {};
		var OEkolor ={};
		var OEpow = {};
		var PLkod = {};
		var PLnazwa = {};
		var PLudzial = {};
		var PLkolor ={};
		var PLpow ={};
		var PLwoj ={};
		
		var scatterPlotDataArray_xy = [];
		var scatterPlotDataArray_xz = [];
		var scatterPlotDataArray_yx = [];
		var scatterPlotDataArray_yz = [];
		var scatterPlotDataArray_zx = [];
		var scatterPlotDataArray_zy = [];
		var scatterPlotDataArray_xp = [];
		var scatterPlotDataArray_yp = [];
		var scatterPlotDataArray_zp = [];
		var scatterPlotDataArray_px = [];
		var scatterPlotDataArray_py = [];
		var scatterPlotDataArray_pz = [];
		
		var layer_change_first_clicked = false;
		var select_change_first_clicked = false;
		var subselect_change_first_clicked = false;
		var popup_open_first_clicked = false;
		var popup_close_first_clicked = false;
		var manual_popup = true;
		var manual_zoom = true;
		var manually_zoomed = true;
		var programmaticMapManipulation = false;
		var temp_zoomed = true;
		var item_clicked = false;
		var adm_clicked = false;
		var sel_clicked = false;
		var subsel_clicked = false;
		var polygon_clicked = false;
		var manual_select = true;
		var block_centering = false;
		var select_twice = false;
		var auto_zoom = false;
		var already_selected = true;
		var xa = '1st-listed cand. (%)';
		var ya = '2nd-listed cand. (%)';
		var za = 'Other cand. (%)';
		var pa = 'Support for the list (%)';
		var xb = xa;
		var yb = ya;
		var zb = za;
		var pb = pa;
		var layer_nr = 1;
		var zooming = false;
		var to_subsel = false;
		var party_codes = [26079,26075,26063,26091,26073];
		
		var czoom = 6;
		var szoom = 6;
		var prezoom = 6;
		
		var cind =1;
		var vind =1;
		
		var sc, sd, sc_temp;
		
		var pow_last = '1465';
		var ptemp = '';
		
		var tooltipThreshold = 9;
		var lastZoom = 6;
		
		var pop_moving = false;
		
		const name_1 = ' LAW AND JUSTICE';
		const name_2 = ' CIVIC COALITION';
		const name_3 = ' THE LEFT';
		const name_4 = ' POLISH COALITION';
		const name_5 = ' CONFEDERATION';
		
		var lab_centers = [];
		L.Polygon.include({
			_update: function () {
				if (!this._map) { return; }

				this._clipPoints();
				this._simplifyPoints();
				this._updatePath();
				this.fire('reclipped', {parts: this._parts})
			}
		});
        var basemap0 = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
            maxZoom: 10
        });
		var map = L.map('map', {
            zoomControl:true, maxZoom:10, minZoom:6, layers: [basemap0]
        }).fitBounds([[48.7066734906,11.9596852528],[54.6789300376,27.5634833614]]);
        var hash = new L.Hash(map);
        map.attributionControl.addAttribution('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a>');
		map.attributionControl.addAttribution('<a href="https://sejmsenat2019.pkw.gov.pl/sejmsenat2019/" target="_blank">Wybory do Sejmu i Senatu Rzeczypospolitej Polskiej 2019</a>');
		map.attributionControl.addAttribution('<a href="https://github.com/jschoeley/tricolore" target="_blank">tricolore</a>');
        //L.control.locate().addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
		szoom = map.getZoom();
		var stripes = new L.StripePattern({weight: 2, spaceWeight: 6, color: '#aa4444', opacity: 0.25, spaceOpacity: 0.0, angle: 45});
		//var stripes = new L.PatternCircle({ x: 12, y: 12, radius: 10, fill: true });
        stripes.addTo(map);
		var patt_blank = new L.StripePattern({opacity: 0.0, spaceOpacity: 0.0});
		patt_blank.addTo(map);
		
		function numberWithSpaces(x) {
			var tg = x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "&nbsp;");
			return tg + "&#8199;&#8199;";
		}
		function lengthToBlank(number) {
			var ntext = "";
			var length = number.toString().length;
			for (i=0; i<7-length; i++){
				ntext = ntext + "&#8199;";
			}
			if (length<4) ntext = ntext + "&nbsp;";
			if (length<7) ntext = ntext + "&nbsp;";
			return ntext;
		}
		function lengthToBlank1(number) {
			var percent  = parseFloat(number).toFixed(2);
			if (number==100){
				return "&#8199;"+percent;
			}else if (number/10>=1){
				return "&#8199;&#8199;"+percent;
			}else{
				return "&#8199;&#8199;&#8199;"+percent;
			}
		}
		
		function lengthToBlank2(number) {
			var ntext = [];
			var percent ;
			if(number>0){
				percent = "+"+number.toFixed(2);
			}else{
				percent = number.toFixed(2);
			}
				
			var length = percent.length;
			for (i=0; i<7-length; i++){
				ntext .push("&#8199;");
			}
			/*if (length<4) ntext = ntext + "&#8199;";*/
			ntext .push(percent);
			return ntext.join("");
		}
		
		function lengthToBlank3(number) {
			var ntext = "";
			var length = number.toString().length;
			for (i=0; i<9-length; i++){
				ntext = ntext + "&#8199;";
			}
			/*if (length<4) ntext = ntext + "&#8199;";*/
			if (length<7) ntext = ntext + "&nbsp;";
			return ntext;
			
		}
		
		function lengthToBlanP3_3(number) {
			var ntext = [];
			var percent ;
			if(number>0){
				percent = "+"+number.toFixed(2);
			}else{
				percent = number.toFixed(2);
			}
				
			var length = percent.length;
			for (i=0; i<6-length; i++){
				ntext .push("&#8199;");
			}
			/*if (length<4) ntext = ntext + "&#8199;";*/
			ntext .push(percent);
			return ntext.join("");
		}
		
		function colorizeTextR(value){
			if (value==0){
				return ' style = "font-weight: 700; color: #101010">';
			}else if  (value>0){
				return ' style = "font-weight: 700; color: green">';
			}else{
				return ' style = "font-weight: 700; color: red">';
			}
		}
		function colorizeTextRt(value){
			if (value==0){
				return ' style = "font-weight: 700;">';
			}else if  (value>0){
				return ' style = "font-weight: 700; color: #109010">';
			}else{
				return ' style = "font-weight: 700; color: #ff1010">';
			}
		}
		
		json_GminydemDPolygon_0.getFeaturesByProperty = function(key, value) {
		  return this.features.filter(function(feature){
			if (feature.properties[key] === value) {
			  return true;
			} else {
			  return false;
			}
		  });
		};
		json_Powiaty_Simplified_1.getFeaturesByProperty = function(key, value) {
		  return this.features.filter(function(feature){
			if (feature.properties[key] === value) {
			  return true;
			} else {
			  return false;
			}
		  });
		};
		json_Okr.getFeaturesByProperty = function(key, value) {
		  return this.features.filter(function(feature){
			if (feature.properties[key] === value) {
			  return true;
			} else {
			  return false;
			}
		  });
		};
		
		function arrayXMin(arr) {
		  var len = arr.length, min = Infinity;
		  while (len--) {
			if (arr[len].x < min) {
			  min = arr[len].x;
			}
		  }
		  return min;
		};
		
		function arrayYMin(arr) {
		  var len = arr.length, min = Infinity;
		  while (len--) {
			if (arr[len].y < min) {
			  min = arr[len].y;
			}
		  }
		  return min;
		};
		
		function arrayXMax(arr) {
		  var len = arr.length, max = -Infinity;
		  while (len--) {
			if (arr[len].x > max) {
			  max = arr[len].x;
			}
		  }
		  return max;
		};
		
		function arrayYMax(arr) {
		  var len = arr.length, max = -Infinity;
		  while (len--) {
			if (arr[len].y > max) {
			  max = arr[len].y;
			}
		  }
		  return max;
		};
		
		function renderRow(rtext,r1,r2,r3,r4,r5,font_weight,divided){
			var multistringText =  [];
			if (divided){
				multistringText.push('<tr class="divider">');
			}else{
				multistringText.push('<tr>');
			}
			var r_opt = '<td style="font-weight: '+font_weight+';">';
			multistringText.push('<td><b>'+rtext+'</b></td>');
			r1=='&mdash;'?multistringText.push('<td>&mdash;</td>'):multistringText.push(r_opt+lengthToBlank1(r1)+'%</td>');
			multistringText.push(r_opt+lengthToBlank1(r2)+'%</td>');
			multistringText.push(r_opt+lengthToBlank1(r3)+'%</td>');
			multistringText.push(r_opt+lengthToBlank1(r4)+'%</td>');
			multistringText.push(r_opt+lengthToBlank1(r5)+'%</td>');
			multistringText.push('</tr>');
			return multistringText.join('');
		}
		function renderRow_text(rtext,r1,r2,r3,r4,r5,font_size,divided){
			var multistringText =  [];
			if (divided){
				multistringText.push('<tr class="divider">');
			}else{
				multistringText.push('<tr>');
			}
			var r_opt = '<td class="td_row" style="font-size: '+font_size+'px;">';
			multistringText.push('<td><b>'+rtext+'</b></td>');
			r1=='&mdash;'?multistringText.push('<td>&mdash;</td>'):multistringText.push(r_opt+r1+'</td>');
			multistringText.push(r_opt+r2+'</td>');
			multistringText.push(r_opt+r3+'</td>');
			multistringText.push(r_opt+r4+'</td>');
			multistringText.push(r_opt+r5+'</td>');
			multistringText.push('</tr>');
			return multistringText.join('');
		}
		
		
		var std = '<td>';
		var xtd = '</td>';
		var bgcolor1 = '<div style = "display: inline-block; background-color: white; width: 28px; height: 28px;"><div style = "background-color: ';
		var bgcolor12 = '<div style = "display: inline-block; background-color: white; width: 24px; height: 24px;"><div style = "background-color: ';
		var bgcolor2 = '<td style="border-right: 2px dotted #bbb;"><div style = "background-color: white; display: inline-block; width: 28px; height: 28px;"><div style = "background-color: ';
		var inlbl = '; display: inline-block; padding: 12px; opacity: 0.8; border: 1px solid rgba(16, 16, 16, 0.2);"></div></div>';
		function renderColor(ccolor, divided=false){
			if (divided){
				return bgcolor2 + ccolor + inlbl + xtd ;
			}else{
				return std + bgcolor12 + ccolor + inlbl + xtd;
			}
		}
		function toPkw(kod){
			var a;
			if (kod=='1465011'){
				a = 'pow/146501';
			}else{
				a = 'gm/'+kod.substring(0, 6);
			}
			return 'https://sejmsenat2019.pkw.gov.pl/sejmsenat2019/en/wyniki/sejm/'+a;
		}
		var pow_map = new Map();
        function pop_GminydemDPolygon_0(feature, layer) {
			var p = layer.feature.properties;
			var popupContent = '<h5 style="margin-bottom: 8px;"><a href = "'+toPkw(p.JPT_KOD_JE)+'" target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a>'+(p.JPT_KOD_JE.substring(6, 7) !== "1"? 'gm.' : '')+'&nbsp;'+p.JPT_NAZWA_+'</h5><div class="tabs">\
				<ul class="tab-links">\
					<li class="active"><a href="#tab1">Summary</a></li>\
					<li><a href="#tab2"><img src="legend/PiS.png" alt ="PiS"  class="Logo"/> </a></li>\
					<li><a href="#tab3"><img src="legend/KO.png" alt="KO"   class="Logo"/></a></li>\
					<li><a href="#tab4"><img src="legend/Lewica.jpg" alt="Lewica"   class="Logo"/></a></li>\
					<li><a href="#tab5"><img src="legend/PSL.png" alt="PSL"   class="Logo"/></a></li>\
					<li><a href="#tab6"><img src="legend/Konfederacja.jpg" alt="Konfederacja"   class="Logo"/></a></li>\
				</ul>\
				<div style="width: 656px; height: 16px; margin-left: 0px; margin-top: -16px; background-image: linear-gradient(to bottom, #fff, #fff 8px, #f4f4f4 16px); border-radius: 16px 16px 0 0; z-index: 960; box-shadow: 5px 5px 3px rgba(80, 128, 80, 0.25), -5px 5px 3px rgba(80, 128, 80, 0.25); overflow: hidden;"></div>\
				<div class="tab-content">\
					<div id="tab1" class="tab active">\
						<div></div>\
					</div>\
					<div id="tab2" class="tab">\
						<p>Błąd wczytywania danych. Proszę spróbować ponownie za kilka chwil.</p>\
					</div>\
					<div id="tab3" class="tab">\
						<p>Błąd wczytywania danych. Proszę spróbować ponownie za kilka chwil.</p>\
					</div>\
					<div id="tab4" class="tab">\
						<p>Błąd wczytywania danych. Proszę spróbować ponownie za kilka chwil.</p>\
					</div>\
					<div id="tab5" class="tab">\
						<p>Błąd wczytywania danych. Proszę spróbować ponownie za kilka chwil.</p>\
					</div>\
					<div id="tab6" class="tab">\
						<p>Błąd wczytywania danych. Proszę spróbować ponownie za kilka chwil.</p>\
					</div>\
				</div>\
				<div style="clear:both;">\
				\</div>\
			</div>';
			
            layer.bindPopup(popupContent, {maxHeight: 800, autoPanPaddingTopLeft: [80,20],autoPanPaddingBottomRight: [320,20]});
			
			rotateData(p, p.P1_1, p.P1_2, p.P1_p);
			//p.wojewod = p.JPT_KOD_JE.substring(0,2);
			//console.log(p.wojewod);
			kodList.push(p.JPT_KOD_JE);
			pow_map.set(p.JPT_KOD_JE.substring(0,4), p.Okr);
			p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
			p.Powiat = p.JPT_KOD_JE.substring(0,4);
			p.short = p.JPT_KOD_JE.substring(0,6);
			for (i=1;i<6;i++){
				p['P'+i+'_3']=100-(p['P'+i+'_1']+p['P'+i+'_2']);
			}
			layers[feature.properties.JPT_KOD_JE] = layer;
			pointBackgroundColors.push(colorconvert(p.P1_rgb,0.8));
			pointFBackgroundColors.push(p.P1_rgb);
			pointBBackgroundColors.push(colorconvert(p.P1_rgb,0.32));
			pointBBorderColors.push('rgba(255, 255, 255, 0.2)');
			//pointBBorderColors.push('rgba(224, 224, 224, 0.08)');
			/*if (current_KOD==feature.properties.JPT_KOD_JE){
				pointRadiuses.push(6.4);
				pointBorderColors.push('rgba(255, 0, 0, 0.4)');
				pointBorderWidths.push(2);
			}else{*/
				pointRadiuses.push(3.6);
				pointBorderColors.push('rgba(64, 64, 64, 0.64)');
				pointBorderWidths.push(1);
			//}
			gminList.push(p.JPT_NAZWA_);
        }
		var lcolors = ['#fff7f3', '#fde0dd' ,'#fcc5c0' ,'#fa9fb5' ,'#f768a1' ,'#dd3497' ,'#ae017e' ,'#7a0177'];
		var gcolors = ['#ffffd9', '#edf8b1', '#c7e9b4', '#7fcdbb', '#41b6c4', '#1d91c0', '#225ea8', '#0c2c84'];
		var fcolors = ['#f7fcfd', '#e0ecf4', '#bfd3e6', '#9ebcda', '#8c96c6', '#8c6bb1', '#88419d', '#6e016b'];
		var hcolors = ['#ffffff', '#ffffff', '#ffffff', '#ffffff', '#ffffff', '#ffffff', '#ffffff', '#ffffff'];
		
		var pisbreaks = [18.31, 32.81, 40.00, 46.48, 52.88, 59.31, 65.70, 72.65, 88.87];
		var kobreaks = [0.96, 6.81, 10.95, 15.56, 20.47, 25.93, 32.31, 40.47, 55.56];
		var lbreaks = [0.98, 4.14, 6.25, 8.37, 10.62, 13.08, 15.94, 19.99, 31.06];
		var pslbreaks = [3.21, 6.74, 9.05, 11.25, 13.80, 17.07, 21.19, 26.97, 40.77];
		var konfbreaks = [1.53, 4.32, 5.33, 6.20, 7.01, 7.90, 9.06, 11.18, 16.56];
		var allbreaks = [pisbreaks, kobreaks, lbreaks, pslbreaks, konfbreaks];
		console.log(allbreaks[2][3]);
		map.createPane('left');
		map.createPane('right');
		/*map.createPane('left3');
		map.createPane('right3');*/
		
		function style_Layer(column, breaks, colors = fcolors){
			return function(feature){
				for (i=1; i<9; i++){
					if (feature.properties[column] >= breaks[i-1] && feature.properties[column] <= breaks[i]){
						var col_line = 128-16*i;
						return {
							opacity: 1.0,
							color: 'rgba('+col_line+', '+col_line+', '+col_line+', 0.8)',
							dashArray: '',
							lineCap: 'butt',
							lineJoin: 'miter',
							//dashArray: "30 10",
							weight: 0.32, 
							fill: true,
							fillOpacity: 0.8,
							fillColor: colors[i-1],
							className: 'stroke-polyline',
						}
					}
				}
			}
		}
		
		function returnColor_g(column, breaks, obj, colors = fcolors){
			//return function(layer){
				for (i=1; i<9; i++){
					if (obj.properties[column] >= breaks[i-1] && obj.properties[column] <= breaks[i]){
						//var col_line = 128-16*i;
						return  colors[i-1];
					}
				}
			//}
		}
		function returnColor_simpl(value, breaks, colors = fcolors){
			//return function(layer){
				console.log(value);
				for (i=1; i<9; i++){
					if (value >= breaks[i-1] && value <= breaks[i]){
						//var col_line = 128-16*i;
						return  colors[i-1];
					}
				}
			//}
		}
		function style_Layer_cmy(column){
			return function(feature){
				return {
					opacity: 1.0,
					color: 'rgba(80, 80, 80, 0.8)',
					dashArray: '',
					lineCap: 'butt',
					lineJoin: 'miter',
					weight: 0.32, 
					fill: true,
					fillOpacity: 0.8,
					fillColor: feature.properties[column],
					className: 'stroke-polyline_cmy',
				}
			}
		}

		//console.log(pointRBackgroundColors);
		
		//console.log(fcolors);
		var layer_P1_cmy = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'left',
			onEachFeature: pop_GminydemDPolygon_0,
			style: style_Layer_cmy('P1_rgb')
		});
		var layer_P1 = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'right',
			onEachFeature: pop_Gm_0,
			style: style_Layer('P1_p', pisbreaks)
		});
		var layer_P2_cmy = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'left',
			onEachFeature: pop_Gm_0,
			style: style_Layer_cmy('P2_rgb')
		});
		var layer_P2 = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'right',
			onEachFeature: pop_Gm_0,
			style: style_Layer('P2_p', kobreaks)
		});
		var layer_P3_cmy = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'left',
            onEachFeature: pop_Gm_0,
            style: style_Layer_cmy('P3_rgb')
        })/*.addTo(map)*/;
		var layer_P3 = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'right',
			onEachFeature: pop_Gm_0,
			style: style_Layer('P3_p', lbreaks)
		});/*.addTo(map*/
		var layer_P4_cmy = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'left',
            onEachFeature: pop_Gm_0,
            style: style_Layer_cmy('P4_rgb')
        })/*.addTo(map)*/;
		var layer_P4 = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'right',
			onEachFeature: pop_Gm_0,
			style: style_Layer('P4_p', pslbreaks)
		});/*.addTo(map*/
		var layer_P5_cmy = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'left',
            onEachFeature: pop_Gm_0,
            style: style_Layer_cmy('P5_rgb')
        })/*.addTo(map)*/;
		var layer_P5 = new L.geoJson(json_GminydemDPolygon_0, {
            pane: 'right',
			onEachFeature: pop_Gm_0,
			style: style_Layer('P5_p', konfbreaks)
		});/*.addTo(map*/
		
		layer_P1_cmy.getFeaturesByProperty = function(key, value) {
		  return this.eachLayer(function(layer){
			var t = layer.feature;
			//console.log(p);
			//console.log(p[key]);
			if (t.properties[key] == value) {
			  console.log(t.properties[key]+" - mamy to!!!");
			  return true;
			} else {
			  return false;
			}
		  });
		};
		function createToolSimpl(tdata){
			return '<td class="all">\
				<div class="containers" style="display: flex">\
					<a class="has-tooltip" href="#"><span class="n_gm">'+ (tdata.substring(6, 7) !== "1"? 'gm.' : '')+'&nbsp;'+ '<span class="gmina">'+ json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', tdata)[0].properties.JPT_NAZWA_ +'</span></span>\
						<span class="tooltip-wrappers">\
							<span class="tooltips tooltips1"><h4 style="margin: 4px; padding: 0px; text-align: center;">Location:</h4>TERYT: <span class="kod">' +tdata+'</span><br>'+ json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', tdata.substring(0,4))[0].properties.JPT_NAZWA_+'<br>Constituency no. ' +  json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', tdata)[0].properties.Okr + '\
							</span>\
						</span>\
					</a>\
				</div>\
			</td>';
		}
		function renderRow_tool(rtext,r1,r2,r3,r4,r5,divided){
			var multistringText =  [];
			if (divided){
				multistringText.push('<tr class="divider">');
			}else{
				multistringText.push('<tr>');
			}
			multistringText.push('<td><b>'+rtext+'</b></td>');
			multistringText.push(createToolSimpl(r1));
			multistringText.push(createToolSimpl(r2));
			multistringText.push(createToolSimpl(r3));
			multistringText.push(createToolSimpl(r4));
			multistringText.push(createToolSimpl(r5));
			multistringText.push('</tr>');
			return multistringText.join('');
		}
		console.log(scatterPlotDataArray_xy);
		
		layer_P1.eachLayer(function(layer) {
			var p = layer.feature.properties;
			r_layers[p.JPT_KOD_JE] = layer;
            pointRBackgroundColors.push(colorconvert(layer.options.fillColor,0.8));
            pointRFBackgroundColors.push(layer.options.fillColor);
            pointRBBackgroundColors.push(colorconvert(layer.options.fillColor,0.32));
			pointRBBorderColors.push('rgba(200, 200, 200, 0.5)');
        });
		console.log(layers);
		function pop_Gm_0(feature, layer) {
			layer.bindPopup(layers[feature.properties.JPT_KOD_JE]._popup._content, {maxHeight: 800, autoPanPaddingTopLeft: [80,20],autoPanPaddingBottomRight: [400,20]});
		}
		console.log(layers[current_KOD]);
		var layer_current_cmy = layer_P1_cmy;
		var layer_current = layer_P1;
		console.log(pow_map);
		function style_Powiaty_Simplified_1_0() {
            return {
                pane: 'pane_Powiaty_Simplified_1',
                opacity: 1,
                color: 'rgba(96, 96, 96, 0.8)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 1.08, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(200,162,240,0.0)',
				interactive: false,
            }
        }
        map.createPane('pane_Powiaty_Simplified_1');
        map.getPane('pane_Powiaty_Simplified_1').style.zIndex = 403;
		
		var layer_Powiaty_Simplified_1 = new L.geoJson(json_Powiaty_Simplified_1, {
            pane: 'pane_Powiaty_Simplified_1',
			onEachFeature: list_Powiaty_Simplified_1,
            style: style_Powiaty_Simplified_1_0,
        });
		layer_Powiaty_Simplified_1.addTo(map);
		/*var layer_Powiaty_Simplified_3 = new L.geoJson(json_Powiaty_Simplified_1, {
            attribution: '<a href=""></a>',
            pane: 'pane_Powiaty_Simplified_1',
            style: style_Powiaty_Simplified_1_0,
        });*/
		
		map.createPane('labels');
		map.getPane('labels').style.zIndex = 650;
		map.getPane('labels').style.pointerEvents = 'none';
		map.getPane('labels').style.display = 'none';
		
		function label_Powiaty_Simplified_1_eval_expression(context) {
			// to_string(Sejm_2019_) + '%\n[' + to_string(Sejm_201_1) + '/' + to_string("Palade_29.") + ']'

			var feature = context.feature;
			
			if (feature.properties) {
				return ('<div style="text-align: center;">'+String([feature.properties['JPT_NAZWA_'] ], context) +"</div>");
			} else {
			   return ('<div style="text-align: center;">'+String([feature.properties['JPT_NAZWA_'] ], context) +"</div>");
			}
		}
		
		//console.log(plabels['0201']);
		function style_Powiaty_Simplified_2_0() {
            return {
                pane: 'pane_Powiaty_Simplified_2',
                opacity: 1,
                color: 'rgba(240,240,240,0.9)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 1.44, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(200,162,240,0.0)',
				interactive: false,
            }
        }
        map.createPane('pane_Powiaty_Simplified_2');
        map.getPane('pane_Powiaty_Simplified_2').style.zIndex = 401;
		function list_Powiaty_Simplified_1(feature, layer) {
            powList.push(feature.properties.JPT_KOD_JE+' '+feature.properties.JPT_NAZWA_);
			pow_ats[feature.properties.JPT_KOD_JE] = layer;
        }
		
		var layer_Powiaty_Simplified_2 = new L.geoJson(json_Powiaty_Simplified_1, {
            attribution: '<a href=""></a>',
            pane: 'pane_Powiaty_Simplified_2',
			onEachFeature: function(feat, poly){
				var center;
				poly.on('reclipped', function(ev) {
					//console.log(ev);
					var parts = ev.parts.map(function(ring){
						return ring.map(function(point){
							if ('x' in point) {
								return [point.x, point.y]
							}
						});
					});

					if (!parts.length) {
						// Polygon not visible
						if (center) center.remove();
						return;
					}

					var centerpoint = polylabel(parts, 4);
					var centerLatLng = map.layerPointToLatLng(centerpoint);
					//console.log(feat.properties.JPT_NAZWA_, parts, centerpoint, centerLatLng);

					/*if (center) {center.setLatLng(centerLatLng).addTo(map)} 
					else { center = L.circleMarker(centerLatLng, {color: 'red', radius:10}).addTo(map)}*/
					lab_centers.push(centerLatLng);
				})
			},
            style: style_Powiaty_Simplified_2_0,
        }).addTo(map);
		
		const sortArrayofObjects = (property, order) => {
		  var sortOrder = order === 'asc' ? 1 : -1;
		  //var topIds = [100.0, 0.0];
		  return function (a, b) {
			 var result = (a['properties'][property] < b['properties'][property]) ? -1 : (a['properties'][property] > b['properties'][property]) ? 1 : 0;
			  return result * sortOrder;
			 /* return topIds.includes(b['properties'][property]) - topIds.includes(a['properties'][property]) || b['properties'][property] - a['properties'][property];*/
		  }
		};
		
		function rank_Powiaty(/*feature, */layer) {
			/*var pow_at = json_Gminy_0.getFeaturesByProperty('Powiat', feature.properties['Powiat']);
			pow_at1  = pow_at1.sort(sortArrayofObjects('pis10', 'desc'));*/
			var JE = layer.feature.properties.JPT_KOD_JE;
			var JN = layer.feature.properties.JPT_NAZWA_;
			//console.log(JE);
			var  pow_at = [];
			
			for (i=0; i<20; i++){
				pow_at[i]  = json_GminydemDPolygon_0.getFeaturesByProperty('Powiat', JE);
			}
			for (i=0;i<5;i++){
				for (j=0;j<3;j++){
					pow_at[4*i+j] = pow_at[4*i+j].sort(sortArrayofObjects('P'+(i+1)+'_'+(j+1), 'desc'));
				}
				pow_at[4*i+3] = pow_at[4*i+3].sort(sortArrayofObjects('P'+(i+1)+'_p', 'desc'));
			}
			//var JE = [];
			var kod = [];
			var nazwa = [];
			var udzial = [];
			var kolor = [];
			for (i=0; i<20; i++){
				kod[i]  = new Array(pow_at[i].length);
				nazwa[i]  = new Array(pow_at[i].length);
				udzial[i]  = new Array(pow_at[i].length);
				kolor[i]  = new Array(pow_at[i].length);
			}
			//console.log(pow_at[8][0].properties.JPT_NAZWA_);
			//console.log(pow_at[8][1].properties.JPT_NAZWA_);
			for (i=0; i<20; i++){
				for (t=0; t<pow_at[i].length;t++){
					kod[i][t] = pow_at[i][t].properties.JPT_KOD_JE;
					nazwa[i][t] = pow_at[i][t].properties.JPT_NAZWA_;
					var ind = Math.floor(i/4);
					if ((i%4)==3){
						udzial[i][t] = pow_at[i][t].properties['P'+(ind+1)+'_p'];
						//returnColor('P1_p',pisbreaks)
						//kolor[i][t] = pow_at[i][t].properties['P'+(ind+1)+'_rgb'];
						//kolor[i][t] = returnColor_g('P'+(ind+1)+'_p', allbreaks[ind], pow_at[i][t]);
						//kolor[i][t] = function(){
							for (j=1; j<9; j++){
								if (udzial[i][t] >= allbreaks[ind][j-1] && udzial[i][t] <= allbreaks[ind][j]){
									kolor[i][t] =   fcolors[j-1];
								}
							}	
						//}
					}else{
						udzial[i][t] = pow_at[i][t].properties['P'+(ind+1)+'_'+(i%4+1)];
						kolor[i][t] = pow_at[i][t].properties['P'+(ind+1)+'_rgb'];
					}
				}
			}
			JEkod[JE] = kod;
			JEnazwa[JE] = nazwa;
			JEudzial[JE] = udzial;
			JEkolor[JE] = kolor;
		}
		layer_Powiaty_Simplified_1.eachLayer(function(layer) {
			rank_Powiaty(layer);
        });
		var i = 0;
		//console.log(lab_centers);
		var plabels = {};
		const tool_checked = 'color: rgba(160,32,32,1.0); font-size: 10pt; text-shadow: rgba(255,255,255,0.25) 2px 0px 0px, rgba(255,255,255,0.25) 1.75px 0.966667px 0px, rgba(255,255,255,0.25) 1.08333px 1.68333px 0px, rgba(255,255,255,0.25) 0.133333px 2px 0px, rgba(255,255,255,0.25) -0.833333px 1.81667px 0px, rgba(255,255,255,0.25) -1.6px 1.2px 0px, rgba(255,255,255,0.25) -1.98333px 0.283333px 0px, rgba(255,255,255,0.25) -1.86667px -0.7px 0px, rgba(255,255,255,0.25) -1.3px -1.51667px 0px, rgba(255,255,255,0.25) -0.416667px -1.95px 0px, rgba(255,255,255,0.25) 0.566667px -1.91667px 0px, rgba(255,255,255,0.25) 1.41667px -1.41667px 0px, rgba(255,255,255,0.25) 1.91667px -0.566667px 0px;';
		const tool_unchecked = 'color: #fff; font-size: 8.5pt; text-shadow: rgba(32,32,32,0.75) 2px 0px 0px, rgba(32,32,32,0.75) 1.75px 0.966667px 0px, rgba(32,32,32,0.75) 1.08333px 1.68333px 0px, rgba(32,32,32,0.75) 0.133333px 2px 0px, rgba(32,32,32,0.75) -0.833333px 1.81667px 0px, rgba(32,32,32,0.75) -1.6px 1.2px 0px, rgba(32,32,32,0.75) -1.98333px 0.283333px 0px, rgba(32,32,32,0.75) -1.86667px -0.7px 0px, rgba(32,32,32,0.75) -1.3px -1.51667px 0px, rgba(32,32,32,0.75) -0.416667px -1.95px 0px, rgba(32,32,32,0.75) 0.566667px -1.91667px 0px, rgba(32,32,32,0.75) 1.41667px -1.41667px 0px, rgba(32,32,32,0.75) 1.91667px -0.566667px 0px;';
		var lbl = [];
		layer_Powiaty_Simplified_2.eachLayer(function(layer) {
            //rank_Powiaty(layer);
			var context = {
                feature: layer.feature,
                variables: {}
            };
			//var p = layer.getBounds().getCenter();
			plabels[context.feature.properties.JPT_KOD_JE] = layer;
			
			lbl[i] = layer.bindTooltip((label_Powiaty_Simplified_1_eval_expression(context) !== null?String('<div style="' + tool_unchecked + '">' + label_Powiaty_Simplified_1_eval_expression(context)) + '</div>':''), {pane: 'labels', permanent: true, offset: [0, 0], className: 'css_Powiaty_Simplified_1', direction:"center", opacity:1.0}).openTooltip(lab_centers[i]);
            labels.push(layer);
            totalMarkers += 1;
            layer.added = true;
            addLabel(layer, i);
            i++;
			pow_ats2[context.feature.properties.JPT_KOD_JE] = layer;
        });
		console.log(plabels);
        //bounds_group.addLayer(layer_P3_cmy);
        //map.addLayer(layer_P3_cmy);
		//bounds_group.addLayer(layer_P3);
        //map.addLayer(layer_P3);
        /*var osmGeocoder = new L.Control.OSMGeocoder({
            collapsed: false,
            position: 'topright',
            text: 'Search',
        });*/
		powList.sort();
		function style_Okr_1_0() {
            return {
                pane: 'pane_Okr_1',
                opacity: 1,
                color: 'rgba(255,255,255,0.9)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 2.56, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(200,162,240,0.0)',
				interactive: false,
            }
        }
        map.createPane('pane_Okr_1');
        map.getPane('pane_Okr_1').style.zIndex = 402;
		function pop_Okr(feature, layer) {
            okrs[feature.properties.Okr] = layer;
        }
		function pop_Okr2(feature, layer) {
            okrs2[feature.properties.Okr] = layer;
        }
		var layer_Okr_1 = new L.geoJson(json_Okr, {
            pane: 'pane_Okr_1',
			onEachFeature: pop_Okr2,
            style: style_Okr_1_0,
        })/*.addTo(map)*/;
		
		function style_Okr_2_0() {
            return {
                pane: 'pane_Okr_2',
                opacity: 1,
                color: 'rgba(80,80,80,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 1.6, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(200,162,240,0.0)',
				interactive: false,
            }
        }
        map.createPane('pane_Okr_2');
        map.getPane('pane_Okr_2').style.zIndex = 404;
		var layer_Okr_2 = new L.geoJson(json_Okr, {
            pane: 'pane_Okr_2',
			onEachFeature: pop_Okr,
            style: style_Okr_2_0,
        })/*.addTo(map)*/;
		
		function rank_Okr(/*feature, */layer) {
			/*var pow_at = json_Gminy_0.getFeaturesByProperty('Powiat', feature.properties['Powiat']);
			pow_at1  = pow_at1.sort(sortArrayofObjects('pis10', 'desc'));*/
			var OE = layer.feature.properties.Okr;
			var ON = layer.feature.properties.JPT_NAZWA_;
			//console.log(JE);
			var  okr_s = [];
			
			for (i=0; i<20; i++){
				okr_s[i]  = json_GminydemDPolygon_0.getFeaturesByProperty('Okr', OE);
			}
			for (i=0;i<5;i++){
				for (j=0;j<3;j++){
					okr_s[4*i+j] = okr_s[4*i+j].sort(sortArrayofObjects('P'+(i+1)+'_'+(j+1), 'desc'));
				}
				okr_s[4*i+3] = okr_s[4*i+3].sort(sortArrayofObjects('P'+(i+1)+'_p', 'desc'));
			}
			//var JE = [];
			var kod = [];
			var nazwa = [];
			var udzial = [];
			var kolor = [];
			var powiat = [];
			for (i=0; i<20; i++){
				kod[i]  = new Array(okr_s[i].length);
				nazwa[i]  = new Array(okr_s[i].length);
				udzial[i]  = new Array(okr_s[i].length);
				kolor[i]  = new Array(okr_s[i].length);
				powiat[i]  = new Array(okr_s[i].length);
			}
			//console.log(pow_at[8][0].properties.JPT_NAZWA_);
			//console.log(pow_at[8][1].properties.JPT_NAZWA_);
			for (i=0; i<20; i++){
				for (t=0; t<okr_s[i].length;t++){
					kod[i][t] = okr_s[i][t].properties.JPT_KOD_JE;
					nazwa[i][t] = okr_s[i][t].properties.JPT_NAZWA_;
					powiat[i][t] = okr_s[i][t].properties.Powiat;
					var ind = Math.floor(i/4);
					if ((i%4)==3){
						udzial[i][t] = okr_s[i][t].properties['P'+(ind+1)+'_p'];
						for (j=1; j<9; j++){
							if (udzial[i][t] >= allbreaks[ind][j-1] && udzial[i][t] <= allbreaks[ind][j]){
								kolor[i][t] =   fcolors[j-1];
							}
						}	
					}else{
						udzial[i][t] = okr_s[i][t].properties['P'+(ind+1)+'_'+(i%4+1)];
						kolor[i][t] = okr_s[i][t].properties['P'+(ind+1)+'_rgb'];
					}
				}
			}
			OEkod[OE] = kod;
			OEnazwa[OE] = nazwa;
			OEudzial[OE] = udzial;
			OEkolor[OE] = kolor;
			OEpow[OE] = powiat;
		}
		layer_Okr_1.eachLayer(function(layer) {
			rank_Okr(layer);
        });
		function rank_PL() {
			var  pl_at = [];
			
			for (i=0; i<20; i++){
				pl_at[i] = new Array(json_GminydemDPolygon_0.features.length);
				for (t=0; t< json_GminydemDPolygon_0.features.length; t++){
					pl_at[i][t]  = json_GminydemDPolygon_0.features[t];
				}
			}
			for (i=0;i<5;i++){
				for (j=0;j<3;j++){
					pl_at[4*i+j] = pl_at[4*i+j].sort(sortArrayofObjects('P'+(i+1)+'_'+(j+1), 'desc'));
				}
				pl_at[4*i+3] = pl_at[4*i+3].sort(sortArrayofObjects('P'+(i+1)+'_p', 'desc'));
			}
			//var JE = [];
			var kod = [];
			var nazwa = [];
			var udzial = [];
			var kolor = [];
			var powiat = [];
			var wojewod = [];
			
			for (i=0; i<20; i++){
				kod[i]  = new Array(pl_at[i].length);
				nazwa[i]  = new Array(pl_at[i].length);
				udzial[i]  = new Array(pl_at[i].length);
				kolor[i]  = new Array(pl_at[i].length);
				powiat[i]  = new Array(pl_at[i].length);
				wojewod[i]  = new Array(pl_at[i].length);
			}
			for (i=0; i<20; i++){
				for (t=0; t<pl_at[i].length;t++){
					kod[i][t] = pl_at[i][t].properties.JPT_KOD_JE;
					nazwa[i][t] = pl_at[i][t].properties.JPT_NAZWA_;
					powiat[i][t] = pl_at[i][t].properties.Powiat;
					var ind = Math.floor(i/4);
					if ((i%4)==3){
						udzial[i][t] = pl_at[i][t].properties['P'+(ind+1)+'_p'];
						for (j=1; j<9; j++){
							if (udzial[i][t] >= allbreaks[ind][j-1] && udzial[i][t] <= allbreaks[ind][j]){
								kolor[i][t] =   fcolors[j-1];
							}
						}	
					}else{
						udzial[i][t] = pl_at[i][t].properties['P'+(ind+1)+'_'+(i%4+1)];
						kolor[i][t] = pl_at[i][t].properties['P'+(ind+1)+'_rgb'];
					}
				}
			}
			PLkod = kod;
			PLnazwa = nazwa;
			PLudzial= udzial;
			PLkolor = kolor;
			PLpow = powiat;
			PLwoj = wojewod;
		}
		rank_PL()
		var Powiaty = L.layerGroup([layer_Powiaty_Simplified_1, layer_Powiaty_Simplified_2]);
		var Okry = L.layerGroup([layer_Okr_1, layer_Okr_2 ]);
		
		bounds_group.addLayer(Powiaty);
        map.addLayer(Powiaty);
		bounds_group.addLayer(Okry);
        map.addLayer(Okry);
		
		var mapLayer1 = L.layerGroup([layer_P1_cmy, layer_P1]).addTo(map);
		var mapLayer2 = L.layerGroup([layer_P2_cmy, layer_P2]);
		var mapLayer3 = L.layerGroup([layer_P3_cmy, layer_P3]);
		var mapLayer4 = L.layerGroup([layer_P4_cmy, layer_P4]);
		var mapLayer5 = L.layerGroup([layer_P5_cmy, layer_P5]);
		
		l1 = layer_P1_cmy._leaflet_id;
		l2 = layer_P2_cmy._leaflet_id;
		l3 = layer_P3_cmy._leaflet_id;
		l4 = layer_P4_cmy._leaflet_id;
		l5 = layer_P5_cmy._leaflet_id;
		
		var layer_list = [l1, l2, l3, l4, l5];
		
		var layer_current_tot = mapLayer1;
		
		console.log(l1);
		console.log(l2);
		console.log(l3);
		console.log(l4);
		console.log(l5);

		var mapLayers = {
		'<img src="legend/PiS.png" alt ="PiS"  class="Logo"/> Law and Justice' : mapLayer1,
		'<img src="legend/KO.png" alt="KO"   class="Logo"/> Civic Coalition' : mapLayer2,
		'<img src="legend/Lewica.jpg" alt="Lewica"   class="Logo"/> The Left' : mapLayer3,
		'<img src="legend/PSL.png" alt="PSL"   class="Logo"/> Polish Coalition' : mapLayer4,
		'<img src="legend/Konfederacja.jpg" alt="Konfederacja"   class="Logo"/> Confederation' : mapLayer5
		};
		
		var layerControl0 = new L.control.layers(mapLayers,{'<img src="legend/Granicewojewdztw_2.png" /> Constituency boundaries': Okry,'<img src="legend/Powiaty_Simplified_1.png" /> County boundaries': Powiaty},{collapsed:true, position: 'topright'}).addTo(map);
		var layerControl1 = new L.control.layers(null,null,{collapsed:true}).addTo(map);
		var layerControl2 = new L.control.layers(null,null,{collapsed:false}).addTo(map);
		
		//L.control.sideBySide(layer_P3_cmy, layer_P3).addTo(map);
		var sbs = L.control.sideBySide([layer_P1_cmy, layer_P2_cmy, layer_P3_cmy, layer_P4_cmy, layer_P5_cmy],[layer_P1, layer_P2, layer_P3, layer_P4, layer_P5],{thumbSize:42,padding:0}).addTo(map);
		$('.leaflet-sbs-range').attr('style', 'z-index: 100 !important');
		$('.leaflet-sbs-divider').css("z-index", "100");
		setTimeout(function () {
			$('.leaflet-sbs-range').attr('style', 'z-index: 9990 !important');
			$('.leaflet-sbs-divider').css("z-index", "999");
		}, 1024);
		//console.log(sbs._range.value);
		//console.log(sbs._range);
		//$('.leaflet-sbs:eq(0)').attr('id', 'sbs1');
		//$('.leaflet-sbs-range').css({ "padding-right": "0px", "padding-left": "0px", "z-index": "9999"});
		//$('.leaflet-sbs-divider').css({ "padding-right": "0px", "padding-left": "0px", "z-index": "9999"});
		
		var css_sh_cyan = "rgb(255, 255, 255) 1px 0px 0px, rgb(255, 255, 255) 0.540302px 0.841471px 0px, rgb(255, 255, 255) -0.416147px 0.909297px 0px, rgb(255, 255, 255) -0.989993px 0.14112px 0px, rgb(255, 255, 255) -0.653644px -0.756803px 0px, rgb(255, 255, 255) 0.283662px -0.958924px 0px, rgb(255, 255, 255) 0.96017px -0.279416px 0px, rgba(255, 255, 255, 0.25) 2px 0px 0px, rgba(255, 255, 255, 0.25) 1.75517px 0.958851px 0px, rgba(255, 255, 255, 0.25) 1.0806px 1.68294px 0px, rgba(255, 255, 255, 0.25) 0.141474px 1.99499px 0px, rgba(255, 255, 255, 0.25) -0.832294px 1.81859px 0px, rgba(255, 255, 255, 0.25) -1.60229px 1.19694px 0px, rgba(255, 255, 255, 0.25) -1.97999px 0.28224px 0px, rgba(255, 255, 255, 0.25) -1.87291px -0.701566px 0px, rgba(255, 255, 255, 0.25) -1.30729px -1.51361px 0px, rgba(255, 255, 255, 0.25) -0.421592px -1.95506px 0px, rgba(255, 255, 255, 0.25) 0.567324px -1.91785px 0px, rgba(255, 255, 255, 0.25) 1.41734px -1.41108px 0px, rgba(255, 255, 255, 0.25) 1.92034px -0.558831px 0px, rgba(255, 255, 255, 0.05) 4px 0px 0px, rgba(255, 255, 255, 0.05) 3.87565px 0.989616px 0px, rgba(255, 255, 255, 0.05) 3.51033px 1.9177px 0px, rgba(255, 255, 255, 0.05) 2.92676px 2.72656px 0px, rgba(255, 255, 255, 0.05) 2.16121px 3.36588px 0px, rgba(255, 255, 255, 0.05) 1.26129px 3.79594px 0px, rgba(255, 255, 255, 0.05) 0.282949px 3.98998px 0px, rgba(255, 255, 255, 0.05) -0.712984px 3.93594px 0px, rgba(255, 255, 255, 0.05) -1.66459px 3.63719px 0px, rgba(255, 255, 255, 0.05) -2.51269px 3.11229px 0px, rgba(255, 255, 255, 0.05) -3.20457px 2.39389px 0px, rgba(255, 255, 255, 0.05) -3.69721px 1.52664px 0px, rgba(255, 255, 255, 0.05) -3.95997px 0.56448px 0px, rgba(255, 255, 255, 0.05) -3.97652px -0.432781px 0px, rgba(255, 255, 255, 0.05) -3.74583px -1.40313px 0px, rgba(255, 255, 255, 0.05) -3.28224px -2.28625px 0px, rgba(255, 255, 255, 0.05) -2.61457px -3.02721px 0px, rgba(255, 255, 255, 0.05) -1.78435px -3.57996px 0px, rgba(255, 255, 255, 0.05) -0.843183px -3.91012px 0px, rgba(255, 255, 255, 0.05) 0.150409px -3.99717px 0px, rgba(255, 255, 255, 0.05) 1.13465px -3.8357px 0px, rgba(255, 255, 255, 0.05) 2.04834px -3.43574px 0px, rgba(255, 255, 255, 0.05) 2.83468px -2.82216px 0px, rgba(255, 255, 255, 0.05) 3.44477px -2.03312px 0px, rgba(255, 255, 255, 0.05) 3.84068px -1.11766px 0px, rgba(255, 255, 255, 0.05) 3.9978px -0.132717px 0px";
		
		var css_sh_yell = "0px 0px 16px rgba(32, 32, 32, 0.4), -1px 0px 0px rgba(255, 255, 255, 1.0), -1px 1px 0px rgba(255, 255, 255, 1.0),0px -1px 0px rgba(255, 255, 255, 1.0),0px 1px 0px rgba(255, 255, 255, 1.0),1px -1px 0px rgba(255, 255, 255, 1.0),1px 0px 0px rgba(255, 255, 255, 1.0)";
		
		$('.leaflet-control-layers-toggle:eq( 0 )').html('<div style="background-image: linear-gradient(to right, #c4d3ae 0%, #b8e186 51%, #c4d3ae 100%); border-radius: 8px;box-shadow: 0 0 20px #888; border: 2px solid #fff; text-shadow: -1px 0 #b8e186, 0 1px #b8e186, 1px 0 #b8e186, 0 -1px #b8e186;">Map selection...</div>'); //wybór mapy
		$('.leaflet-control-layers-toggle:eq( 1 )').html('<div style="background-image: linear-gradient(to right, #c4d3ae 0%, #b8e186 51%, #c4d3ae 100%); border-radius: 8px;box-shadow: 0 0 20px #888; border: 2px solid #fff; text-shadow: -1px 0 #b8e186, 0 1px #b8e186, 1px 0 #b8e186, 0 -1px #b8e186;">Summary</div>'); //Podsumowanie
		
		//Poparcie oraz rozkład głosów na listach komitetów ogólnopolskich
		$('.leaflet-control-layers-list:eq( 1 )').html('<div>\
			<h5 style="text-align: center; color: #282828;">Support and distribution of votes on the lists of nationwide committees (<em><span style="color: red;"><a href = "https://sejmsenat2019.pkw.gov.pl/sejmsenat2019/en/wyniki/sejm/pl" target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a>Poland and abroad</span></em>):</h5>\
			<table class = "tabela" id="Podsumowanie_tot">\
				<thead>\
					<tr style="background: none;">\
						<th style="border-right: 2px solid #eee; border-top-left-radius: 32px;"></th>\
						<th><img src="legend/PiS.png" alt ="PiS"  class="Logo"/> </th>\
						<th><img src="legend/KO.png" alt="KO"   class="Logo"/></th>\
						<th><img src="legend/Lewica.jpg" alt="Lewica"   class="Logo"/></th>\
						<th><img src="legend/PSL.png" alt="PSL"   class="Logo"/></th>\
						<th><img src="legend/Konfederacja.jpg" alt="Konfederacja"   class="Logo"/></th>\
					</tr>\
				</thead>\
				<tbody>\
				</tbody>\
			</table></div>');
		//$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('<a href = "https://sejmsenat2019.pkw.gov.pl/sejmsenat2019/en/wyniki/sejm/pl" target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a>Poland i zagranica');
		var _result = [8048635,4892333,2319946,1578523,1256953];
		function renderRow_R(_value){
			var _text = [''];
			for (i=0;i<5;i++){
				_text.push('<td style = "text-align: right;">&#8199;&#8199;'+numberWithSpaces(_value[i])+'</td>');
				//_text.push('<td>'+lengthToBlank(_value[i])+numberWithSpaces(_value[i])+'</td>');
				//_text.push('<td>Na na na</td>');
			}
			return _text.join('');
		}
		
		//2649753	1876267	999488	557244	639041
		var _first = [2649753,1876267,999488,557244,639041];
		function calcShare(_value){
			var _ret = [];
			for (i=0;i<5;i++){
				_ret[i] = (_value[i]/_result[i]*100).toFixed(2);
				//_text.push('<td>'+lengthToBlank(_value[i])+numberWithSpaces(_value[i])+'</td>');
				//_text.push('<td>Na na na</td>');
			}
			return _ret;
		}
		
		var pfirst = calcShare(_first);
		
		
		//1104913	732985	370081	167049	103195
		var _second = [1104913,732985,370081,167049,103195];
		var psecond = calcShare(_second);
		
		
		//4293969	2283081	950377	854230	514717
		var _rest = [4293969,2283081,950377,854230,514717];
		var prest = calcShare(_rest);
		
		function tCountry(){
			$('.leaflet-control-layers-list:eq( 1 ) table:eq(0) tbody').empty();
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append('<tr><td>Number of votes cast for individual committees:</td>\
							'+renderRow_R(_result)+'\
						</tr>');
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Percentage of votes cast for individual committees:",43.59,27.40,12.56,8.55,6.81,700,true));
			
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append('<tr><td>Number of votes cast for the 1st-listed candidates:</td>\
					'+renderRow_R(_first)+'\
				</tr>');
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Share of 1st-listed candidates in the electoral outcome:",pfirst[0],pfirst[1],pfirst[2],pfirst[3],pfirst[4],700,true));
			
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append('<tr><td>Number of votes cast for the 2nd-listed candidates:</td>\
					'+renderRow_R(_second)+'\
				</tr>');
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Share of 2nd-listed candidates in the electoral outcome:",psecond[0],psecond[1],psecond[2],psecond[3],psecond[4],700,true));
			
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Participation in the electoral outcome candidates from the third to the last position on the lists:",prest[0],prest[1],prest[2],prest[3],prest[4],700,false));
			
		}
		
		function cssSumm(){
			for (i=0;i<2;i++){
				$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq("+i+") td").css("color","#88419d");
				$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq("+i+") td").eq(0).css("color","#6e016b");
			}
			for (i=2;i<4;i++){
				$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq("+i+") td").css("color","#e600e6");
				$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq("+i+") td").eq(0).css("color","#b300b3");
				$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq("+(i+2)+") td").css("color","#0D7BC6");
				$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq("+(i+2)+") td").css("text-shadow", css_sh_cyan);
				$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq("+(i+2)+") td").eq(0).css("text-shadow","none");
				$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq("+(i+2)+") td").eq(0).css("color","#0078e3");
			}
			$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq(6) td").css("color","#ccaa00");
			/*$("#tab1 table:eq(0) tbody tr:eq(11) td").css("text-shadow","-1px 0px 0px rgba(112, 112, 112, 1.0), -1px 1px 0px rgba(112, 112, 112, 1.0),0px -1px 0px rgba(112, 112, 112, 1.0),0px 1px 0px rgba(112, 112, 112, 1.0),1px -1px 0px rgba(112, 112, 112, 1.0),1px 0px 0px rgba(112, 112, 112, 1.0), -1px 0px 8px rgba(32, 32, 32, 0.1), -1px 1px 8px rgba(32, 32, 32, 0.1),0px -1px 8px rgba(32, 32, 32, 0.1),0px 1px 8px rgba(32, 32, 32, 0.1),1px -1px 8px rgba(32, 32, 32, 0.1),1px 0px 8px rgba(32, 32, 32, 0.1)");*/
			$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq(6) td").css("text-shadow",css_sh_yell);
			//$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq(7) td").eq(0).css("text-shadow","none");
			$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq(6) td").eq(0).css("color","#cc8800");
			$(".leaflet-control-layers-list:eq( 1 ) tbody tr:eq(6) td").eq(0).css("text-shadow","none");
		}
		
		tCountry();
		cssSumm();
		
		$('.leaflet-control-layers-list:eq( 1 )').append('<p style="margin-bottom: 8px;">Source: Personal elaboration based on National Electoral Commission (Poland) data.</p>');
		
		$('.leaflet-control-layers-list:eq( 2 )').html('<div id="info-pane" class="leaflet-bar chart-container">\
			  <canvas id="chartCanvas"></canvas>\
			</div>');
		$('.leaflet-control-layers-list:eq( 2 )').append('<div id="reg_value"></div>');
		$('.leaflet-control-layers-list:eq( 1 )').css('line-height', '1.0');
		$('.leaflet-control-layers-list:eq( 1 )').css('background-image', 'linear-gradient(to right, #efd 0%, #efd 51%, #efd 100%)');
		$('.leaflet-control-layers:eq( 1 )').css('opacity', '1.0');
		$('.leaflet-control-layers-list:eq( 2 )').css('line-height', '1.0');
		$('.leaflet-control-layers-list:eq( 1 )').css('font-size', '12px');
		$('.leaflet-control-layers-list:eq( 2 )').css('font-size', '12px');
		$('.leaflet-control-layers-list:eq( 2 )').append('<div id="filter"><span style="text-align:center">Municipality filter:</span></div>');
		$('.leaflet-control-layers-list:eq( 2 )').append('<div id="subfilter"></div>');
		$('.leaflet-control-layers-list:eq( 2 )').append('<div id="changer"><span style="text-align:center">"Rotate"/change the plot:</span></div>');
		$('.leaflet-control-layers-list:eq( 2 )').append('<div style="margin:  32px 0px 0px 0px;"></div>');
		$('<div id = "llegend"></div>').insertAfter('.leaflet-control-layers-list:eq( 0 ) .leaflet-control-layers-base');
		$('#llegend').html('<div style="border-radius: 8px;box-shadow: 0 0 20px #888; border: 2px solid #fff; display: inline-block; margin-top: 8px; margin-bottom: 8px; width: 432px; margin-left: auto; margin-right: auto; text-align: center; position: relative;"><div id="ltitle">Support in municipalities for' + name_1 + ':</div><div id="vlegend"></div></div>');
		
		function drawLegend(col, perc){
			var blegend = [];
			var a1 = '<div style="float: left; background-color: ';
			var a2 = '; width: 48px; height: 48px;"><div>';
			var a3 = '</div></div>';
			for (i=1; i<9; i++){
				blegend.push(a1);
				blegend.push(col[i-1]);
				blegend.push(a2);
				blegend.push(perc[i-1].toFixed(2)+'%<br>-<br>'+perc[i].toFixed(2)+'%');
				blegend.push(a3);
			}
			blegend.push('<div style= "clear: both;"></div>');
			return blegend.join('');
		}
		$('#vlegend').html(drawLegend(fcolors, pisbreaks));
		
			
		L.Control.Watermark = L.Control.extend({
			onAdd: function(map) {
				var img = L.DomUtil.create('img');

				img.src = './images/1.png';
				img.style.width = '200px';
				img.style.opacity= '0.9';
				//margin-bottom: -60px;
				img.style.margin= '0px 0px -32px 0px';

				return img;
			},

			onRemove: function(map) {
				// Nothing to do here
			}
		});

		L.control.watermark = function(opts) {
			return new L.Control.Watermark(opts);
		}

		L.control.watermark({ position: 'bottomleft' }).addTo(map);
		//$('.leaflet-bottom:eq(0)').css('filter', 'drop-shadow(5px 5px 10px #ccc)');
		$('.leaflet-bottom:eq(0)').css('filter', 'drop-shadow(1px 1px 0 white) drop-shadow(-1px -1px 0 white) drop-shadow(5px 5px 10px #ccc)');
		
		setTimeout(function () {
			$('#loader').remove();
			//map.addLayer(layer_current);    
			//map.spin(false);
		}, 1000);
		
		var searchControl = new L.Control.Search({
			layer: layer_current_cmy,
			propertyName: 'index',
			marker: false,
			textPlaceholder: 'Enter the name of the municipality...',
			/*filterData: (text, records) => records,*/
			buildTip: function(text, val) {
					  var p = val.layer.feature.properties;
					  var tip = p.JPT_NAZWA_;
					  var vip = p.JPT_KOD_JE;
					  return '<a href="#" class=""><div style="float:left; width: 176px;"><span style=" font-size: 12px;">'+ tip +'</span><span style=" font-size: 11px;"><i>' +(vip.substring(6,7)!=="1"?', gmina':'')+ '</i></span></div><div style="float:left; font-size: 9px; padding-left: 4px;">' + json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', val.layer.feature.properties['JPT_KOD_JE'].substring(0,4))[0].properties.JPT_NAZWA_+'<br>Constituency no. ' +  json_Okr.getFeaturesByProperty('Okr', val.layer.feature.properties['Okr'])[0].properties.Okr + '</div><div style="clear:both;"></div></a>';
			},
			moveToLocation: function(latlng, title, map) {
				console.log("search");
				/*map.fitBounds( latlng.layer.getBounds() , {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
				var zoom = map.getBoundsZoom(latlng.layer.getBounds());
				map.setView(latlng, zoom);*/ // access the zoom
			}
		});
		searchControl.on('search:locationfound', function(e) {
			console.log(layer_current_cmy._leaflet_id);
			console.log(e);
			var kod = e.layer.feature.properties.JPT_KOD_JE;
			current_KOD = kod;
			woj_zoom = false;
			map.closePopup();
			//var pind = kod.substring(2,4)/1+1;
			//console.log(pind);
			
			console.log($select);
			console.log($select.val());
			//if ($select.val()=='Poland'){
				//console.log("Tak - Poland!");
			var wind = e.layer.feature.properties.Okr;
			select_twice = true;
			adm_clicked = true;
			//if (wind!=cind){
				//$('#filter :nth-child('+wind+')').prop('selected', true).change();
				$("#filter option").filter(function() {
							//may want to use $.trim in here
							return $(this).text().substring(6,8) == wind;
						}).prop('selected', true).change();
				console.log('Search found subch');
				$select.change(subch);
			//}
			//$select.change(subch);
			//subb = 1;
			$("#subfilter option").filter(function() {
				  //may want to use $.trim in here
					return $(this).text().substring(0,4) == current_KOD.substring(0,4);
				}).prop('selected', true).change();
			select_twice = false;
			//subb = 0;
			cind=wind;
			polind =0;
			filtered = true;
			console.log('search ' + filtered);
			//map.removeLayer(this._markerSearch)
			setTimeout(function () {
				adm_clicked = false;
				//resetLabels([layer_Powiaty_Simplified_2]);
				//map.getPane('labels').style.display = 'inline-block';
				//map.getPane('labels').style['text-align'] = 'center';
				e.layer.openPopup();
			},0);
			e.layer.setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', /*dashArray: '16, 16',*/  lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
			e.layer.bringToFront();
			
			//map.getPane('labels').style.display = 'inline-block';
			//if(e.layer._popup)
				
			//https://bdot10k.geoportal.gov.pl/#showLayersList&1618582473368
		}).on('search:collapsed', function(e) {

			layer_current_cmy.eachLayer(function(layer) {	//restore feature color
				layer_current_cmy.resetStyle(layer);
			});	
			//resetLabels([layer_Powiaty_Simplified_2]);
		});
		map.addControl( searchControl );
		
		/*var $sbsRange = document.getElementById("sbs1");
		console.log($sbsRange);
		var $mapPane = document.querySelector(".leaflet-map-pane");

		var rxTranslate = /translate(?:3d)?\(([^\)]+)\)/i;

		$mapPane.appendChild($sbsRange);
		
		var observer = new MutationObserver(function(mutations) {
		  if (mutations.some(m => m.attributeName === "style")) {
			// apply an inverse transform
			$sbsRange.style.transform = "translate(" + $mapPane
			  .style
			  .transform
			  .match(rxTranslate)[1]
			  .split(",")
			  .slice(0, 2) 
			  .map(n => parseFloat(n) * -1 + "px") + ")";
		  }
		});

		observer.observe($mapPane, {
		  attributes: true
		});*/
		
		function colorconvert(color, transparency) {
				var r = parseInt(color.substring(1,3),16);
				var g = parseInt(color.substring(3,5),16);
				var b = parseInt(color.substring(5,7),16);
				var a = parseFloat(transparency);
				return ('rgba(' + r + ', ' + g + ', ' + b + ', ' + a + ')');
		}
		
		function rotateData(dfeature, x, y, proc){
				var x1=x;
				var y1=y;
				var z1=100-(x1+y1);
				
				scatterPlotDataArray_xy.push({
					x: x1,
					y: y1,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_xz.push({
					x: x1,
					y: z1,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_yx.push({
					x: y1,
					y: x1,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_yz.push({
					x: y1,
					y: z1,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_zx.push({
					x: z1,
					y: x1,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_zy.push({
					x: z1,
					y: y1,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				//
				scatterPlotDataArray_xp.push({
					x: x1,
					y: proc,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_yp.push({
					x: y1,
					y: proc,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_zp.push({
					x: z1,
					y: proc,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_px.push({
					x: proc,
					y: x1,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_py.push({
					x: proc,
					y: y1,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_pz.push({
					x: proc,
					y: z1,
					//z: dfeature.P1_p,
					featureId: dfeature.JPT_KOD_JE
				});
		}
		
		//var reg_data = chart.data.datasets[1].data
		
		var variables = [
			' 	02 	Lower Silesian Voivodeship',
			' 	04 	Kuyavian-Pomeranian Voivodeship',
			' 	06 	Lublin Voivodeship',
			' 	08 	Lubusz Voivodeship',
			' 	10 	Łódź Voivodeship',
			' 	12 	Lesser Poland Voivodeship',
			' 	14 	Masovian Voivodeship',
			' 	16 	Opole Voivodeship',
			' 	18	Subcarpathian Voivodeship',
			' 	20 	Podlaskie Voivodeship',
			' 	22 	Pomeranian Voivodeship',
			' 	24 	Silesian Voivodeship',
			' 	26 	Holy Cross Voivodeship',
			' 	28 	Warmian-Masurian Voivodeship',
			' 	30 	Greater Poland Voivodeship',
			' 	32 	West Pomeranian Voivodeship'];
			
		var subvariables = [];
		var _axis = [
			'x: '+xb+ ', y: '+yb,
			'x: '+xb+ ', y: '+zb,
			'x: '+yb+ ', y: '+xb,
			'x: '+yb+ ', y: '+zb,
			'x: '+zb+ ', y: '+xb,
			'x: '+zb+ ', y: '+yb,
			//
			'x: '+xb+ ', y: '+pb,
			'x: '+yb+ ', y: '+pb,
			'x: '+zb+ ', y: '+pb,
			'x: '+pb+ ', y: '+xb,
			'x: '+pb+ ', y: '+yb,
			'x: '+pb+ ', y: '+zb];
		
		var initialChartData = {
			datasets: [
			{
			  label: 'Chosen mun.',
			  data: [],
			  pointRadius: 6.4,
			  pointBorderColor: 'rgba(255, 0, 0, 1.0)',
			  pointBorderWidth: 2,
			  pointHoverRadius: 5.6,
			  borderWidth: 2,
			  borderColor: 'red',
			  pointBackgroundColor: pointFBackgroundColors,
			  type: 'scatter',
			  order: 1,
			  //showLine: false
			},{
			  label: 'Mun. filter',
			  //title: 'Wybory Prezydenta RP',
			  // the data values are empty at this moment
			  // and will be updated dynamically below
			  data: [],
			  pointRadius: pointRadiuses,
			  pointBorderColor: pointBorderColors,
			  pointBorderWidth: pointBorderWidths,
			  pointHoverRadius: 5.6,
			  borderWidth: 1,
			  borderColor: 'rgba(96, 96, 96, 0.4)',
			  pointBackgroundColor: pointBackgroundColors,
			  type: 'scatter',
			  order: 3,
			  //showLine: false
			},{
			  label: 'Context',
			  data: [],
			  /*pointBorderColor: pointBBorderColors,*/
			  pointBorderColor: 'rgba(200, 200, 200, 0.5)',
			  pointBackgroundColor: pointBBackgroundColors,
			  borderWidth: 1,
			  borderColor: 'rgba(224, 224, 224, 0.5)',
			  order: 4,
			 // fill:false
			},{
			  type: 'line',
			  label: 'reg',
			  hidden: true,
			  //data: [{x: 0, y: 0},{x: 25.0, y: 25.0},{x: 50.0, y: 50.0},{x: 75.0, y: 75.0},{x: 100.0, y: 100.0}],
			  
			  /*pointBackgroundColor: pointBBackgroundColors,
			  borderWidth: 0,*/
			  borderColor: 'green',
			  backgroundColor: "rgba(218,83,79, .7)",
			  pointRadius: 0,
			  order: 2,
			  fill:false
			}]
		  };

		  var chartOptions = {
			scales: {
			  xAxes: [{
				scaleLabel: {
				  display: true,
				  //o1 = 'Jedynka';
				  //o2 = 'Dwójka';
				  //d_ind = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', chart.data.datasets[tooltipItems.datasetIndex].data[tooltipItems.index].featureId)[0].properties.Okr;
				  labelString: xa
			  },
				ticks: {
				  //beginAtZero: true,
				  min: 0,
				  max: 100,
				  stepSize: 25,
				  callback: function(value) {
					return value + "%";
				  }
				}
			  }],
			  yAxes: [{
				scaleLabel: {
				  display: true,
				  labelString: ya
				},
				ticks: {
				  //beginAtZero: true,
				  min: 0,
				  max: 100,
				  stepSize: 25,
				  callback: function(value) {
					return value + "%";
				  }
				}
			  }]
			},
			title: {
				display: true,
				text: ['Participation of candidates in the electoral outcome', 'and support for' + name_1 + ':']
			},
			legend: {
				display: true,
				/*color: 'rgb(255, 99, 132)',
				labels: [{
					{
					boxWidth: 20,
					color: 'rgb(255, 255, 132)'
					}/*,{
					color: 'rgb(255, 99, 255)'
					},{
					color: 'rgb(99, 99, 132)'
				}]*/
				labels:{
					boxWidth: 9,
					font: {
                        size: 2
                    }
				}
			},
			tooltips: {
			  enabled: false,
			  mode: 'single',
			  //intersect: false,
			  filter: function (tooltipItem) {
				  //console.log(tooltipItem.datasetIndex);
				  //item_set = tooltipItem.datasetIndex;
				  if (tooltipItem.datasetIndex === 0 || tooltipItem.datasetIndex === 1){
					return true;
				  }else{
				    return false;
				  }
			  },
			  custom: function(tooltipModel) {
				try{
				  /* if data & datasets not empty & tooltip available */
				 // var d = chart.data.datasets[1].data[100].featureId;
				  console.log(tooltipModel);
				  //console.log(d);
				  //console.log($('#chartjs-tooltip').text());
				  //console.log($('#tooltip').text());
				 // var tooltipEl = document.getElementById('chartjs-tooltip');
				  
				  var tooltipEl = document.getElementById('tooltip');
				  console.log(tooltipEl);
					// Create element on first render
					if (!tooltipEl) {
						tooltipEl = document.createElement('div');
						tooltipEl.id = 'tooltip';
						tooltipEl.innerHTML = '<table></table>';
						document.body.appendChild(tooltipEl);
					}
				  /*if(tooltipEl.hasOwnProperty('dataPoints') && tooltipEl.dataPoints[0] != 'undefined'){
					if(tooltipModel.dataPoints[0].datasetIndex == 0) // <-- dataset index
						return;
				  }*/
				  /*if (tooltipModel.opacity !== 0 && chart.data.labels.length && chart.data.datasets.length) {
					//get dataPoints index 
					var index = tooltipModel.dataPoints[0].index;
					// get dataPoints datasetIndex 
					var dataSetIndex = tooltipModel.dataPoints[0].datasetIndex;
					// get the current color on index and datasetIndex position 
					var color =  chart.data.datasets[dataSetIndex].backgroundColor[index];
					// set backgroundColor 
					tooltipModel.backgroundColor = color;
				  };*/
				   // Hide if no tooltip
                if (tooltipModel.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                }

                // Set caret Position
                tooltipEl.classList.remove('above', 'below', 'no-transform');
                if (tooltipModel.yAlign) {
                    tooltipEl.classList.add(tooltipModel.yAlign);
                } else {
                    tooltipEl.classList.add('no-transform');
                }

                function getBody(bodyItem) {
                    return bodyItem.lines;
                }

                // Set Text
                if (tooltipModel.body) {
                    var titleLines = tooltipModel.title || [];
					//var titleLines =  ['Nojewo'];
                    var bodyLines = tooltipModel.body.map(getBody);
					/*console.log(titleLines);*/
					console.log(bodyLines);
                    var innerHtml = '<thead>';

                    titleLines.forEach(function(title) {
						console.log(title);
						
                        innerHtml += '<tr><th><span style="background:' + tooltipModel.labelColors[0].backgroundColor + '; border: 1px solid rgba(255,255,255,0.5);width: 8px; height: 8px;display:inline-block;"></span>  <b style=" font-size: 12px; text-align: center;">' + title + '</b></th></tr>';
						
                        //innerHtml += '<tr><th>Klwówek</th></tr>';
                    });
                    innerHtml += '</thead><tbody>';

                    bodyLines.forEach(function(body, i) {
                        /*var colors = tooltipModel.labelColors[i];
						console.log(tooltipModel.labelColors[i]);
                        var style = 'background:' + colors.backgroundColor;
                        style += '; border-color:' + colors.borderColor;
                        style += '; border-width: 2px';
                        var span = '<span style="' + style + '"></span>';*/
                        //innerHtml += '<tr><td>' + /*span +*/ body + 'KK</td></tr>';
                        innerHtml += body ;
                    });
                   //innerHtml += '</tbody>';

                   var tableRoot = tooltipEl.querySelector('table');
                    tableRoot.innerHTML = innerHtml;
					//$('#chartjs-tooltip table').html(innerHtml);
					//console.log($('#chartjs-tooltip').text());
                }

                // `this` will be the overall tooltip
                var position = this._chart.canvas.getBoundingClientRect();
                //var position = chart.canvas.getBoundingClientRect();

                // Display, position, and set styles for font
                tooltipEl.style.opacity = 1;
                tooltipEl.style.position = 'absolute';
                tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
                tooltipEl.style.fontFamily = tooltipModel._bodyFontFamily;
                tooltipEl.style.fontSize = /*tooltipModel.bodyFontSize +*/ '10px';
                tooltipEl.style.fontStyle = tooltipModel._bodyFontStyle;
                tooltipEl.style.zIndex = '9990';
                //tooltipEl.style.padding = tooltipModel.yPadding + 'px ' + tooltipModel.xPadding + 'px';
                tooltipEl.style.padding = '2px 2px';
                tooltipEl.style.pointerEvents = 'none';
				console.log(tooltipEl);
				//$('#info-pane table').html(innerHtml);
				//console.log($('#chartjs-tooltip').html());
				//console.log($('#tooltip').html());
				}catch(e){
				console.log(e);
				/*innerHtml += '<tr><th><span style="background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.5);width: 8px; height: 8px;display:inline-block;"></span>  <b style=" font-size: 12px; text-align: center;">' + title + '</b></th></tr>';*/
				}
				//return innerHtml;
			},
                callbacks: {
                    afterBody: function(tooltipItems, data) { 
						/*console.log(chart.data.datasets[0].data[tooltipItems[0].index]);
						console.log(chart.data.datasets[1].data[tooltipItems[0].index]);
						console.log(chart.data.datasets[2].data[tooltipItems[0].index]);*/
                    },
					title: function(tooltipItems, data) {
						
						//var value = [kodList[tooltipItems[0].index].substring(6, 7) !== "1"? 'gm.' : 'm.'];
						//var value = ['<b style="color: #d8ffff;">'];
						//var value = ['<b style="color: #ffe3ff;">'];
						var value = ['<b style="color: #ffffff; font-weight: 900;">'];
						console.log(tooltipItems);
						//console.log(typeof tooltipItems[0].datasetIndex);
						//console.log(chart.data.datasets[1].data);
						//console.log(chart.data.datasets[2].data);
						function waitForElement(){
							if (typeof tooltipItems[0].datasetIndex !== "undefined" /*&& tooltipItems[0].length > 0 *//*&& (tooltipItems[0].datasetIndex == 0 || tooltipItems[0].datasetIndex == 1)*/){
								//console.log(tooltipItems[0]);
								value.push(chart.data.datasets[tooltipItems[0].datasetIndex].data[tooltipItems[0].index].featureId.substring(6, 7) !== "1"? 'gm.' : '');
								value.push(' '+gminList[tooltipItems[0].index]+'</b>');
							}else{
								console.log("Tooltip widmo");
								setTimeout(waitForElement, 50);
								//return '';
							}
						}
						/* && (tooltipItems[0].datasetIndex == 0 || tooltipItems[0].datasetIndex == 1)*/
						try{
							waitForElement();
						}catch(e){
							console.log("Mamy błąd" + e);
						}
						return value.join('');
					},
					label: function(tooltipItems, data) {
						//console.log(tooltipItems);
						//var c_ind = $select.prop('selectedIndex');
						var c_ind = $("#filter option:selected").text();
						var d_ind;
						var o1, o2;
						d_ind = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', chart.data.datasets[tooltipItems.datasetIndex].data[tooltipItems.index].featureId)[0].properties.Okr;
						/*if (c_ind=="Poland"){
							//o1 = 'Jedynka';
							//o2 = 'Dwójka';
							
							o1 = '1.&nbsp;' + json_Okr.getFeaturesByProperty('Okr', d_ind)[0].properties['P' + layer_nr + '_1_naz'] + ':';
							o2 = '2.&nbsp;' + json_Okr.getFeaturesByProperty('Okr', d_ind)[0].properties['P' + layer_nr + '_2_naz'] + ':';
						}else{*/
							o1 = '1.&nbsp;' + json_Okr.getFeaturesByProperty('Okr', d_ind)[0].properties['P' + layer_nr + '_1_naz'] + ':';
							o2 = '2.&nbsp;' + json_Okr.getFeaturesByProperty('Okr', d_ind)[0].properties['P' + layer_nr + '_2_naz'] + ':';
						//}
						return setTooltipText(o1, o2, 'Other candidates:', '%',tooltipItems, layer_nr);
					}					
                }
			},
			onClick: function(evt) {   
				var element = chart.getElementAtEvent(evt);
				var clickFeatureIds = element.map(function (datum) {
					return chart.data.datasets[1].data[datum._index].featureId;
				});
			  
				
				//customControlLayers();
				layer_current.eachLayer(function (evt, idx) {
				  if (clickFeatureIds.indexOf(evt.feature.properties.JPT_KOD_JE) > -1 && !layers[evt.feature.properties.JPT_KOD_JE].isPopupOpen() && !r_layers[evt.feature.properties.JPT_KOD_JE].isPopupOpen()) {
					function chLayer(mLayer){
							map.removeLayer(layer_current_tot);
							mLayer.addTo(map);
					}
					switch(party){
						case 1:
							chLayer(mapLayer1);
							break;
						case 2:
							chLayer(mapLayer2);
							break;
						case 3:
							chLayer(mapLayer3);
							break;
						case 4:
							chLayer(mapLayer4);
							break;
						case 5:
							chLayer(mapLayer5);
							break;
						default:
					}
					var kod = evt.feature.properties.JPT_KOD_JE;
					setTimeout(function () {
						layers[kod].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', /*dashArray: '16, 16',*/  lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
						setTimeout(function () {
							layers[kod].openPopup();
						},1000);
					},0);
					layer_current.eachLayer(function(layer) {	//restore feature color
						layer_current.resetStyle(layer);
					});
					//map.fitBounds(layers[evt.feature.properties.JPT_KOD_JE].getBounds());
					//map.fitBounds(okrs[evt.feature.properties.JPT_KOD_JE.substring(0,2)].getBounds());
					/*layer_current.eachLayer(function(layer) {	//restore feature color
						layer_current.resetStyle(layer);
					});*/
					layers[evt.feature.properties.JPT_KOD_JE].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
					/*manual_popup = false;
					layers[evt.feature.properties.JPT_KOD_JE].openPopup();
					manual_popup = true;*/
					//map.once('moveend', layers[evt.feature.properties.JPT_KOD_JE].openPopup(), layer_current);
				  } else {
					//console.log('Void');
				  }
				});
				
			},
			maintainAspectRatio: false,
			// turn off animations during chart data updates
			animation: {
			  duration: 0.2
			},
			// see STEP 4 below
			onHover: handleChartHover
			};

		var ctx = document.getElementById('chartCanvas').getContext('2d');
		var chart = new Chart(ctx, {
			type: 'scatter',
			data: initialChartData,
			options: chartOptions
		 });
		/*var originalGetElementAtEvent = chart.getElementAtEvent;
		chart.getElementAtEvent = function () {
		  return originalGetElementAtEvent.apply(this, arguments).filter(function (e) {
			console.log(e._datasetIndex);
			return e._datasetIndex == 0;
		  });
		}*/
		console.log(chart.options);
		scatterPlotDataArray = scatterPlotDataArray_xy;
		/*scatterPlotDataArray10 = scatterPlotDataArray10_xy;
		scatterPlotDataArray15 = scatterPlotDataArray15_xy;
		scatterPlotDataArray20 = scatterPlotDataArray20_xy*/
		
		
		chart.data.datasets[0].data = checkPoint();
		chart.data.datasets[1].data = scatterPlotDataArray;
		function drawReg(u_val){
			var chart_data = u_val.filter(({ x, y }) => {
			  return (
				typeof x === typeof y &&  // filter out one string & one number
				!isNaN(x) &&              // filter out `NaN`
				!isNaN(y) &&
				Math.abs(x) !== Infinity && 
				Math.abs(y) !== Infinity
			  );
			}).map(({ x, y }) => {
			  return [x, y];             // we need a list of [[x1, y1], [x2, y2], ...]
			});
			var reg_data = regression.linear(chart_data);
			console.log(reg_data);
			chart.data.datasets[3].data = reg_data.points.map(([x, y]) => {
				return {x, y};
			});
			$("#reg_value").html(reg_data.string+'&nbsp;&nbsp;&nbsp;&nbsp'+(!isNaN(reg_data.r2)?('<span>r<sup>2</sup>='+reg_data.r2+'</span>'):''));
		}
		drawReg(scatterPlotDataArray);
		//chart.data.datasets[2].data = [];
		//console.log(chart.data.datasets[0]);
		//console.dir(chart.tooltipModel.positioners);
		console.log(chart);
					
		chart.update();
		//console.log(scatterPlotDataArray);
		//console.log(layers);
		//console.log(chart.data.datasets[1].data[0]);
		
		  function handleChartHover (e) {
			var chartHoverData = chart.getElementsAtEvent(e);
			//console.log(chartHoverData);
			if (!chartHoverData.length) {
			  // if there were no data elements found when hovering over the chart,
			  // reset any previous styling overrides and return
			  /*layer_current.eachLayer(function (e) {
			  });*/

			  return;
			}

			// otherwise, bring attention to the features on the map
			// that are currently being hovered over in the chart
			var hoverFeatureIds = chartHoverData.map(function (datum) {
			  return chart.data.datasets[1].data[datum._index].featureId;
			});
			//console.log(hoverFeatureIds);
			/*layer_Gminy_0.eachLayer(function (e, idx) {
			  if (hoverFeatureIds.indexOf(e.feature.properties.JPT_KOD_JE) > -1) {
				//layers[e.feature.properties.JPT_KOD_JE].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
				//layers[e.feature.properties.JPT_KOD_JE].openPopup();
				//console.log('Something');
				//layers[e.feature.properties.JPT_KOD_JE].setZIndexOffset(10000);
			  } else {
				//console.log('Void');
				//e.setStyle({color: 'rgba(255,255,255,0.0)', weight: '8', lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,255,0,0.1)',});
			  }
			});*/
		  }
		/*for (i=0; i<scatterPlotDataArray_xy.length; i++){
			var el = scatterPlotDataArray_xy[i];
			var x = el.x;
			var y = el.y;
			el.x = 100-(x+y);
			scatterPlotDataArray_zy.push(el);
			el.x = x;
		}*/
		//var ranges = {};
		//console.log(powList);
		function fitChart(){
			var vminX = arrayXMin(chart.data.datasets[1].data);
			var vminY = arrayYMin(chart.data.datasets[1].data);
			var vmaxX = arrayXMax(chart.data.datasets[1].data);
			var vmaxY = arrayYMax(chart.data.datasets[1].data);
			console.log("fitChart: "+vmaxX);
			console.log("fitChart: "+vmaxY);
			var vdiffX = vmaxX - vminX;
			var vdiffY = vmaxY - vminY;
			if (vdiffX>60){
				vminX=Math.floor(vminX/20)*20;
				vmaxX=Math.ceil(vmaxX/20)*20;
				//stepSize: 5
				chart.options.scales.xAxes[0].ticks.stepSize= 20;
			}else if (vdiffX>30){
				vminX=Math.floor(vminX/10)*10;
				vmaxX=Math.ceil(vmaxX/10)*10;
				//stepSize: 5
				chart.options.scales.xAxes[0].ticks.stepSize= 10;
			}else if (vdiffX>15){
				vminX=Math.floor(vminX/5)*5;
				vmaxX=Math.ceil(vmaxX/5)*5;
				//stepSize: 5
				chart.options.scales.xAxes[0].ticks.stepSize= 5;
			}else{
				vminX=Math.floor(vminX/2)*2;
				vmaxX=Math.ceil(vmaxX/2)*2;
				chart.options.scales.xAxes[0].ticks.stepSize= 2;
			}
			if (vdiffY>60){
				vminY=Math.floor(vminY/20)*20;
				vmaxY=Math.ceil(vmaxY/20)*20;
				//stepSize: 5
				chart.options.scales.yAxes[0].ticks.stepSize= 20;
			}else if (vdiffY>30){
				vminY=Math.floor(vminY/10)*10;
				vmaxY=Math.ceil(vmaxY/10)*10;
				//stepSize: 5
				chart.options.scales.yAxes[0].ticks.stepSize= 10;
			}else if (vdiffY>15){
				vminY=Math.floor(vminY/5)*5;
				vmaxY=Math.ceil(vmaxY/5)*5;
				chart.options.scales.yAxes[0].ticks.stepSize= 5;
			}else{
				vminY=Math.floor(vminY/2)*2;
				vmaxY=Math.ceil(vmaxY/2)*2;
				chart.options.scales.yAxes[0].ticks.stepSize= 2;
			}
			//chart.options.scales.xAxes[0].ticks={};
			//chart.options.scales.yAxes[0].ticks={};
			chart.options.scales.xAxes[0].ticks.beginAtZero= false;
			chart.options.scales.yAxes[0].ticks.beginAtZero= false;
			chart.options.scales.xAxes[0].ticks.min= vminX;
			chart.options.scales.yAxes[0].ticks.min= vminY;
			chart.options.scales.xAxes[0].ticks.max= vmaxX;
			chart.options.scales.yAxes[0].ticks.max= vmaxY;
			chart.options.scales.xAxes[0].ticks.callback = function(value) {
				return value + "%";
			}
			chart.options.scales.yAxes[0].ticks.callback = function(value) {
				return value + "%";
			}
		}
		
		function setChart(bzero = true, _min = 0, _max = 100, _step = 25){
			chart.options.scales.xAxes[0].ticks = {
			  beginAtZero: bzero,
			  min: _min,
			  max: _max,
			  stepSize: _step
			};
			chart.options.scales.yAxes[0].ticks = {
			  beginAtZero: bzero,
			  min: _min,
			  max: _max,
			  stepSize: _step
			};
			chart.options.scales.xAxes[0].ticks.callback = function(value) {
				return value + "%";
			}
			chart.options.scales.yAxes[0].ticks.callback = function(value) {
				return value + "%";
			}
		}
		
		var filtered = false;
		function checkPoint(){
			var checkedPlotDataArray =[];
			//console.log(woj);
			for (i=0; i<scatterPlotDataArray.length; i++){
				var el = scatterPlotDataArray[i];
				//el.x = 100-(el.x+el.y);
				if (el.featureId==current_KOD){
					checkedPlotDataArray.push(el);
				}else{
					checkedPlotDataArray.push(0);
				}
			}
			return checkedPlotDataArray;	
		}
		function filterChart(){
			var filteredPlotDataArray =[];
			var okr_= $select.val();
			//console.log(woj);
			/*for (i=0; i<scatterPlotDataArray.length; i++){
				var el = scatterPlotDataArray[i];
				//el.x = 100-(el.x+el.y);
				
				if (layers[i].features.properties.Okr==okr_){
					filteredPlotDataArray.push(el);
				}else{
					filteredPlotDataArray.push(0);
				}
			}*/
			var i = 0;
			layer_current.eachLayer(function(layer) {
				var el = scatterPlotDataArray[i];
				//console.log(layer);
				if (layer.feature.properties.Okr==okr_){
					filteredPlotDataArray.push(el);
				}else{
					filteredPlotDataArray.push(0);
				}
				i++;
			});
			
			return filteredPlotDataArray;	
		}
		function subfilterChart(){
			var subfilteredPlotDataArray =[];
				var pow_ = $subselect.val().substring(0,4);
				//console.log(woj);
				for (i=0; i<scatterPlotDataArray.length; i++){
					var el = scatterPlotDataArray[i];
					//el.x = 100-(el.x+el.y);
					if (el.featureId.substring(0,4)==pow_){
						subfilteredPlotDataArray.push(el);
					}else{
						subfilteredPlotDataArray.push(0);
					}
				}
				return subfilteredPlotDataArray;
				
		}
		//var filteredListPowArray =[];
		function filterListPow(){
			var filteredListPowArray =[];
			//filteredListPowArray.length = 0;
				var okr_ = $select.val();
				console.log("Filtrowanie listy powiatów z okr_"+okr_);
				for (i=0; i<powList.length; i++){
					var el = pow_map.get(powList[i].substring(0,4));
					//el.x = 100-(el.x+el.y);
					if (okr_==el){
						filteredListPowArray.push(powList[i]);
					}/*else{
						filteredListPowArray.push(0);
					}*/
				}
				//console.log(filteredListPowArray);
				return filteredListPowArray;
				
		}
		
		function objProp(obj,par,prop){
			var okr_ = $select.val();
			var pow_ = $subselect.val();
			var elem = (obj==json_Okr)?Number(okr_):pow_.substring(0,4);
			return obj.getFeaturesByProperty(par, elem)[0].properties[prop];
		}
		
		function admSumm(obj,par){
			
			$('.leaflet-control-layers-list:eq( 1 ) tbody').empty();
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append('<tr><td>Number of votes cast for individual committees:</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P1_g"))+numberWithSpaces(objProp(obj, par, "P1_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P2_g"))+numberWithSpaces(objProp(obj, par, "P2_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P3_g"))+numberWithSpaces(objProp(obj, par, "P3_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P4_g"))+numberWithSpaces(objProp(obj, par, "P4_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P5_g"))+numberWithSpaces(objProp(obj, par, "P5_g"))+'</td>\
			</tr>');
			
			var perc_arr = [];
			for (i=1; i<6; i++){
				perc_arr.push(objProp(obj, par, "P"+i+"_g")/objProp(obj, par, "LG")*100);
			}
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Percentage of votes cast for individual committees:",perc_arr[0],perc_arr[1],perc_arr[2],perc_arr[3],perc_arr[4],700,true));
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append('<tr><td>Number of votes cast for the 1st-listed candidate:</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P1_1_g"))+numberWithSpaces(objProp(obj, par, "P1_1_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P2_1_g"))+numberWithSpaces(objProp(obj, par, "P2_1_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P3_1_g"))+numberWithSpaces(objProp(obj, par, "P3_1_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P4_1_g"))+numberWithSpaces(objProp(obj, par, "P4_1_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P5_1_g"))+numberWithSpaces(objProp(obj, par, "P5_1_g"))+'</td>\
			</tr>');
			//console.log(okr_);
			//console.log(json_Okr.getFeaturesByProperty('Okr', Number(okr_))[0].properties["P1_1_naz"]);
			perc_arr = [];
			for (i=1; i<6; i++){
				perc_arr.push(objProp(obj, par, "P"+i+"_1_g")/objProp(obj, par, "P"+i+"_g")*100);
			}
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Share of the 1st-listed candidate in the result of the list:",perc_arr[0],perc_arr[1],perc_arr[2],perc_arr[3],perc_arr[4],700,true));
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append('<tr><td>Number of votes cast for the 2nd-listed candidate:</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P1_2_g"))+numberWithSpaces(objProp(obj, par, "P1_2_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P2_2_g"))+numberWithSpaces(objProp(obj, par, "P2_2_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P3_2_g"))+numberWithSpaces(objProp(obj, par, "P3_2_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P4_2_g"))+numberWithSpaces(objProp(obj, par, "P4_2_g"))+'</td>\
				<td>'+lengthToBlank(objProp(obj, par, "P5_2_g"))+numberWithSpaces(objProp(obj, par, "P5_2_g"))+'</td>\
			</tr>');
			perc_arr = [];
			for (i=1; i<6; i++){
				perc_arr.push(objProp(obj, par, "P"+i+"_2_g")/objProp(obj, par, "P"+i+"_g")*100);
			}
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Share of the 2nd-listed candidate in the result of the list:",perc_arr[0],perc_arr[1],perc_arr[2],perc_arr[3],perc_arr[4],700,true));
			perc_arr = [];
			for (i=1; i<6; i++){
				perc_arr.push((objProp(obj, par, "P"+i+"_g")-(objProp(obj, par, "P"+i+"_1_g")+objProp(obj, par, "P"+i+"_2_g")))/objProp(obj, par, "P"+i+"_g")*100);
			}
			$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Participation in the electoral outcome candidates from the third to the last position on the list:",perc_arr[0],perc_arr[1],perc_arr[2],perc_arr[3],perc_arr[4],700,false));
		}
		
		var $select = $('<select></select>')
			.appendTo($('#filter'))
			.on('change', function() {
				if (!layer_change_first_clicked&&!subselect_change_first_clicked&&!popup_open_first_clicked&&!popup_close_first_clicked){
					select_change_first_clicked = true;
				}else{
					select_change_first_clicked = false;
				}
				console.log("select_change_first_clicked: " + select_change_first_clicked);
				//////alert("select_change_first_clicked: " + select_change_first_clicked);
				//map.closePopup();
				//Czyścimy listę powiatów w subselect oraz listę gmin na wykresie
				var filteredPlotDataArray =[];
				var filteredListPowArray = [];
				console.log('Lista okręgów');
				console.log('Filter: ' + filtered);
				console.log($(this).val());
				$subselect.empty();
				
				czoom = map.getZoom();
				/*layer_Okr_1.eachLayer(function(layer) {	//restore feature color
					layer_Okr_1.resetStyle(layer);
				});*/
				layer_Okr_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*2.56});
				layer_Okr_2.setStyle({color: 'rgba(80,80,80,1.0)'/*, fillColor: 'rgba(255,224,224,0.0)'*/, fillPattern: patt_blank, weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*1.6});
				layer_Powiaty_Simplified_1.setStyle({color: 'rgba(96,96,96,0.8)'/*, fillColor: 'rgba(255,224,224,0.0)'*/, fillPattern: patt_blank, weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*1.08});
				layer_Powiaty_Simplified_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*1.44});
				//map.getPane('pane_Granicewojewdztw_1').style.zIndex = 402;
				ptemp = plabels[pow_last]._tooltip._container.innerHTML.replace(tool_checked, tool_unchecked);
				plabels[pow_last]._tooltip._container.innerHTML = ptemp;
				//if (isPopupOpen()){
				
				//}
				console.log($(this).val());
				//if (select_change_first_clicked){
					layer_code = layer_current._leaflet_id;
				//}
				//changerToChart($changer);
				chart.data.datasets[0].data = checkPoint();
				if (!block_cl_pop/*&&popup_open_first_clicked*/){
					block_centering = true;
					map.closePopup();
					setTimeout(function () {
						block_centering = false;
					}, 0);
					//block_centering = false;
					//popup_open_first_clicked = false;
					//popup_close_first_clicked = true;
				}
				if ($(this).val()=='Poland'){
					chart.data.datasets[1].data = scatterPlotDataArray;
					drawReg(scatterPlotDataArray);
					//chart.data.datasets[0].data = [];
					console.log($select.val());
					console.log($subselect.val());
					//chart.data.datasets[2].data = [];
					to_subsel = true;
					$subselect.empty();
					filtered = false;
					console.log('select changed ' + filtered);
					selected = false;
					already_selected = true;
					if (!polygon_clicked&&!item_clicked&&!adm_clicked){
						sel_clicked = true;
					}else{
						sel_clicked = false;
					}
					/*if (item_clicked){
						//stały zoom
						manually_zoomed = true;
					}else */if (adm_clicked||sel_clicked){
						manually_zoomed = false;
						/*if (!temp_zoomed){
							//stały zoom
							manually_zoomed = false;
						}else{
							//dopasowanie poligonu do okna
							manually_zoomed = true;
						//}*/
					}else{
						//manually_zoomed = true;
						manually_zoomed = temp_zoomed;
						//auto_zoom = false;
					}
					temp_zoomed = manually_zoomed;
					if (!manually_zoomed){
						programmaticMapManipulation = true;
						map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						setTimeout(function () {
							programmaticMapManipulation = false;
						},0);
						
					}else{
						var cbounds = layers[current_KOD].getBounds();
						map.setMaxZoom(map.getZoom());
						map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						map.setMaxZoom(10);
					}
					//already_selected = false;
					
					setTimeout(function () {
						manually_zoomed = temp_zoomed;
						/*setTimeout(function () {
							zoomToLabels();
						},200);*/
						if (!manually_zoomed){
							map.getPane('labels').style['text-align'] = 'center';
							map.getPane('labels').style.display = 'inline-block';
						}
						//map.spin(false);
						to_subsel = false;
					},0);
					$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('<a href = "https://sejmsenat2019.pkw.gov.pl/sejmsenat2019/en/wyniki/sejm/pl" target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a>Poland i zagranica');
					tCountry();
					cssSumm();
					//alert("$Select manually_zoomed: " + manually_zoomed);
					//if (!popup_open_first_clicked&&!popup_close_first_clicked){
						console.log("sel kraj");
						//$(document).ready(function (){
						
						//manually_zoomed = true;
						//});
						/*$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('Poland i zagranica');
						$('.leaflet-control-layers-list:eq( 1 ) table:eq(0) tbody').empty();
						$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PiS:',25.68,28.1,34.49,false));
						$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PO:',28.97,26.42,33.1,false));
						$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Absencja i głosy nieważne:',45.34,45.48,32.41,false));*/
						//map.getPane('labels').style.display = 'none';
						//meanTable();
		
					//}
					if (layer_code==l1||layer_code==l2||layer_code==l3||layer_code==l4||layer_code==l5/*||year!=0*/){
						setChart();
						console.log("Chart setted");
					}else{
						console.log("Chart fitted");
						fitChart();
					}
					//chosenCol('Podsumowanie_mean');
				}else /*if ($subselect.val()==' ')*/{
					var okr_= $(this).val();
					temp_zoomed = manually_zoomed;
					if (!select_twice/*&&!manual_popup*/){
						if (!polygon_clicked&&!item_clicked&&!adm_clicked){
							sel_clicked = true;
						}else{
							sel_clicked = false;
						}
						/*if (item_clicked){
							//blokuj zoom
							manually_zoomed = true;
						}else */if (adm_clicked||sel_clicked){
							//dopasuj zoom
							manually_zoomed = false;
							/*if (!temp_zoomed){
								//stały zoom
								manually_zoomed = false;
							}else{
								//dopasowanie poligonu do okna
								manually_zoomed = true;
							//}*/
						}else{
							manually_zoomed = temp_zoomed;
							//auto_zoom = false;
						}
						temp_zoomed = manually_zoomed;
						already_selected = true;
						if (!manually_zoomed){
							programmaticMapManipulation = true;
							//alert("Select zoom!");
							map.fitBounds(okrs[okr_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							setTimeout(function () {
								programmaticMapManipulation = false;
							},0);
						}else{
							var cbounds = layers[current_KOD].getBounds();
							map.setMaxZoom(map.getZoom());
							map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							map.setMaxZoom(10);
						}
						selected = true;
						if (json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', current_KOD)[0].properties.Okr!=okr_){
							chart.data.datasets[0].data = [];
							chart.data.datasets[0].data.push(0);
						}
						setTimeout(function () {
							manually_zoomed = temp_zoomed;
							//setTimeout(function () {
								//alert("Label after zoom! " + map.getZoom());
								//zoomToLabels();
							//},1000);
							//resetLabels();
							if (!manually_zoomed){
								map.getPane('labels').style['text-align'] = 'center';
								map.getPane('labels').style.display = 'inline-block';
							}
							//map.spin(false);
						},0);
						
					}
					//alert("$Select manually_zoomed: " + manually_zoomed);
					//already_selected = false;
					
						
							//manually_zoomed = true;
							/*if (czoom<8){
								map.getPane('labels').style.display = 'none';
							}*/
							/*map.getPane('labels').style.display = 'inline-block';
							map.getPane('labels').style['text-align'] = 'center';*/
						//}
					//}
					/*function okrProp(prop){
						return json_Okr.getFeaturesByProperty('Okr', Number(okr_))[0].properties[prop];
					}
					$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('okręg wyborczy nr&nbsp;'+okr_);
					$('.leaflet-control-layers-list:eq( 1 ) tbody').empty();
					$(".leaflet-control-layers-list:eq( 1 ) tbody").append('<tr><td>Liczba głosów oddanych na&nbsp;poszczególne komitety:</td>\
						<td>'+lengthToBlank(okrProp("P1_g"))+numberWithSpaces(okrProp("P1_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P2_g"))+numberWithSpaces(okrProp("P2_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P3_g"))+numberWithSpaces(okrProp("P3_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P4_g"))+numberWithSpaces(okrProp("P4_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P5_g"))+numberWithSpaces(okrProp("P5_g"))+'</td>\
					</tr>');
					
					var perc_arr = [];
					for (i=1; i<6; i++){
						perc_arr.push(okrProp("P"+i+"_g")/okrProp("LG")*100);
					}
					$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Odsetek głosów oddanych na&nbsp;poszczególne komitety:",perc_arr[0],perc_arr[1],perc_arr[2],perc_arr[3],perc_arr[4],700,true));
					$(".leaflet-control-layers-list:eq( 1 ) tbody").append('<tr><td>Liczba głosów oddanych na&nbsp;jedynkę:</td>\
						<td>'+lengthToBlank(okrProp("P1_1_g"))+numberWithSpaces(okrProp("P1_1_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P2_1_g"))+numberWithSpaces(okrProp("P2_1_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P3_1_g"))+numberWithSpaces(okrProp("P3_1_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P4_1_g"))+numberWithSpaces(okrProp("P4_1_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P5_1_g"))+numberWithSpaces(okrProp("P5_1_g"))+'</td>\
					</tr>');
					console.log(okr_);
					console.log(json_Okr.getFeaturesByProperty('Okr', Number(okr_))[0].properties["P1_1_naz"]);
					perc_arr = [];
					for (i=1; i<6; i++){
						perc_arr.push(okrProp("P"+i+"_1_g")/okrProp("P"+i+"_g")*100);
					}
					$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Udział jedynki w&nbsp;wyniku listy:",perc_arr[0],perc_arr[1],perc_arr[2],perc_arr[3],perc_arr[4],700,true));
					$(".leaflet-control-layers-list:eq( 1 ) tbody").append('<tr><td>Liczba głosów oddanych na&nbsp;dwójkę:</td>\
						<td>'+lengthToBlank(okrProp("P1_2_g"))+numberWithSpaces(okrProp("P1_2_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P2_2_g"))+numberWithSpaces(okrProp("P2_2_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P3_2_g"))+numberWithSpaces(okrProp("P3_2_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P4_2_g"))+numberWithSpaces(okrProp("P4_2_g"))+'</td>\
						<td>'+lengthToBlank(okrProp("P5_2_g"))+numberWithSpaces(okrProp("P5_2_g"))+'</td>\
					</tr>');
					perc_arr = [];
					for (i=1; i<6; i++){
						perc_arr.push(okrProp("P"+i+"_2_g")/okrProp("P"+i+"_g")*100);
					}
					$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Udział dwójki w&nbsp;wyniku listy:",perc_arr[0],perc_arr[1],perc_arr[2],perc_arr[3],perc_arr[4],700,true));
					perc_arr = [];
					for (i=1; i<6; i++){
						perc_arr.push((okrProp("P"+i+"_g")-(okrProp("P"+i+"_1_g")+okrProp("P"+i+"_2_g")))/okrProp("P"+i+"_g")*100);
					}
					$(".leaflet-control-layers-list:eq( 1 ) tbody").append(renderRow("Udział w&nbsp;wyniku listy kandydatów z&nbsp;miejsc od&nbsp;trzeciego do&nbsp;ostatniego:",perc_arr[0],perc_arr[1],perc_arr[2],perc_arr[3],perc_arr[4],700,false));*/
					$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('<a href = "https://sejmsenat2019.pkw.gov.pl/sejmsenat2019/en/wyniki/sejm/okr/'+okr_+'" target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a>Constituency no.&nbsp;'+okr_);
					//$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('okręg wyborczy nr&nbsp;'+okr_);
					admSumm(json_Okr,'Okr');
					cssSumm();
					
					/*$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PiS:',json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS10"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["Okr"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PO:',json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PO10"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PO15"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PO20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Absencja i głosy nieważne:',json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS10"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS15"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) h5:eq(1)').remove();
					$('.leaflet-control-layers-list:eq( 1 ) table:eq(1)').remove();*/
					woj_zoom = true;
					if (json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', current_KOD)[0].properties.Okr!=okr_){
						chart.data.datasets[0].data = [];
					}
					/*map.getPane('labels').style.display = 'inline-block';
					map.getPane('labels').style['text-align'] = 'center';*/
					//console.log(woj);
					filteredPlotDataArray = [];
					var okr_= $select.val();
					//console.log(woj);
					/*for (i=0; i<scatterPlotDataArray.length; i++){
						var el = scatterPlotDataArray[i];
						//el.x = 100-(el.x+el.y);
						
						if (layers[i].features.properties.Okr==okr_){
							filteredPlotDataArray.push(el);
						}else{
							filteredPlotDataArray.push(0);
						}
					}*/
					var i = 0;
					layer_current.eachLayer(function(layer) {
						var el = scatterPlotDataArray[i];
						//console.log(layer);
						if (layer.feature.properties.Okr==okr_){
							filteredPlotDataArray.push(el);
						}else{
							filteredPlotDataArray.push(0);
						}
						i++;
					});
			
					console.log(filteredPlotDataArray);
					/*filteredListPowArray = filterListPow();
					for (var i = 0; i < filteredListPowArray.length+1; i++) {
						//ranges[variables[i]] = { min: Infinity, max: -Infinity };
						// Simultaneously, build the UI for selecting different
						// ranges
						if (i==0){
							$('<option></option>')
							.text(' ')
							.attr('value', 'none')
							.appendTo($subselect);
						}else{
							$('<option></option>')
							.text(filteredListPowArray[i-1])
							.attr('value', filteredListPowArray[i-1])
							.appendTo($subselect);
						}
					}*/
					//filterListPow();
					//filterChart();
					//console.log('Wybrane okr_' + filteredPlotDataArray);
					chart.data.datasets[1].data = filteredPlotDataArray;
					drawReg(filteredPlotDataArray);
					//chart.data.datasets[1].data = filterChart;
					//chart.data.datasets[0].data = [];
					//chart.data.datasets[2].data = [];
					fitChart();
					filtered = true;
					//alert("Select changed - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\nauto_zoom: "+ auto_zoom + "\nsel_clicked: " + sel_clicked);
					sel_clicked = false;
					console.log('select changed ' + filtered);
					//filteredPlotDataArray =[];
					czoom = map.getZoom();
					okrs[okr_].setStyle({color: 'rgba(160,0,0,1.0)', fillPattern: stripes, weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*2.24});
					okrs2[okr_].setStyle({weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*3.36});
					okrs[okr_].bringToFront();
					console.log('Zmiana stylu woj');
				}
				//already_selected = false;
				
				//chosenCol('Podsumowanie_tot');
				//manually_zoomed = auto_zoom;
				/*for (i=0; i<filteredPlotDataArray.length; i++) {
					var fl = filteredPlotDataArray[i];
					fl.x = 100-(fl.x+fl.y);
				}*/
				//////alert('select_twice: '+select_twice);
				//szoom = map.getZoom();
				//console.log("czoom: "+czoom+" szoom: "+szoom);
				if (!select_twice){
				$(document).ready(function (){
					//zoomToLabels();
					chart.update();
				});
				}
				console.log('Block popup close: '+block_cl_pop);
				
				//select_change_first_clicked = false;
			});
		var n_woj = 0;
		var br_woj =[0,3,5,7,8,11,15,20,21,23,24,26,32,33,35,39];
		for (var i = 0; i < 42; i++) {
			//ranges[variables[i]] = { min: Infinity, max: -Infinity };
			// Simultaneously, build the UI for selecting different
			// ranges
			if (i==0){
				$('<option></option>')
					.text('Poland')
					.attr('value', 'Poland')
					.appendTo($select);
				$('<optgroup label="Constituency number"> id ="opt_main"').appendTo($select);//Nr okręgu wyborczego
				$('<option disabled></option>')
					.text(String.fromCharCode(8194)+String.fromCharCode(8194)+variables[n_woj])
					.attr('value', variables[n_woj])
					.appendTo($select);
				n_woj++;
				//$('<optgroup label='+variables[0]+'>').appendTo("#opt_main");
			}else{
				$('<option></option>')
					.text(String.fromCharCode(8194)+String.fromCharCode(8194)+String.fromCharCode(8194)+String.fromCharCode(8194)+String.fromCharCode(8194)+String.fromCharCode(8194)+((i<10)?String.fromCharCode(8194):'')+i)
					.attr('value', i)
					.appendTo($select);
			}
			//if (i==3) $('</optgroup>').appendTo($select);
			if (i==br_woj[n_woj]) {
				$('<option disabled></option>')
					.text(String.fromCharCode(8194)+String.fromCharCode(8194)+variables[n_woj])
					.attr('value', variables[n_woj])
					.appendTo($select);
				n_woj++;
			}
			if (i==41) $('</optgroup>').appendTo($select);
		}
		var filteredPlotDataArray =[];
		//map.createPane('subsel');
		var $subselect = $('<select></select>')
			.appendTo($('#subfilter'))
			.prop('disabled', true)
			.on('change', function() {
				filteredPlotDataArray.length = 0;
				console.log('"'+$(this).val()+'"');
				czoom = map.getZoom();
				//////alert("Subselect: " + subselect_change_first_clicked);
				layer_Okr_2.setStyle({color: 'rgba(80,80,80,1.0)'/*, fillColor: 'rgba(255,224,224,0.0)'*/, fillPattern: patt_blank, weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*1.6});
				layer_Powiaty_Simplified_1.setStyle({color: 'rgba(96,96,96,0.8)'/*, fillColor: 'rgba(255,224,224,0.0)'*/, fillPattern: patt_blank, weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*1.08});
				layer_Powiaty_Simplified_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*1.44});
				layer_Okr_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*2.56});
				chart.data.datasets[0].data = checkPoint();
				temp_zoomed = auto_zoom;
				
				if (!block_cl_pop/*&&popup_open_first_clicked*/){
					block_centering = true;
					map.closePopup();
					setTimeout(function () {
						block_centering = false;
					}, 0);
					//popup_open_first_clicked = false;
					//popup_close_first_clicked = true;
				}
				ptemp = plabels[pow_last]._tooltip._container.innerHTML.replace(tool_checked, tool_unchecked);
				plabels[pow_last]._tooltip._container.innerHTML = ptemp;
				console.log(ptemp);
				already_selected = true;
				if ($(this).val()=='none'/* ||$(this).is(':empty')*/){
					//chart.data.datasets[1].data = scatterPlotDataArray;
					chart.data.datasets[1].data = filterChart();
					drawReg(filterChart());
					/*chart.options.scales.xAxes[0].ticks = {};
					chart.options.scales.yAxes[0].ticks = {};
					chart.options.scales.xAxes[0].ticks = {beginAtZero: false};
					chart.options.scales.yAxes[0].ticks = {beginAtZero: false};*/
					//console.log('Znak biały: '+chart.data.datasets[1].data);
					var okr_= $select.val();
					temp_zoomed = manually_zoomed;
					selected = true;
					if (!polygon_clicked&&!item_clicked&&!adm_clicked){
						sel_clicked = true;
					}else{
						sel_clicked = false;
					}
					if (json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', current_KOD)[0].properties.Okr != okr_){
						chart.data.datasets[0].data = [];
						chart.data.datasets[0].data.push(0);
					}
					//map.spin(true);
					//setTimeout(function () {
					//console.log(subb);
					//if (subb==0
						//!!TEMP
					
					if (!popup_open_first_clicked&&!popup_close_first_clicked){
						console.log("sub okr_gr1");
						//$(document).ready(function ()
						/*if (item_clicked){
							//stały zoom
							manually_zoomed = true;
						}else */if (adm_clicked||sel_clicked){
							manually_zoomed = false;
							/*if (!temp_zoomed){
								//stały zoom
								manually_zoomed = false;
							}else{
								//dopasowanie poligonu do okna
								manually_zoomed = true;
							//}*/
						}else{
							manually_zoomed = temp_zoomed;
							//auto_zoom = false;
						}
						temp_zoomed = manually_zoomed;
						//if (!to_subsel){
							if (!manually_zoomed){
								//if (okr_!= current_KOD.substring(0,2)){
								//alert("Zoom - subselect");
								programmaticMapManipulation = true;
								map.fitBounds(okrs[okr_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
								setTimeout(function () {
									programmaticMapManipulation = false;
								},0);
								//}
							}else{
								var cbounds = layers[current_KOD].getBounds();
								map.setMaxZoom(map.getZoom());
								map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
								map.setMaxZoom(10);
							}
						//}
						setTimeout(function () {
							manually_zoomed = temp_zoomed;
							/*setTimeout(function () {
								zoomToLabels();
							},200);*/
							//resetLabels();
							if (!manually_zoomed){
								map.getPane('labels').style['text-align'] = 'center';
								map.getPane('labels').style.display = 'inline-block';
							}
							//map.spin(false);
						},0);
						//});
							/*map.getPane('labels').style.display = 'inline-block';
							map.getPane('labels').style['text-align'] = 'center';*/
					}
					//manually_zoomed = true;
					/*$('.leaflet-control-layers-list:eq( 1 ) h5 span').html($select.val().substring(3));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').empty();
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PiS:',json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS10"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS15"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PO:',json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PO10"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PO15"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["PO20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Absencja i głosy nieważne:',json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS10"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS15"],json_Okr.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS20"],false));*/
						//map.spin(false);
					//}, 3000);
					//$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('okręg wyborczy nr&nbsp;'+okr_);
					$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('<a href = "https://sejmsenat2019.pkw.gov.pl/sejmsenat2019/en/wyniki/sejm/okr/'+okr_+'" target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a>Constituency no.&nbsp;'+okr_);
					admSumm(json_Okr,'Okr');
					cssSumm();
					
					czoom = map.getZoom();
					okrs2[okr_].setStyle({weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*3.36});
					okrs[okr_].setStyle({color: 'rgba(160,0,0,1.0)', fillPattern: stripes, weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*2.24});
					okrs[okr_].bringToFront();
					filtered = false;
					sel_clicked = false;
					console.log('subselect changed ' + filtered);
				}else{
					var pow_= $(this).val().substring(0,4);
					
					selected = true;
					//map.spin(true);
					temp_zoomed = manually_zoomed;
					if (!polygon_clicked&&!item_clicked&&!adm_clicked){
						subsel_clicked = true;
					}else{
						subsel_clicked = false;
					}
					//setTimeout(function () {
					if (!popup_open_first_clicked&&!popup_close_first_clicked){
						console.log("Nazwa powiatu---");
						//$(document).ready(function (){
						//auto_zoom = true;
						/*if (item_clicked){
							//stały zoom
							manually_zoomed = true;
						}else */if (adm_clicked||subsel_clicked){
							manually_zoomed = false;
							/*if (!temp_zoomed){
								//stały zoom
								manually_zoomed = false;
							}else{
								//dopasowanie poligonu do okna
								manually_zoomed = true;
							//}*/
						}else{
							manually_zoomed = temp_zoomed;
							//auto_zoom = false;
						}
						temp_zoomed = manually_zoomed;
						if (!manually_zoomed){
							programmaticMapManipulation = true;
							//alert("Subselect zoom!");
							map.fitBounds(pow_ats[pow_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.4});
							setTimeout(function () {
								programmaticMapManipulation = false;
							},0);
						}else{
							var cbounds = layers[current_KOD].getBounds();
							map.setMaxZoom(map.getZoom());
							map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							map.setMaxZoom(10);
							//console.log("manually_zoomed: "+manually_zoomed);
							/*if (manually_zoomed){
								map.setMaxZoom(10);
							}else{
								map.setMaxZoom(map.getZoom());
							}*/
							//console.log("!manual_zoom");
						}
						//auto_zoom = false;
						//});
							/*map.getPane('labels').style.display = 'inline-block';
							map.getPane('labels').style['text-align'] = 'center';*/
						setTimeout(function () {
							manually_zoomed = temp_zoomed;
							/*setTimeout(function () {
								zoomToLabels();
							},200);*/
							if (!manually_zoomed){
								map.getPane('labels').style['text-align'] = 'center';
								map.getPane('labels').style.display = 'inline-block';
							}
							//map.spin(false);
						},0);
					}
					
					
					////alert("Subselect changed - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\npopup_close_first_clicked: " + "\npopup_open_first_clicked: " + popup_open_first_clicked);
					subsel_clicked = false;
					/*$('.leaflet-control-layers-list:eq( 1 ) h5 span').html($(this).val().substring(5));
					//$('.leaflet-control-layers-list:eq( 1 ) tbody').html('');
					$('.leaflet-control-layers-list:eq( 1 ) tbody').empty();
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PiS:',json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PiS'10"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PiS'15"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PiS'20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PO:',json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PO'10"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PO'15"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PO'20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Absencja i głosy nieważne:',json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_ABS'10"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_ABS'15"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_ABS'20"],false));*/
						//map.spin(false);
					//}, 3000);
					
					//$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html(json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["JPT_NAZWA_"]);
					var pow_end = (pow_=="1465")?"01":"00";
					$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('<a href = "https://sejmsenat2019.pkw.gov.pl/sejmsenat2019/en/wyniki/sejm/pow/' + pow_ + pow_end +'" target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a>'+json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["JPT_NAZWA_"]);
					admSumm(json_Powiaty_Simplified_1,'JPT_KOD_JE');
					cssSumm();
					
					for (i=0; i<scatterPlotDataArray.length; i++){
						let el = scatterPlotDataArray[i];
						//el.x = 100-(el.x+el.y);
						if (el.featureId.substring(0,4)==pow_){
							filteredPlotDataArray.push(el);
						}else{
							filteredPlotDataArray.push(0);
						}
					}
					if (current_KOD.substring(0,4)!=pow_){
						chart.data.datasets[0].data = [];
						chart.data.datasets[0].data.push(0);
					}
					chart.data.datasets[1].data = filteredPlotDataArray;
					drawReg(filteredPlotDataArray);
					//chart.data.datasets[0].data = [];
					//chart.data.datasets[2].data = [];
					czoom = map.getZoom();
					pow_ats2[pow_].setStyle({weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*2.16});
					pow_ats[pow_].setStyle({color: 'rgba(160,32,32,1.0)', fillPattern: stripes, weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*1.44});
					ptemp = plabels[pow_]._tooltip._container.innerHTML.replace(tool_unchecked, tool_checked);
					plabels[pow_]._tooltip._container.innerHTML = ptemp;
					console.log(plabels[pow_]._tooltip._content);
					pow_ats[pow_].bringToFront();
					pow_last = pow_;
					//map.getPane('subsel').style.zIndex = 420;
					//pow_ats[pow_].setStyle({pane: 'pane_Powiaty_Simplified_2'});
					filtered = true;
					console.log('subselect changed ' + filtered);
					//filteredPlotDataArray =[];
				}
				//already_selected = false;
				
				//szoom = map.getZoom();
				//console.log("czoom: "+czoom+" szoom: "+szoom);
				//chosenCol('Podsumowanie_tot');
				/*for (i=0; i<filteredPlotDataArray.length; i++) {
					var fl = filteredPlotDataArray[i];
					fl.x = 100-(fl.x+fl.y);
				}*/
				//zoomToLabels();
				fitChart();
				chart.update();
			});
		function updateLabels(lnr){
			if ($select.val()!='Poland'){
				xa = '1. ' + json_Okr.getFeaturesByProperty('Okr', Number($select.val()))[0].properties['P' + lnr + '_1_naz'] + ' ' + json_Okr.getFeaturesByProperty('Okr', Number($select.val()))[0].properties['P' + lnr + '_1_im'];
				ya = '2. ' + json_Okr.getFeaturesByProperty('Okr', Number($select.val()))[0].properties['P' + lnr + '_2_naz'] + ' ' + json_Okr.getFeaturesByProperty('Okr', Number($select.val()))[0].properties['P' + lnr + '_2_im'];
			}
		}
		function restoreLabels(){
			xa = xb;
			ya = yb;
		}
		var subch = function(){
			if ($select.val()!='Poland'){
				$subselect.prop('disabled', false).empty();
				filteredListPowArray = filterListPow();
				//console.log('Powiaty: '+filteredListPowArray);
				filtered = true;
				console.log('subch changed ' + filtered);
				updateLabels(layer_nr);
				console.log(xa);
				for (var i = 0; i < filteredListPowArray.length+1; i++) {
					//ranges[variables[i]] = { min: Infinity, max: -Infinity };
					// Simultaneously, build the UI for selecting different
					// ranges
					if (i==0){
						$('<option></option>')
						.text(' ')
						.attr('value', 'none')
						.appendTo($subselect);
					}else{
						$('<option></option>')
						.text(filteredListPowArray[i-1])
						.attr('value', filteredListPowArray[i-1])
						.appendTo($subselect);
					}
				}
			}else{
				$subselect.prop('disabled', true);
				$subselect.empty();
				filtered = false;
				console.log('subch changed ' + filtered);
				xa = xb;
				ya = yb;
				za = zb;
				pa = pb;
			}
			changerToChart($changer);
			chart.update();
		};
		function updateChanger(xx,yy,zz, pp){
			var tsel = $changer.prop('selectedIndex');
			$changer.empty();
			_axis = [
				'x: '+xx+ ', y: '+yy,
				'x: '+xx+ ', y: '+zz,
				'x: '+yy+ ', y: '+xx,
				'x: '+yy+ ', y: '+zz,
				'x: '+zz+ ', y: '+xx,
				'x: '+zz+ ', y: '+yy,
				//
				'x: '+xx+ ', y: '+pp,
				'x: '+xx+ ', y: '+pp,
				'x: '+yy+ ', y: '+pp,
				'x: '+pp+ ', y: '+xx,
				'x: '+pp+ ', y: '+yy,
				'x: '+pp+ ', y: '+zz];
			for (var i = 0; i < _axis.length; i++) {
				$('<option></option>')
					.text(_axis[i])
					.attr('value', _axis[i])
					.appendTo($changer);
			}
			$('#changer option')[tsel].selected = true;
			//$('#selectBox option').eq(tsel).prop('selected', true);
		}
		function checkChangerIndex(psel){
			if(psel.prop('selectedIndex')<6){
				chart.data.datasets[0].pointBackgroundColor = pointFBackgroundColors;
				chart.data.datasets[1].pointBackgroundColor = pointBackgroundColors;
				chart.data.datasets[2].pointBackgroundColor = pointBBackgroundColors;
			}else{
				chart.data.datasets[0].pointBackgroundColor = pointRFBackgroundColors;
				chart.data.datasets[1].pointBackgroundColor = pointRBackgroundColors;
				chart.data.datasets[2].pointBackgroundColor = pointRBBackgroundColors;
			}
		}
		function changerToChart(sel){
			switch(sel.prop('selectedIndex')){
				case 0:
					scatterPlotDataArray = scatterPlotDataArray_xy;
					chart.options.scales. xAxes[0].scaleLabel.labelString=xa;
					chart.options.scales. yAxes[0].scaleLabel.labelString=ya;
					break;
				case 1:
					scatterPlotDataArray = scatterPlotDataArray_xz;
					chart.options.scales. xAxes[0].scaleLabel.labelString=xa;
					chart.options.scales. yAxes[0].scaleLabel.labelString=za;
					break;
				case 2:
					scatterPlotDataArray = scatterPlotDataArray_yx;
					chart.options.scales. xAxes[0].scaleLabel.labelString=ya;
					chart.options.scales. yAxes[0].scaleLabel.labelString=xa;	
					break;
				case 3:
					scatterPlotDataArray = scatterPlotDataArray_yz;
					chart.options.scales. xAxes[0].scaleLabel.labelString=ya;
					chart.options.scales. yAxes[0].scaleLabel.labelString=za;
					break;
				case 4:
					scatterPlotDataArray = scatterPlotDataArray_zx;
					chart.options.scales. xAxes[0].scaleLabel.labelString=za;
					chart.options.scales. yAxes[0].scaleLabel.labelString=xa;
					break;
				case 5:
					scatterPlotDataArray = scatterPlotDataArray_zy;
					chart.options.scales. xAxes[0].scaleLabel.labelString=za;
					chart.options.scales. yAxes[0].scaleLabel.labelString=ya;	
					break;
				case 6:
					scatterPlotDataArray = scatterPlotDataArray_xp;
					chart.options.scales. xAxes[0].scaleLabel.labelString=xa;
					chart.options.scales. yAxes[0].scaleLabel.labelString=pa;
					break;
				case 7:
					scatterPlotDataArray = scatterPlotDataArray_yp;
					chart.options.scales. xAxes[0].scaleLabel.labelString=ya;
					chart.options.scales. yAxes[0].scaleLabel.labelString=pa;
					break;
				case 8:
					scatterPlotDataArray = scatterPlotDataArray_zp;
					chart.options.scales. xAxes[0].scaleLabel.labelString=za;
					chart.options.scales. yAxes[0].scaleLabel.labelString=pa;	
					break;
				case 9:
					scatterPlotDataArray = scatterPlotDataArray_px;
					chart.options.scales. xAxes[0].scaleLabel.labelString=pa;
					chart.options.scales. yAxes[0].scaleLabel.labelString=xa;
					break;
				case 10:
					scatterPlotDataArray = scatterPlotDataArray_py;
					chart.options.scales. xAxes[0].scaleLabel.labelString=pa;
					chart.options.scales. yAxes[0].scaleLabel.labelString=ya;
					break;
				case 11:
					scatterPlotDataArray = scatterPlotDataArray_pz;
					chart.options.scales. xAxes[0].scaleLabel.labelString=pa;
					chart.options.scales. yAxes[0].scaleLabel.labelString=za;	
					break;
				default:
					scatterPlotDataArray = scatterPlotDataArray_xy;
					chart.options.scales. xAxes[0].scaleLabel.labelString=xa;
					chart.options.scales. yAxes[0].scaleLabel.labelString=ya;
			}
			//pointBackgroundColor
			checkChangerIndex(sel);
		}
		
		function colorizeText(value){
			if (value==0){
				return '>';
			}else if  (value>0){
				return ' style="color: #c0ffc0">+'
			}else{
				return ' style="color: #ffc0c0">'
			}
		}
		
		function setTooltipText(opt1, opt2, opt3, meas,tooltipItems, lnr){
			var multistringText =  [];
			if (tooltipItems.datasetIndex!=2){
			  if ($subselect.val()=='none'||$subselect.is(':empty')){
				  
				  multistringText.push('<tr><td colspan="2" class="toolHead">Location:</td></tr>');
				  if ($select.val()=='Poland'){
					//multistringText.push('<tr><td colspan="2"  style="text-align: left;"> okręg nr '+ json_Okr.getFeaturesByProperty('Wojewod', scatterPlotDataArray_xy[tooltipItems.index].featureId.substring(0, 2))[0].properties.JPT_NAZWA_+'</td></tr>');
					multistringText.push('<tr><td colspan="2"  style="text-align: left;"> Constituency no. '+ json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', scatterPlotDataArray_xy[tooltipItems.index].featureId)[0].properties.Okr+'</td></tr>');
					//console.log(json_Okr);
				  }
				  multistringText.push('<tr><td colspan="2"  style="text-align: left;">'+ json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', scatterPlotDataArray_xy[tooltipItems.index].featureId.substring(0, 4))[0].properties.JPT_NAZWA_+'</td></tr>');
			  }
			  
			   var d = scatterPlotDataArray_xy[tooltipItems.index];
			    if  (meas=='&nbsp;p.p.'){
					multistringText.push('<tr><td colspan="2" style="text-align: center;">Zmiana wyników:</td></tr>');
					multistringText.push('<tr><td>'+opt1+':</td><td'+colorizeText(d.y)+d.y.toFixed(2)+meas+'</td></tr>');
					multistringText.push('<tr><td>'+opt2+':</td><td'+colorizeText(d.x)+d.x.toFixed(2)+meas+'</td></tr>');
					multistringText.push('<tr><td>'+opt3+':</td><td'+colorizeText(0-(d.y+d.x))+(0-(d.y+d.x)).toFixed(2)+meas+'</td></tr>');
				}else{
					var xtext=(d.x>d.y&&d.x>100-(d.x+d.y))?'<b style="color: #ffffa0">'+opt1+'</b></td><td><b style="color: #ffffa0">'+d.x.toFixed(2)+meas+'</b>':opt1+'</td><td>'+d.x.toFixed(2)+meas;
					var ytext=(d.y>d.x&&d.y>100-(d.x+d.y))?'<b style="color: #ffffa0">'+opt2+'</b></td><td><b style="color: #ffffa0">'+d.y.toFixed(2)+meas+'</b>':opt2+'</td><td>'+d.y.toFixed(2)+meas;
					var ztext=(100-(d.x+d.y)>d.x&&100-(d.x+d.y)>d.y)?'<b style="color: #ffffa0">'+opt3+'</b></td><td><b style="color: #ffffa0">'+(100-(d.y+d.x)).toFixed(2)+meas+'</b>':opt3+'</td><td>'+(100-(d.y+d.x)).toFixed(2)+meas;
					multistringText.push('<tr><td colspan="2" class="toolHead">Result:</td></tr>');
					multistringText.push('<tr><td>Support for the list:</td><td>'+ json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', scatterPlotDataArray_xy[tooltipItems.index].featureId)[0].properties['P' + lnr + '_p'].toFixed(2)+'%</td></tr>');
					multistringText.push('<tr><td colspan="2" class="toolHead">Share in support for&nbsp;the&nbsp;list:</td></tr>');
					multistringText.push('<tr><td>'+xtext+'</td></tr>');
					multistringText.push('<tr><td>'+ytext+'</td></tr>');
					multistringText.push('<tr><td>'+ztext+'</td></tr>');
				}
			}
			return multistringText.join('');
		}
		
		console.log('Inicjacja subch');
		$select.change(subch);
		var $changer = $('<select name="changer1" onmousedown="if(this.options.length>4){this.size=4;}"  onchange="this.size=0;" onblur="this.size=0;"></select>')
			.appendTo($('#changer'))
			.on('change', function() {
				changerToChart($(this));
				console.log(filtered);
				layer_code = layer_current._leaflet_id;
				chart.data.datasets[0].data = checkPoint();
				if($changer.prop('selectedIndex')<6){
					chart.data.datasets[2].pointBorderColor = 'rgba(255, 255, 255, 0.5)';
				}else{
					chart.data.datasets[2].pointBorderColor = 'rgba(200, 200, 200, 0.5)';
				}
				
				if ($select.val()=='Poland'){
					chart.data.datasets[1].data = scatterPlotDataArray;
					chart.data.datasets[2].data = [];
					drawReg(scatterPlotDataArray);
					if($changer.prop('selectedIndex')<6){
						setChart();
					}else{
						fitChart();
					}
				}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
					chart.data.datasets[1].data = filterChart();
					if (party!=0){
						chart.data.datasets[2].data = scatterPlotDataArray;
					}else{
						chart.data.datasets[2].data = [];
					}
					drawReg(filterChart());
					console.log(chart.options.tooltips);
					if ($select.val()!=json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', current_KOD)[0].properties.Okr){
						chart.data.datasets[0].data = [];
					}
					fitChart();
				}else {
					chart.data.datasets[1].data = subfilterChart();
					if (party!=0){
						chart.data.datasets[2].data = filterChart();
					}else{
						chart.data.datasets[2].data = [];
					}
					drawReg(subfilterChart());
					console.log(chart.options.tooltips);
					if ($subselect.val().substring(0,4)!=current_KOD.substring(0,4)){
						chart.data.datasets[0].data = [];
					}
					fitChart();
				}
				if (party!=0){
					//chart.data.datasets[2].data = scatterPlotDataArray;
					setChart();
				}else{
					//chart.data.datasets[2].data = [];
					if ($select.val()!='Poland') fitChart();
				}
				chart.update();
			});
		for (var i = 0; i < _axis.length; i++) {
			//ranges[variables[i]] = { min: Infinity, max: -Infinity };
			// Simultaneously, build the UI for selecting different
			// ranges
			$('<option></option>')
				.text(_axis[i])
				.attr('value', _axis[i])
				.appendTo($changer);
		}
		
		var margl = '<div style="margin-left:20px;">';
		var thead = [];
		var row_empty = '<tr><td colspan="4" style="font-size: 32px; background-color: #e4e4e4; justify-content: center; align-items: center;"><div><b>...</b></div></td></tr>';
		
		/*function candidateName(cIndex){
			switch(cIndex){
				case  0:
					return 'Kaczyński:';
					break;
				case  1:
					return 'Komorowski:';
					break;
				case  3:
					return 'Duda:';
					break;
				case  4:
					return 'Komorowski:';
					break;
				case  6:
					return 'Duda:';
					break;
				case  7:
					return 'Trzaskowski:';
					break;
				default:
					return 'NN:';
			}
		}*/
		
		map.on('popupopen', function(e) {
			//var rows_generated = 0;
			//$('.leaflet-sbs-range').css("z-index", "100");
			console.log(scatterPlotDataArray);
			console.log(chart.data.datasets[1].data);
			
			var data1 = chart.data.datasets[1].data;
			var color1 = chart.data.datasets[1].pointBackgroundColor;
			$('.leaflet-sbs-range').attr('style', 'z-index: 100 !important');
			$('.leaflet-sbs-divider').css("z-index", "100");
			current_KOD = e.popup._source.feature.properties.JPT_KOD_JE;
			var PJE = e.popup._source.feature.properties.Powiat;
			var POE = e.popup._source.feature.properties.Okr;
			var powiat_nazwa = json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', PJE)[0].properties.JPT_NAZWA_;
			//var okr_nazwa = json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', PWE)[0].properties.JPT_NAZWA_;
			//chart.data.datasets[0].data = checkPoint();
			chart.update();
			layer_code = layer_current._leaflet_id;
			//programmaticMapManipulation = true;
			link_clicked = false;
			block_cl_pop = true;
			already_filtered = true;
			chart.data.datasets[0].data = [];
			if ($select.val()=='Poland'){
				chart.data.datasets[1].data = scatterPlotDataArray;
				drawReg(scatterPlotDataArray);
				//fitChart();
			}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
				var skod = e.popup._source.feature.properties.Okr.toString();
				var sind = e.popup._source.feature.properties.Okr;
				
				//console.log(current_KOD+'-'+skod+'-'+cind+'-'+sind);
				
				//if (sind!=cind){
					//console.log('Popup opened (woj) subch');
					//$select.change(subch);
					//setTimeout(function () {
						polygon_clicked = true;
						manual_zoom = false;
						//alert("_"+$("#filter option:selected").text().substring(0,8)+"_");
						//$('#filter :nth-child('+sind+')').prop('selected', true).change();
						$("#filter option").filter(function() {
							//may want to use $.trim in here
							return $(this).text().substring(6,8) == sind;
						}).prop('selected', true).change();
						//alert("Lecimy!!!");
						manual_zoom = true;
						polygon_clicked = false;
						//chart.update();
					//}, 500);
					//console.log('popup opened ' + filtered);
					//wojewods[PWE].setStyle({color: 'rgba(255,0,0,1.0)'});
				//}
				/*if ($select.val()!='Poland'){
					$('#subfilter :nth-child(1)').prop('selected', true).change();
				}*/
				//chart.data.datasets[1].data = filterChart();
				console.log(chart.options.tooltips);
				fitChart();
			} else {
				select_twice = true;
				woj_zoom = false;
				
				console.log($select);
				console.log($select.val());
				//if ($select.val()=='Poland'){
					//console.log("Tak - Poland!");
				var wind = e.popup._source.feature.properties.Okr;
				//var wind = $("#filter option:selected").text().substring(0,8);
				//if (wind!=cind){
					//$('#filter :nth-child('+wind+')').prop('selected', true).change();
					$("#filter option").filter(function() {
						//may want to use $.trim in here
						return $(this).text().substring(6,8) == wind;
					}).prop('selected', true).change();
					console.log('Popup opened (pow) subch');
					$select.change(subch);
					console.log("iii");
				//}
				//$select.change(subch);
				//subb = 1;
				//$('#subfilter :nth-child('+pind+')').prop('selected', true).change();
				polygon_clicked = true;
				manual_zoom = false;
				$("#subfilter option").filter(function() {
				  //may want to use $.trim in here
					return $(this).text().substring(0,4) == current_KOD.substring(0,4);
				}).prop('selected', true).change();
				manual_zoom = true;
				polygon_clicked = false;
				console.log("iii");
				//subb = 0;
				//map.fitBounds(pow_ats[kod.substring(0,4)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
				cind=wind;
				polind =0;
				filtered = true;
				//chart.data.datasets[1].data = subfilterChart();
				console.log(chart.options.tooltips);
				//fitChart();
				//map.getPane('pane_Granicewojewdztw_1').style.zIndex = 402;
				
				setTimeout(function () {
					select_twice = false;
				}, 0);
			}
			
			//select_twice = false;
			pointRadiuses = [];
			pointBorderColors = [];
			pointBBorderColors = [];
			pointBorderWidths = [];
			var licz = 0;
			var liczyc = true;
			layer_current.eachLayer(function(layer) {
				
				pointBBorderColors.push('rgba(255, 255, 255, 0.2)');
				/*if (current_KOD==layer.feature.properties.JPT_KOD_JE){
					//layer.bringToBack();
					console.log(layer.feature.properties.JPT_KOD_JE);
					pointRadiuses.push(6.4);
					pointBorderColors.push('rgba(255, 0, 0, 1.0)');
					pointBorderWidths.push(2.56);
					//layer.push(layer.splice(layer.indexOf(layer[current_KOD]), 1)[0]);
					liczyc = false;
				}else{*/
					pointRadiuses.push(3.6);
					pointBorderColors.push('rgba(64, 64, 64, 0.64)');
					pointBorderWidths.push(1.0);
				//}
			});
			/*pointRadiuses.push(pointRadiuses.splice(pointRadiuses[licz], 1)[0]);
			pointBorderColors.push(pointBorderColors.splice(pointBorderColors[licz], 1)[0]);
			pointBorderWidths.push(pointBorderWidths.splice(pointBorderWidths[licz], 1)[0]);
			pointBackgroundColors.push(pointBackgroundColors.splice(pointBackgroundColors[licz], 1)[0]);*/
			/*pointRadiuses[2476]=6.4;
			pointBorderColors[2476]='rgba(255, 0, 0, 0.4)';
			pointBorderWidths[2476]=2.56;*/
			//layer_current[licz];
			
			
			//}
			chart.data.datasets[1].pointRadius = pointRadiuses;
			chart.data.datasets[1].pointBorderColor = pointBorderColors;
			
			chart.data.datasets[1].pointBorderWidth = pointBorderWidths;
			//chart.data.datasets[2].data = [];
			
			if($changer.prop('selectedIndex')<6){
				chart.data.datasets[0].pointBackgroundColor = pointFBackgroundColors;
				chart.data.datasets[1].pointBackgroundColor = pointBackgroundColors;
				chart.data.datasets[2].pointBackgroundColor = pointBBackgroundColors;
				chart.data.datasets[2].pointBorderColor = pointBBorderColors;
			}else{
				chart.data.datasets[0].pointBackgroundColor = pointRFBackgroundColors;
				chart.data.datasets[1].pointBackgroundColor = pointRBackgroundColors;
				chart.data.datasets[2].pointBackgroundColor = pointRBBackgroundColors;
				chart.data.datasets[2].pointBorderColor = 'rgba(200, 200, 200, 0.5)';
			}
			
			//chart.data.datasets[1].data.push(chart.data.datasets[1].data.splice(scatterPlotDataArray[licz], 1)[0]);
			//chart.data.datasets[0].pointRadius[licz]= 6.4;
			//console.log(pointRadiuses.length);
			chart.data.datasets[0].data = checkPoint();
			chart.update();
			//block_cl_pop = false;
			//setTimeout(function () {
				block_cl_pop = false;
			//}, 0);
			manual_popup = true;
			$(document).ready(function ()	{
				var p = e.popup._source.feature.properties;
				function returnColor(column, breaks, colors = fcolors){
					for (i=1; i<9; i++){
						if (p[column] >= breaks[i-1] && p[column] <= breaks[i]){
							return  colors[i-1];
						}
					}
				}
				var popupContent	= [];
				var opopupContent	= [];
				var plpopupContent	= [];
				
				
				for (i=0; i<5; i++){
					popupContent[i] = new Array();
					opopupContent[i] = new Array();
					plpopupContent[i] = new Array();
				}
				for (i=0; i<5; i++){
					popupContent[i].push(margl);
					opopupContent[i].push(margl);
					plpopupContent[i].push(margl);
				}
				var pozostali = "Candidates from the third to the last position on the list"; //Kandydaci z&nbsp;miejsc od&nbsp;trzeciego do&nbsp;ostatniego
				var poparcie = "Support for the electoral list"; //Poparcie dla listy
				var jedynki = "1st-listed candidates"; //Jedynki
				var dwojki = "2nd-listed candidates"; //Dwójki
				var d_okr = json_Okr.getFeaturesByProperty('Okr',p.Okr)[0];
				var curr_kod;
				var curr_udzial;
				var curr_nazwa;
				var curr_kolor;
				var comp_lvl = 1;
				
				function flexHead(a){
					if(a%4<2){
						return (a%4+1)+'. '+d_okr.properties['P'+(Math.floor(a/4)+1)+'_'+(a%4+1)+'_naz']+' '+d_okr.properties['P'+(Math.floor(a/4)+1)+'_'+(a%4+1)+'_im'];
					}else if (a%4==2){
						return pozostali;
					}else{
						return poparcie;
					}
				}
				function flexHead_pl(a){
					if(a%4==0){
						return jedynki;
					}else if (a%4==1){
						return dwojki;
					}else if (a%4==2){
						return pozostali;
					}else{
						return poparcie;
					}
				}
				/*function flexTool_pl(a, _kod){
					if(a%4<2){
						var c_okr = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', _kod)[0].properties['Okr'];
						var e_okr = json_Okr.getFeaturesByProperty('Okr',c_okr)[0];
						return (a%4+1)+'. '+e_okr.properties['P'+(Math.floor(a/4)+1)+'_'+(a%4+1)+'_naz'];
					}else if (a%4==2){
						return pozostali;
					}else{
						return poparcie;
					}
				}*/
				function flexTool(a, _kod){
					if(a%4<2){
						if (comp_lvl != 3){
							return (a%4+1)+'. '+d_okr.properties['P'+(Math.floor(a/4)+1)+'_'+(a%4+1)+'_naz'];
						}else{
							var c_okr = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', _kod)[0].properties['Okr'];
							var e_okr = json_Okr.getFeaturesByProperty('Okr',c_okr)[0];
							return (a%4+1)+'. '+e_okr.properties['P'+(Math.floor(a/4)+1)+'_'+(a%4+1)+'_naz'];
						}
					}else if (a%4==2){
						return pozostali;
					}else{
						return poparcie;
					}
				}
				var txt1 = '<tr><td><div>';
				
				function writePosition(_pow, _okr, _iter){
					if (comp_lvl == 3){
						return _pow+'<br>\
									Constituency no. '+_okr+'<br>';
					}else if  (comp_lvl == 2){
						return _pow+'<br>';
					}else{
						return '';
					}
				}
				var row_curr = '';
				var row = '';
				var t_gm, d1, d2, d3, d4;
				var ind, len;
				function prepareDataPL(index, gmind){
					/*len = curr_kod[index].length;
					ind = curr_kod[index].indexOf(current_KOD);*/
					t_gm = (curr_kod[index][gmind].substring(6,7)!=="1"?'gm. ':'');
					wynik_listy = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', curr_kod[index][gmind])[0].properties['P'+(Math.floor(index/4)+1)+'_p'];
					//var c_col = String(returnColor_simpl(wynik_listy, allbreaks[Math.floor(i/4)]));
					if (index%4==3){
						c_col = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', curr_kod[index][gmind])[0].properties['P'+(Math.floor(index/4)+1)+'_rgb'];
					}else{
						for (j=1; j<9; j++){
							if (wynik_listy >= allbreaks[Math.floor(index/4)][j-1] && wynik_listy <= allbreaks[Math.floor(index/4)][j]){
								c_col =  fcolors[j-1];
							}
						}
					}
					d1 = curr_kod[Math.floor(index/4)*4].indexOf(curr_kod[index][gmind]);
					d2 = curr_kod[Math.floor(index/4)*4+1].indexOf(curr_kod[index][gmind]);
					d3 = curr_kod[Math.floor(index/4)*4+2].indexOf(curr_kod[index][gmind]);
					d4 = curr_kod[Math.floor(index/4)*4+3].indexOf(curr_kod[index][gmind]);
				}
				function rowGen(nrow, iter, u_gm, c1, c2, c3, result, iscurr, lvl = "pow"){
					var ckod = curr_kod[iter][nrow];
					var ppow = json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', ckod.substring(0,4))[0].properties['JPT_NAZWA_'];
					var ookr = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', ckod)[0].properties['Okr'];
					var bolding = iscurr?' style="font-weight:bold;"':'';
					return '<tr><td'+bolding+'><div>'+(nrow+1)+ '.</div></td><td class = "'+lvl+'" '+bolding+'>\
						<div class="containers">\
							<a class="has-tooltip" href="#"><span class="n_gm" style="width: 120px;">'+u_gm + '<span class="gmina">'+curr_nazwa[iter][nrow]+'</span></span>\
								<span class="tooltip-wrappers">\
									<span class="tooltips"><h4 style="margin: 4px; padding: 0px; text-align: center;">Location:</h4>\
									TERYT: <span class="kod">' +ckod+'</span><br>\
									'+writePosition(ppow, ookr)+
									'<table style="width: 184px;">\
									<tr><td colspan="2"><h4 style="margin: 4px; padding: 0px; text-align: center;">Result:</h4></td></tr>\
									<tr><td>Support for the&nbsp;list:</td><td style="text-align: right;">' +result.toFixed(2)+'%</td></tr><tr><td colspan="2"><h4 style="margin: 4px; padding: 0px; text-align: center;">Share in&nbsp;support for&nbsp;the&nbsp;list:</h4></td></tr><tr><td>'+flexTool(Math.floor(i/4)*4, ckod)+'</td><td>'+lengthToBlank1(curr_udzial[Math.floor(i/4)*4][c1])+'%</td></tr><tr><td>'+flexTool(Math.floor(i/4)*4+1, ckod)+'</td><td>'+lengthToBlank1(curr_udzial[Math.floor(i/4)*4+1][c2])+'%</td></tr><tr><td>Other candidates:</td><td>'+lengthToBlank1(curr_udzial[Math.floor(i/4)*4+2][c3])+'%</td></tr></table>\
									</span>\
								</span>\
							</a>\
						</div>\
					</td><td'+bolding+'><div><div style="display: table; padding: 1px;"><div style="display: table-cell; vertical-align: middle; text-align: right; line-height: 0.9;">'+((i%4==3)?('<span style="color: red; font-size: 11px;">'+wynik_listy.toFixed(2)+'%</span>'):('<span style="color: blue;">'+curr_udzial[iter][nrow].toFixed(2)+'%</span><br><span class="ppod">out&nbsp;of&nbsp;<span style="color: red; font-size: 9px;">'+wynik_listy.toFixed(2)+'%</span></span>'))+'</div></div></div></td><td><div><div style = "background-color: white; display: inline-block; padding: 0px; margin: 0px; height: 30px;"><div style = "background-color: ' +  curr_kolor[iter][nrow] + '; opacity: 0.8;  width: 12px; height: 26px; border: 1px solid rgba(16, 16, 16, 0.2);"></div></div>'+'<div style = "background-color: white; display: inline-block; padding: 0px; margin: 20px 0px 0px 4px; height: 10px;"><div style = "background-color: ' + c_col  + '; opacity: 0.8;  width: 6px; height: 6px; border: 1px solid rgba(16, 16, 16, 0.2);"></div></div></div></td></tr>';
				}
				
				function tbodyGen (nrow, iter, popCont, level){
					if(ind<2||ind>len-3){
						if(nrow<3||nrow>len-4){
							
							if (nrow == ind){
								prepareDataPL(iter, nrow);
								row = rowGen(nrow, iter, t_gm, d1, d2, d3, wynik_listy, true, level);
							}else{
								prepareDataPL(iter, nrow);
								row = rowGen(nrow, iter, t_gm, d1, d2, d3, wynik_listy, false, level);
								
							}
							popCont[Math.floor(iter/4)].push(row);
						}else if (nrow==3){
							popCont[Math.floor(iter/4)].push( row_empty);
						}
					}else if(ind==len-3){
						if(nrow==len-3){
							prepareDataPL(iter, nrow);
							row = rowGen(nrow, iter, t_gm, d1, d2, d3, wynik_listy, true, level);
							popCont[Math.floor(iter/4)].push(row);
						}else if(nrow<2||nrow>len-3||nrow==ind-1){
							prepareDataPL(iter, nrow);
							row = rowGen(nrow, iter, t_gm, d1, d2, d3, wynik_listy, false, level);
							popCont[Math.floor(iter/4)].push(row);
						}else if (nrow==3){
							popCont[Math.floor(iter/4)].push( row_empty);
						}
					}else if(ind==2){
						if(nrow==2){
							prepareDataPL(iter, nrow);
							row = rowGen(nrow, iter, t_gm, d1, d2, d3, wynik_listy, true, level);
							popCont[Math.floor(iter/4)].push(row);
						}else if(nrow<2||nrow>len-3||nrow==ind+1){
							prepareDataPL(iter, nrow);
							row = rowGen(nrow, iter, t_gm, d1, d2, d3, wynik_listy, false, level);
							popCont[Math.floor(iter/4)].push(row);
						}else if (nrow==4){
							popCont[Math.floor(iter/4)].push( row_empty);
						}
					}else{
						if(nrow==ind){
							prepareDataPL(iter, nrow);
							row = rowGen(nrow, iter, t_gm, d1, d2, d3, wynik_listy, true, level);
							popCont[Math.floor(iter/4)].push(row);
						}else if(nrow==0||nrow==len-1||nrow==ind+1||nrow==ind-1||(ind==3&&nrow==1)||(ind==len-4&&nrow==len-2)){
							prepareDataPL(iter, nrow);
							row = rowGen(nrow, iter, t_gm, d1, d2, d3, wynik_listy, false, level);
							popCont[Math.floor(iter/4)].push(row);
						}else if (nrow==1||nrow==len-2){
							popCont[Math.floor(iter/4)].push( row_empty);
						}
					}
				}
				var to_h='<tr style=""><th colspan="4" style="font-size: 12px; display: flex;"><div><b>';
				var tc_h=':</b></div></th></tr>';
				var wynik_listy;
				var c_col;
				curr_udzial = JEudzial[PJE];
				curr_nazwa = JEnazwa[PJE];
				curr_kolor = JEkolor[PJE];
				curr_kod = JEkod[PJE];
				len = JEkod[PJE][0].length;
				for (i=0;i<20;i++){
					
					popupContent[Math.floor(i/4)].push('<div style="float:left; padding: 2px; width: 300px;"><table class = "tabela fixedheight"><thead>');
					popupContent[Math.floor(i/4)].push(to_h+flexHead(i)+tc_h);
					popupContent[Math.floor(i/4)].push('</thead><tbody>');
					
					if (len<8){
						for (a=0; a<JEkod[PJE][i].length;a++){
							prepareDataPL(i, a);
							if (JEkod[PJE][i][a] == current_KOD){
								row = rowGen(a, i, t_gm, d1, d2, d3, wynik_listy, true);
							}else{
								row = rowGen(a, i, t_gm, d1, d2, d3, wynik_listy, false);
							}
							popupContent[Math.floor(i/4)].push(row);
						}
					}else{
						ind = JEkod[PJE][i].indexOf(current_KOD);
						for (b=0; b<len;b++){
							tbodyGen (b, i, popupContent, "pow");
						}
						
					}
					
					popupContent[Math.floor(i/4)].push('</tbody></table></div>');
					(i%4==1)?popupContent[Math.floor(i/4)].push('<div style="clear:both;"></div>'):popupContent[Math.floor(i/4)].push('');
				}
				for (i=0; i<5; i++){
					popupContent[i].push('<div style="clear:both;"></div></div>');
				}
				//Okręgi wyborcze
				curr_udzial = OEudzial[POE];
				curr_nazwa = OEnazwa[POE];
				curr_kod = OEkod[POE];
				curr_kolor = OEkolor[POE];
				comp_lvl = 2;
				len = OEkod[POE][0].length;
				for (i=0;i<20;i++){
					ind = OEkod[POE][i].indexOf(current_KOD);
					opopupContent[Math.floor(i/4)].push('<div style="float:left; padding: 2px; width: 300px;"><table class = "tabela fixedheight"><thead>');
					opopupContent[Math.floor(i/4)].push(to_h+flexHead(i)+tc_h);
					opopupContent[Math.floor(i/4)].push('</thead><tbody>');
					
					if (len<8){
						for (a=0; a<OEkod[POE][i].length;a++){
							prepareDataPL(i, a);
							if (OEkod[POE][i][a] == current_KOD){
								row = rowGen(a, i, t_gm, d1, d2, d3, wynik_listy, true, "okr");
							}else{
								row = rowGen(a, i, t_gm, d1, d2, d3, wynik_listy, false, "okr");
							}
							opopupContent[Math.floor(i/4)].push(row);
						}
					}else{
						ind = OEkod[POE][i].indexOf(current_KOD);
						var row_curr = '';
						var row = '';
						
						for (b=0; b<len;b++){
							tbodyGen (b, i, opopupContent, "okr");
						}
					}
					opopupContent[Math.floor(i/4)].push('</tbody></table></div>');
					(i%4==1)?opopupContent[Math.floor(i/4)].push('<div style="clear:both;"></div>'):opopupContent[Math.floor(i/4)].push('');
				}
				for (i=0; i<5; i++){
					opopupContent[i].push('<div style="clear:both;"></div></div>');
				}
				
				curr_kod = PLkod;
				curr_udzial = PLudzial;
				curr_nazwa = PLnazwa;
				curr_kolor = PLkolor;
				curr_kod = PLkod;
				comp_lvl = 3;
				len = PLkod[0].length;
				for (i=0;i<20;i++){
					ind = PLkod[i].indexOf(current_KOD);
					plpopupContent[Math.floor(i/4)].push('<div style="float:left; padding: 2px; width: 300px;"><table class = "tabela fixedheight"><thead>');
					plpopupContent[Math.floor(i/4)].push(to_h+flexHead_pl(i)+tc_h);
					plpopupContent[Math.floor(i/4)].push('</thead><tbody>');
					for (b=0; b<len;b++){
						tbodyGen (b, i, plpopupContent, "pl");
					}
					plpopupContent[Math.floor(i/4)].push('</tbody></table></div>');
					(i%4==1)?plpopupContent[Math.floor(i/4)].push('<div style="clear:both;"></div>'):plpopupContent[Math.floor(i/4)].push('');
				}
				for (i=0; i<5; i++){
					plpopupContent[i].push('<div style="clear:both;"></div></div>');
				}
				$('#tab1').ready(function ()	{
					$("#tab1").scroll(function () {
						sd = $("#tab1").scrollTop();
						$('#tab1 .tooltips').css("bottom",(sd+0)+"px");
						//sc_temp=sd;
					});
					var typ_gm_d = (p.JPT_KOD_JE.substring(6, 7) !== "1"? 'gminy' : 'miasta');
					var typ_gm_c = (p.JPT_KOD_JE.substring(6, 7) !== "1"? 'gminie' : 'mieście');
					$("#tab1").html('<h5 style="text-align: center; color: #484848; padding: 0px 8px;">Support and distribution of votes on the lists of nationwide committees in the municipality:'); //Poparcie oraz rozkład głosów na listach komitetów ogólnopolskich na terenie
					$("#tab1").append('<table class = "tabela" id="Podsumowanie">\
						<thead>\
							<tr style="background: none;">\
								<th style="border-right: 2px solid #eee; border-top-left-radius: 32px;"></th>\
								<th><img src="legend/PiS.png" alt ="PiS"  class="Logo"/> </th>\
								<th><img src="legend/KO.png" alt="KO"   class="Logo"/></th>\
								<th><img src="legend/Lewica.jpg" alt="Lewica"   class="Logo"/></th>\
								<th><img src="legend/PSL.png" alt="PSL"   class="Logo"/></th>\
								<th><img src="legend/Konfederacja.jpg" alt="Konfederacja"   class="Logo"/></th>\
							</tr>\
						</thead>\
						<tbody>\
						</tbody>\
					</table>');
					
					var kd1 = [];
					var kd2 = [];
					var gd_ = [];
					var gd_1 = [];
					var gd_2 = [];
					var pd_1 = [];
					var pd_2 = [];
					var gd1 = [];
					var gd2 = [];
					var md1 = [];
					var md2 = [];
					var ud = [];
					var col15 = [];
					var rcol15 = [];
					var tt;
					var uu;
					var gg;
					var hh;
					col15.push('<tr>');
					rcol15.push('<tr>');
					col15.push(std + 'Color on the map of candidates\' participation in the electoral outcome:' + xtd);
					rcol15.push(std + 'Color on the map of support for the list:' + xtd);
					var odp, odp1, odp2;
					for (i=1; i<6; i++){
						console.log("Iteracja: "+i);
						kd1[i-1]=json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_1_naz"]+" "+json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_1_im"];
						tt = json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_1_g"];
						uu = p["P"+i+"_1_g"];
						gd1[i-1]=(uu/tt)*100;
						gg = json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_g"];
						hh = p["P"+i+"_g"];
						ud[i-1]=(hh/gg)*100;
						pd_1[i-1]=(uu/p.LG)*100;
						md1[i-1]=json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_1_mz"];
						kd2[i-1]=json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_2_naz"]+" "+json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_2_im"];
						tt = json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_2_g"];
						tt = json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_2_g"];
						uu = p["P"+i+"_2_g"];
						pd_2[i-1]=(uu/p.LG)*100;
						gd2[i-1]=(uu/tt)*100;
						/*console.log("Pole"+lengthToBlank(p['P'+i+'_g']));
						console.log("Pole"+lengthToBlank(p['P'+i+'_g']));*/
						console.log(p['P'+i+'_g']);
						/*odp = p['P'+i+'_g'];
						odp1 = p['P'+i+'_1_g'];
						odp2 = p['P'+i+'_2_g'];*/
						console.log(p['P'+i+'_g']);
						gd_[i-1]=numberWithSpaces(p['P'+i+'_g']);
						gd_1[i-1]=numberWithSpaces(p['P'+i+'_1_g']);
						gd_2[i-1]=numberWithSpaces(p['P'+i+'_2_g']);
						md2[i-1]=json_Okr.getFeaturesByProperty('Okr',p.Okr)[0].properties["P"+i+"_2_mz"];
						col15.push(std + bgcolor12 + p["P"+i+"_rgb"] + inlbl + xtd);
						console.log("Iteracja: "+i);
					}
					rcol15.push(std + bgcolor12 + returnColor('P1_p',pisbreaks) + inlbl + xtd);
					rcol15.push(std + bgcolor12 + returnColor('P2_p',kobreaks)+ inlbl + xtd);
					rcol15.push(std + bgcolor12 + returnColor('P3_p',lbreaks)+ inlbl + xtd);
					rcol15.push(std + bgcolor12 + returnColor('P4_p',pslbreaks)+ inlbl + xtd);
					rcol15.push(std + bgcolor12 + returnColor('P5_p',konfbreaks)+ inlbl + xtd);
					col15.push('</tr>');
					rcol15.push('</tr>');
					//console.log(kd1);
					//console.log(gd1);
					//$("#tab1 table:eq(0) tbody").append(renderRow_text("Liczba głosów oddanych na&nbsp;komitet:",gd_[0],gd_[1],gd_[2],gd_[3],gd_[4],12,false));
					//Liczba głosów oddanych na&nbsp;poszczególne komitety:
					$("#tab1 table:eq(0) tbody").append('<tr><td>Number of votes cast for individual committees:</td>\
						<td>'+lengthToBlank(p.P1_g)+numberWithSpaces(p.P1_g)+'</td>\
						<td>'+lengthToBlank(p.P2_g)+numberWithSpaces(p.P2_g)+'</td>\
						<td>'+lengthToBlank(p.P3_g)+numberWithSpaces(p.P3_g)+'</td>\
						<td>'+lengthToBlank(p.P4_g)+numberWithSpaces(p.P4_g)+'</td>\
						<td>'+lengthToBlank(p.P5_g)+numberWithSpaces(p.P5_g)+'</td>\
					</tr>');
					$("#tab1 table:eq(0) tbody").append(renderRow("Percentage of votes cast for individual committees:",p.P1_p,p.P2_p,p.P3_p,p.P4_p,p.P5_p,700,false));//Odsetek głosów oddanych na&nbsp;poszczególne komitety
					$("#tab1 table:eq(0) tbody").append(renderRow("Share in the number of votes cast for the committee in the constituency:",ud[0],ud[1],ud[2],ud[3],ud[4],400,true));//Udział w&nbsp;liczbie głosów oddanych na&nbsp;komitet w&nbsp;okręgu
					
					//divider
					$("#tab1 table:eq(0) tbody").append(renderRow_text("Surname and name of the 1st-listed candidate:",kd1[0],kd1[1],kd1[2],kd1[3],kd1[4],11,false));//Nazwisko i&nbsp;imiona jedynki
					//console.log(md1);
					$("#tab1 table:eq(0) tbody").append(renderRow_tool("Residence municipality of the 1st-listed candidate:",md1[0],md1[1],md1[2],md1[3],md1[4],false));
					//$("#tab1 table:eq(0) tbody").append(renderRow_text("Liczba głosów oddanych na&nbsp;jedynkę:",gd_1[0],gd_1[1],gd_1[2],gd_1[3],gd_1[4],12,false));
					$("#tab1 table:eq(0) tbody").append('<tr><td>Number of votes cast for&nbsp;the 1st-listed candidate:</td>\
						<td>'+lengthToBlank(p.P1_1_g)+numberWithSpaces(p.P1_1_g)+'</td>\
						<td>'+lengthToBlank(p.P2_1_g)+numberWithSpaces(p.P2_1_g)+'</td>\
						<td>'+lengthToBlank(p.P3_1_g)+numberWithSpaces(p.P3_1_g)+'</td>\
						<td>'+lengthToBlank(p.P4_1_g)+numberWithSpaces(p.P4_1_g)+'</td>\
						<td>'+lengthToBlank(p.P5_1_g)+numberWithSpaces(p.P5_1_g)+'</td>\
					</tr>');
					$("#tab1 table:eq(0) tbody").append(renderRow("Percentage of votes cast for&nbsp;the 1st-listed candidate:",pd_1[0],pd_1[1],pd_1[2],pd_1[3],pd_1[4],400,false));
					$("#tab1 table:eq(0) tbody").append(renderRow("Share of the 1st-listed candidate in the result of the list:",p.P1_1,p.P2_1,p.P3_1,p.P4_1,p.P5_1,700,false));
					$("#tab1 table:eq(0) tbody").append(renderRow("Share in the number of votes cast for the 1st-listed candidate in the constituency:",gd1[0],gd1[1],gd1[2],gd1[3],gd1[4],400,true));
					
					//divider
					$("#tab1 table:eq(0) tbody").append(renderRow_text("Surname and name of the 2nd-listed candidate:",kd2[0],kd2[1],kd2[2],kd2[3],kd2[4],11,false));
					$("#tab1 table:eq(0) tbody").append(renderRow_tool("Residence municipality of the 2nd-listed candidate:",md2[0],md2[1],md2[2],md2[3],md2[4],false));
					//$("#tab1 table:eq(0) tbody").append(renderRow_text("Liczba głosów oddanych na&nbsp;dwójkę:",gd_2[0],gd_2[1],gd_2[2],gd_2[3],gd_2[4],12,false));
					$("#tab1 table:eq(0) tbody").append('<tr><td>Number of votes cast for&nbsp;the 2nd-listed candidate:</td>\
						<td>'+lengthToBlank(p.P1_2_g)+numberWithSpaces(p.P1_2_g)+'</td>\
						<td>'+lengthToBlank(p.P2_2_g)+numberWithSpaces(p.P2_2_g)+'</td>\
						<td>'+lengthToBlank(p.P3_2_g)+numberWithSpaces(p.P3_2_g)+'</td>\
						<td>'+lengthToBlank(p.P4_2_g)+numberWithSpaces(p.P4_2_g)+'</td>\
						<td>'+lengthToBlank(p.P5_2_g)+numberWithSpaces(p.P5_2_g)+'</td>\
					</tr>');
					$("#tab1 table:eq(0) tbody").append(renderRow("Percentage of votes cast for&nbsp;the 2nd-listed candidate:",pd_2[0],pd_2[1],pd_2[2],pd_2[3],pd_2[4],400,false));
					$("#tab1 table:eq(0) tbody").append(renderRow("Share of the 2nd-listed candidate in the result of the list:",p.P1_2,p.P2_2,p.P3_2,p.P4_2,p.P5_2,700,false));
					$("#tab1 table:eq(0) tbody").append(renderRow("Share in the number of votes cast for the 2nd-listed candidate in the constituency:",gd2[0],gd2[1],gd2[2],gd2[3],gd2[4],400,true));
					
					//divider
					$("#tab1 table:eq(0) tbody").append(renderRow("Participation in the electoral outcome candidates from the third to the last position on the list:",100-(p.P1_1+p.P1_2),100-(p.P2_1+p.P2_2),100-(p.P3_1+p.P3_2),100-(p.P4_1+p.P4_2),100-(p.P5_1+p.P5_2),700,true));
					
					$("#tab1 table:eq(0) tbody").append(rcol15.join(""));
					$("#tab1 table:eq(0) tbody").append(col15.join(""));
					
					for (i=0;i<5;i++){
						$("#tab1 table:eq(0) .has-tooltip").eq(i).css("color","#e600e6");
						$("#tab1 table:eq(0) .has-tooltip").eq(i).hover(function() {
						  $( this ).css("color","#5024b7");
						},function() {
						  $( this ).css("color","#e600e6");
						});
					}
					for (i=5;i<10;i++){
						$("#tab1 table:eq(0) .has-tooltip").eq(i).css("color","#0D7BC6");
						$("#tab1 table:eq(0) .has-tooltip").eq(i).hover(function() {
						  $( this ).css("color","#c33");
						},function() {
						  $( this ).css("color","#0D7BC6");
						});
					}
					for (i=0;i<3;i++){
						$("#tab1 table:eq(0) tbody tr:eq("+i+") td").css("color","#88419d");
						$("#tab1 table:eq(0) tbody tr:eq("+i+") td").eq(0).css("color","#6e016b");
					}
					for (i=3;i<9;i++){
						$("#tab1 table:eq(0) tbody tr:eq("+i+") td").css("color","#e600e6");
						$("#tab1 table:eq(0) tbody tr:eq("+i+") td").eq(0).css("color","#b300b3");
						$("#tab1 table:eq(0) tbody tr:eq("+(i+6)+") td").css("color","#0D7BC6");
						$("#tab1 table:eq(0) tbody tr:eq("+(i+6)+") td").css("text-shadow",css_sh_cyan);
						$("#tab1 table:eq(0) tbody tr:eq("+(i+6)+") td").eq(0).css("text-shadow","none");
						$("#tab1 table:eq(0) tbody tr:eq("+(i+6)+") td").eq(0).css("color","#0078e3");
					}
					$("#tab1 table:eq(0) tbody tr:eq(15) td").css("color","#ccaa00");
					$("#tab1 table:eq(0) tbody tr:eq(15) td").css("text-shadow", css_sh_yell);
					$("#tab1 table:eq(0) tbody tr:eq(15) td").eq(0).css("text-shadow","none");
					$("#tab1 table:eq(0) tbody tr:eq(15) td").eq(0).css("color","#cc8800");
					$("#tab1").append('<h5 style="text-align: center; color: #484848; padding: 0px 8px;">Additional information:');//Dodatkowe informacje
					$("#tab1").append('<table class = "tabela" id="Podsumowanie2">\
						<thead>\
						</thead>\
						<tbody>\
						</tbody>\
					</table>');
					$("#tab1 table:eq(1) tbody").append('<tr><td>Registered voters:</td><td>'+lengthToBlank(p.LW)+numberWithSpaces(p.LW)+'</td></tr>');
					$("#tab1 table:eq(1) tbody").append('<tr><td>Valid votes:</td><td>'+lengthToBlank(p.LG)+numberWithSpaces(p.LG)+'</td></tr>');
					var ogo = p.LG/json_Okr.getFeaturesByProperty('Okr', p.Okr)[0].properties.L_g*100;
					$("#tab1 table:eq(1) tbody").append('<tr><td>Share in the number of valid votes cast in the constituency:</td><td>'+lengthToBlank1(ogo)+'%</td></tr>');
					var lgp = p.P1_g+p.P2_g+p.P3_g+p.P4_g+p.P5_g;
					$("#tab1 table:eq(1) tbody").append('<tr><td>Number of votes cast for nationwide committees:</td><td>'+lengthToBlank(lgp)+numberWithSpaces(lgp)+'</td></tr>');
					var ogp = lgp/p.LG*100;
					$("#tab1 table:eq(1) tbody").append('<tr><td>Percentage of votes cast for nationwide committees:</td><td>'+lengthToBlank1(ogp)+'%</td></tr>');
					$("#tab1 table:eq(1) tbody tr td").eq(1).css("width","100px");
					$("#tab1 table:eq(1) tbody tr:eq(2) td").eq(1).css("color","#86e");
					$("#tab1 table:eq(1) tbody tr:eq(4) td").eq(1).css("color","#86e");
					/*$("#tab1 table:eq(0) tbody tr:eq(0) td").css("color","#8c6bb1");
					$("#tab1 table:eq(0) tbody tr:eq(0) td").eq(0).css("color","#6e016b");*/
					console.log(JEudzial[p.Powiat]);
					console.log(JEkolor[p.Powiat]);
					
				});
				
				function toPkwSite(party_code, adm_level, adm_code){
					var a_code;
					if (adm_level=='pow'){
						if (adm_code == '1465011'){
							a_code = '146501';
						}else{
							a_code = PJE + '00';
						}
					}else if (adm_level=='okr'){
						a_code = POE;
					}else{
						a_code = '';
					}
					
					return "https://sejmsenat2019.pkw.gov.pl/sejmsenat2019/en/wyniki/komitet/" + party_code + '/sejm/' + adm_level + '/' + a_code;
				}
				
				$('#tab2').ready(function (){
					//$("#tab2").html('<p>W gminie...</p>');
					for (i=2; i<7; i++){
						$('#tab'+i).html('<h5 style = "margin-left:28px; color: #282828;"><a href = "'+toPkwSite(party_codes[i-2],'pow',current_KOD)+'" target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a><span class = "admHead">'+powiat_nazwa+':</span></h5>');
					}
					for (i=0; i<5; i++){
						$('#tab'+(i+2)).append('<p>'+popupContent[i].join("")+'</p>');
						$('#tab'+(i+2)).append('<h5 style = "margin-left:28px; color: #282828;"><a href = "'+toPkwSite(party_codes[i],'okr',current_KOD)+'"  target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a><span class = "admHead">Constituency no.  ' + POE + ':</span></h5>');
						$('#tab'+(i+2)).append('<p>'+opopupContent[i].join("")+'</p>');
						$('#tab'+(i+2)).append('<h5 style = "margin-left:28px; color: #282828;"><a href = "'+toPkwSite(party_codes[i],'pl',current_KOD)+'"  target = "_blank"><img src="images/pkw_pl.png" alt = "PKW" class = "PKW"></a><span class = "admHead">Poland:</span></h5>');
						$('#tab'+(i+2)).append('<p>'+plpopupContent[i].join("")+'</p>');
						$( "p" ).remove( ":contains('undefined')" );
						//$("#tooltip-2").tooltip();
					}
					//console.log(rows_generated);
					for (i=0;i<5;i++){
						for (j=4; j<8; j++){
							$('.tabela.fixedheight:eq('+(i*12+j)+') tbody tr:nth-of-type(odd)').css("background-color","#c7eae5");
							$('.tabela.fixedheight:eq('+(i*12+j)+') thead tr th').css("background-color","#01665e");
							/*$('.tabela.fixedheight:eq('+(i*12+j+4)+') tbody tr:nth-of-type(odd)').css("background-color","#e6f5d0");
							$('.tabela.fixedheight:eq('+(i*12+j+4)+') thead tr th').css("background-color","#4d9221");*/
						}
					}
					//$('#fixedheight td:eq(2) div').css("flex-direction","column");
					
					var JErows = JEkod[PJE][0].length>7?7:JEkod[PJE][0].length;
					$("#tab2").scroll(function () {
						if (!already_filtered){
							sc = $("#tab2").scrollTop();
							$('.tooltips').css("bottom",(sc+0)+"px");
						}
						sc_temp=sc;
					});
					$("#tab3").scroll(function () { 
						if (!already_filtered){
							sc = $("#tab3").scrollTop();
							$('.tooltips').css("bottom",(sc+0)+"px");
						}
						sc_temp=sc;
					});
					$("#tab4").scroll(function () {
						if (!already_filtered){
							sc = $("#tab4").scrollTop();
							$('.tooltips').css("bottom",(sc+0)+"px");
						}
						sc_temp=sc;
					});
					$("#tab5").scroll(function () {
						if (!already_filtered){
							sc = $("#tab5").scrollTop();
							$('.tooltips').css("bottom",(sc+0)+"px");
						}
						sc_temp=sc;
					});
					$("#tab6").scroll(function () {
						if (!already_filtered){
							sc = $("#tab6").scrollTop();
							$('.tooltips').css("bottom",(sc+0)+"px");
						}
						sc_temp=sc;
					});
					function popupToChart(current_tab){
						//console.log($(current_tab)[0]);
						console.log("already_filtered: "+already_filtered);
						
						if ($select.val()=='Poland'/*&&currentAttrValue!='#tab1'*/){
							chart.data.datasets[1].data = scatterPlotDataArray;
							//sc = $(current_tab).scrollTop();
							//$(current_tab).scrollTop($(current_tab).scrollHeight);
							//sc = $(current_tab).scrollTop(400);
							
							if (already_filtered){
								sc = $(current_tab)[0].scrollHeight - $(current_tab).height() - 352;
								console.log( "#tab2 scrollHeight: "+ $(current_tab)[0].scrollHeight +" height: "+ $(current_tab).height()  +" sc: "+ sc);
								console.log($(current_tab + ' .tooltips'));
								$(current_tab + ' .tooltips').css("bottom",(sc/*+24*/)+"px");
							}
							chart.data.datasets[2].data = [];
							drawReg(scatterPlotDataArray);
						}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
							//sc = $(current_tab).height();
							
							if (already_filtered){
								//sc =  $(current_tab)[0].scrollHeight - 2*$(current_tab).height() - 40;
								sc =  2*JErows*36 + 256;
								console.log(sc);
								$(current_tab + ' .tooltips').css("bottom",(sc/*+24*/)+"px");
							}
							var filtered_data = filterChart();
							chart.data.datasets[1].data = filtered_data;
							chart.data.datasets[2].data = scatterPlotDataArray;
							drawReg(filtered_data);
							//console.log(chart.options.tooltips);
						}else {
							if (already_filtered){
								sc = 16;
								$(current_tab + ' .tooltips').css("bottom",(sc/*+24*/)+"px");
							}
							var subfiltered_data = subfilterChart();
							chart.data.datasets[1].data = subfiltered_data;
							chart.data.datasets[2].data = filterChart();
							drawReg(subfiltered_data);
							//console.log(chart.options.tooltips);
						}
						
						/*if($changer.prop('selectedIndex')<6){
							setChart();
						}else{
							fitChart();
						}*/
						already_filtered = false;
						sc_temp = sc;
					}
					
					$('.tabs .tab-links a').on('click', function(e) {
						console.log("already_filtered: " + already_filtered);
						var currentAttrValue = $(this).attr('href');
						$('.tabs ' + currentAttrValue).show().siblings().hide();
						$(this).parent('li').addClass('active').siblings().removeClass('active');
						$("#workAround").html(".tabs .active a:after {background: #4d9221;}");
						/*$("#tab2").scrollTop(sc);
						$("#tab3").scrollTop(sc);
						$("#tab4").scrollTop(sc);
						$("#tab5").scrollTop(sc);
						$("#tab6").scrollTop(sc);*/
						var tab_list = [];
						for (i=2;i<7;i++){
							//$("#tab"+i).scrollTop(sc);
							tab_list.push("#tab"+i);
						}
						
						
						console.log(currentAttrValue.substring(4,5));
						party = currentAttrValue.substring(4,5)-1;
						if (party!=0){
							changeLayer_(currentAttrValue, tab_list);
							changerToChart($changer);
							popupToChart(currentAttrValue);
							console.log("Wartość sc: "+sc);
							setChart();
						}else{
							layer_code = layer_current_cmy._leaflet_id;
							changeLayer_(layer_code, layer_list);
							changerToChart($changer);
							chart.data.datasets[2].data =[];
							sd = $("#tab1").scrollTop();
							$('#tab1 .tooltips').css("bottom",(sd/*+24*/)+"px");
							if ($select.val()=='Poland'){
								//resetLabels();
								chart.data.datasets[1].data = scatterPlotDataArray;
								drawReg(scatterPlotDataArray);
								if($changer.prop('selectedIndex')<6){
									setChart();
								}else{
									fitChart();
								}
							}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
								chart.data.datasets[1].data = filterChart();
								drawReg(filterChart());
								fitChart();
								var okr_ = $select.val();
								if (json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', current_KOD)[0].properties.Okr!=$select.val()){
									chart.data.datasets[0].data = [];
									//chart.data.datasets[0].data.push(0);
								}
							}else {
								chart.data.datasets[1].data = subfilterChart();
								drawReg(subfilterChart());
								fitChart();
								var pow_ = $subselect.val().substring(0,4);
								if (current_KOD.substring(0,4)!=pow_){
									chart.data.datasets[0].data = [];
									//chart.data.datasets[0].data.push(0);
								}
							}
							fitChart();
						}
						//chart.data.datasets[1].data = scatterPlotDataArray;
						//$select.change(subch);
						chart.data.datasets[0].data = checkPoint();
						/*if ($select.val()=='Poland'){
							//resetLabels();
							chart.data.datasets[1].data = scatterPlotDataArray;
							
							drawReg(scatterPlotDataArray);
							if($changer.prop('selectedIndex')<6){
								setChart();
							}else{
								fitChart();
							}
						}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
							chart.data.datasets[1].data = filterChart();
							chart.data.datasets[2].data = scatterPlotDataArray;
							drawReg(filterChart());
							if($changer.prop('selectedIndex')<6){
								setChart();
							}else{
								fitChart();
							}
							var okr_ = $select.val();
							if (json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', current_KOD)[0].properties.Okr!=$select.val()){
								chart.data.datasets[0].data = [];
								//chart.data.datasets[0].data.push(0);
							}
						}else {
							chart.data.datasets[1].data = subfilterChart();
							chart.data.datasets[2].data = filterChart();
							drawReg(subfilterChart());
							if($changer.prop('selectedIndex')<6){
								setChart();
							}else{
								fitChart();
							}
							var pow_ = $subselect.val().substring(0,4);
							if (current_KOD.substring(0,4)!=pow_){
								chart.data.datasets[0].data = [];
								//chart.data.datasets[0].data.push(0);
							}
						}*/
						for (i=2;i<7;i++){
							$("#tab"+i).scrollTop(sc);
							//tab_list.push("#tab"+i);
						}
						chart.update();
						//this.className="thing1 extra_stuff";
						e.preventDefault();
					});
					
					/*for (i=2;i<7;i++){
						$("#tab"+i).scroll(function () { 
						if (!already_filtered){
							sc = $("#tab"+i).scrollTop();
							$('.tooltips').css("bottom",(sc+0)+"px");
						}
						sc_temp=sc;
					});
					}*/
					$('.tabs .tab-links a').on('mouseenter',function(e) {
						//var currentAttrValue = $(this).attr('href');

						// Show/Hide Tabs
						if ($(this).parent('li').prev().hasClass('active')){
							//console.log("Tak!!!");
							
							//$(this).parent('li').prev().children('a').addClass('tab-links extra_stuff').parent('li').siblings().children('a').removeClass('tab-links extra_stuff');
							//console.log($(this).parent('li').prev().children('a'));
							$("#workAround").html(".tabs .active a:after {background: #7fbc41;}"); //Działa
						}else{
							//console.log("Nie!!!");
							$("#workAround").html(".tabs .active a:after {background: #4d9221;}")/*.animate({background: #7fbc41}, 150)*/;
						}
						
						if ($(this).parent('li').next().hasClass('active')){
							//console.log("pTak!!!");
							
							//$(this).parent('li').prev().children('a').addClass('tab-links extra_stuff').parent('li').siblings().children('a').removeClass('tab-links extra_stuff');
							//console.log($(this).parent('li').next().children('a'));
							$("#workAround").html(".tabs .active a:before {background: #7fbc41;}");
						}else{
							//console.log("pNie!!!");
							//$("#workAround").html(".tabs .active a:before {background: #a700e5;}");
						}
						// Change/remove current tab to active
						//$(this).parent('li').addClass('active').siblings().removeClass('active');

						//e.preventDefault();
					});
					$('.tabs .tab-links a').on('mouseleave',function(e) {
						$("#workAround").html(".tabs .active a:after {background: #7F00DA;}");
						//$("#workAround").html(".tabs .tab-links:last-of-type a:after {background: #222;}");
						$("#workAround").html(".tabs .active a:before {background: #4d9221;}");
					});
					$('.has-tooltip span.gmina').on('click',function(e) {
						/*console.log('Clicked!');
						manual_popup = false;
						link_clicked = true;
						block_centering = true;*/
						var kod;
						
						//if ( $(this).parent().parent().children('.tooltip-wrappers').children('.tooltips').children('.kod').length ) {
							kod = $(this).parent().parent().children('.tooltip-wrappers').children('.tooltips').children('.kod').text();
						//}else{
							//kod = current_KOD;
						//}
						
						
						
						//manual_zoom = true;
						//manually_zoomed = false;
						console.log("Kod: "+kod);
						//map.removeLayer(mapLayer1);
						//console.log(party);
						//var tparty = party;
						
						/*var tlayer_current = layer_current;
						var tlayer_current_cmy = layer_current_cmy;*/
						function chLayer(mLayer){
							//console.log(party + ": " + mLayer.getLayers()[1]._leaflet_id + " - " + layer_current._leaflet_id);
							//if (mLayer._leaflet_id != layer_current_tot._leaflet_id){
								/*map.removeLayer(layer_current);
								map.removeLayer(layer_current_cmy);*/
								map.removeLayer(layer_current_tot);
								mLayer.addTo(map);
							//}
						}
						//block_centering = true;
						switch(party){
							case 1:
								chLayer(mapLayer1);
								//mapLayer1.addTo(map);
								//layer_current = layer_P1;
								//layer_current_cmy = layer_P1_cmy;
								break;
							case 2:
								chLayer(mapLayer2);
								//mapLayer2.addTo(map);
								//layer_current = layer_P2;
								//layer_current_cmy = layer_P2_cmy;
								break;
							case 3:
								chLayer(mapLayer3);
								//mapLayer3.addTo(map);
								//layer_current = layer_P3;
								//layer_current_cmy = layer_P3_cmy;
								break;
							case 4:
								chLayer(mapLayer4);
								//mapLayer4.addTo(map);
								//layer_current = layer_P4;
								//layer_current_cmy = layer_P4_cmy;
								break;
							case 5:
								chLayer(mapLayer5);
								//mapLayer5.addTo(map);
								//layer_current = layer_P5;
								//layer_current_cmy = layer_P5_cmy;
								break;
							default:
								//mapLayer1.addTo(map);
								//layer_current = layer_P1;
								//layer_current_cmy = layer_P1_cmy;
						}
						if  ($(this).parents('.pl').length){
							//select_twice = true;
							//if (polind==0){
								//$('#subfilter :nth-child(1)').prop('selected', false).change();
								item_clicked = true;
								$('#filter :nth-child(1)').prop('selected', true).change();
								item_clicked = false;
								//$subselect.empty().change();
								console.log("iii");
								console.log("pop pow kraj");
								//map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [320, 0]});
							//}
							setTimeout(function () {
								item_clicked = false;
							}, 0);
							cind=1;
							polind = 1;
							filtered = false;
							console.log('pow link clicked ' + filtered);
							setTimeout(function () {
								layers[kod].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', /*dashArray: '16, 16',*/  lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
								setTimeout(function () {
									layers[kod].openPopup();
									//resetLabels([layer_Powiaty_Simplified_2]);
								},1000);
							},0);
						} else if($(this).parents('.okr').length){//czy istnieje choć jeden rodzic o klasie "okr"
							/*setTimeout(function () {
								map.fitBounds(wojewods[kod.substring(0,2)].getBounds());
							}, 1000);*/
							//select_twice = true;
							console.log($(this));
							//link_clicked = true;
							//var skod = kod.substring(0,2).toString();
							//var sind = kod.substring(0,2)/2+1;
							var sind = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', kod)[0].properties.Okr;
							//console.log(kod+'-'+skod+'-'+cind+'-'+sind);
							//console.log(wojewods);
							//console.log(wojewods[skod.toString()]);
							
							//console.log($('#subfilter :nth-child(1)'));
							//$select.change(subch);
							//console.log($('#subfilter :nth-child(1)'));
							item_clicked = true;
							if ($select.val()!='Poland'){
								//item_clicked = true;
								$('#subfilter :nth-child(1)').prop('selected', true).change();
								//item_clicked = false;
								console.log('woj link clicked ' + filtered);
								//filtered = false;
								//map.closePopup();
							}
							//if (sind!=cind){
								//item_clicked = true;
								//$('#filter :nth-child('+(sind)+')').prop('selected', true).change();
								$("#filter option").filter(function() {
									//may want to use $.trim in here
									return $(this).text().substring(6,8) == sind;
								}).prop('selected', true).change();
								//item_clicked = false;
								//console.log('Ranking (woj) subch');
								$select.change(subch);
								setTimeout(function () {
									//$('#filter :nth-child('+sind+')').prop('selected', true).change();
									//chart.update();
									//item_clicked = false;
								}, 0);
								console.log('woj link clicked ' + filtered);
								
							//}else{
								//
								//console.log('same woj link clicked ' + filtered);
								//map.fitBounds(wojewods[skod].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							//}
							setTimeout(function () {
								layers[kod].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', /*dashArray: '16, 16',*/  lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
								setTimeout(function () {
									layers[kod].openPopup();
									//resetLabels([layer_Powiaty_Simplified_2]);
								},1000);
								item_clicked = false;
							},0);
							/*setTimeout(function () {
								select_twice = false;
							}, 0);*/
							//map.fitBounds(wojewods[kod.substring(0,2)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							cind=sind;
							polind =0;
							filtered = true;
							//console.log('woj link clicked ' + filtered);
							//map.closePopup();
						} else if ($(this).parents('.pow').length){
							/*setTimeout(function () {
								map.fitBounds(pow_ats[kod.substring(0,4)].getBounds());
							}, 1000);*/
							woj_zoom = false;
							select_twice = true;
							//map.closePopup();
							//var pind = kod.substring(2,4)/1+1;
							
							console.log($select);
							console.log($select.val());
							//if ($select.val()=='Poland'){
								//console.log("Tak - Poland!");
							var wind = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', kod)[0].properties.Okr;
							//if (wind!=cind){
								//$('#filter :nth-child('+wind+')').prop('selected', true).change();
								$("#filter option").filter(function() {
									//may want to use $.trim in here
									return $(this).text().substring(6,8) == wind;
								}).prop('selected', true).change();
								console.log('Ranking (pow) subch');
								$select.change(subch);
								console.log('pow link clicked ' + filtered);
							//}
							//$select.change(subch);
							//subb = 1;
							//$('#subfilter :nth-child('+pind+')').prop('selected', true).change();
							item_clicked = true;
							//manually_zoomed = false;
							$("#subfilter option").filter(function() {
							  //may want to use $.trim in here
							  return $(this).text().substring(0,4) == kod.substring(0,4);
							}).prop('selected', true).change();
							
							console.log('pow link clicked ' + filtered);
							//map.fitBounds(pow_ats[kod.substring(0,4)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							cind=wind;
							polind =0;
							filtered = true;
							setTimeout(function () {
								select_twice = false;
								item_clicked = false;
							}, 0);
							setTimeout(function () {
								layers[kod].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', /*dashArray: '16, 16',*/  lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
								setTimeout(function () {
									layers[kod].openPopup();
									//resetLabels([layer_Powiaty_Simplified_2]);
								},1000);
							},0);
							console.log('pow link clicked ' + filtered);
						}else{
							layers[kod].openPopup();
						}
						//block_centering = false;
						//map.closePopup();
						//console.log(kod);
						//console.log(layers[kod]);
						/*layer_current.eachLayer(function(layer) {
							layer_current.resetStyle(layer);*/
						//});
						
						/*setTimeout(function () {
								layers[kod].openPopup();
								//map.spin(false);
						}, 2500);*/
						//map.spin(false);
						/*$(document).ready(function(){
							layers[kod].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
							layers[kod].openPopup();
						});*/
						
						/*setTimeout(function () {
							layers[kod].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
							layers[kod].openPopup();
						},0);*/
						/*block_centering = false;
						customControlLayers();
						manual_popup = true;*/
					});	
					$('.tab-content div h5 span').on('click',function(e) {
						var kod = current_KOD;
						function chLayer(mLayer){
							//console.log(party + ": " + mLayer.getLayers()[1]._leaflet_id + " - " + layer_current._leaflet_id);
							//if (mLayer._leaflet_id != layer_current_tot._leaflet_id){
								/*map.removeLayer(layer_current);
								map.removeLayer(layer_current_cmy);*/
								map.removeLayer(layer_current_tot);
								mLayer.addTo(map);
							//}
						}
						//block_centering = true;
						switch(party){
							case 1:
								chLayer(mapLayer1);
								//mapLayer1.addTo(map);
								//layer_current = layer_P1;
								//layer_current_cmy = layer_P1_cmy;
								break;
							case 2:
								chLayer(mapLayer2);
								//mapLayer2.addTo(map);
								//layer_current = layer_P2;
								//layer_current_cmy = layer_P2_cmy;
								break;
							case 3:
								chLayer(mapLayer3);
								//mapLayer3.addTo(map);
								//layer_current = layer_P3;
								//layer_current_cmy = layer_P3_cmy;
								break;
							case 4:
								chLayer(mapLayer4);
								//mapLayer4.addTo(map);
								//layer_current = layer_P4;
								//layer_current_cmy = layer_P4_cmy;
								break;
							case 5:
								chLayer(mapLayer5);
								//mapLayer5.addTo(map);
								//layer_current = layer_P5;
								//layer_current_cmy = layer_P5_cmy;
								break;
							default:
								//mapLayer1.addTo(map);
								//layer_current = layer_P1;
								//layer_current_cmy = layer_P1_cmy;
						}
						if  ($(this).text().substring(0,3)=='Pol'){
							//select_twice = true;
							//if (polind==0){
								//$('#subfilter :nth-child(1)').prop('selected', false).change();
								adm_clicked = true;
								$('#filter :nth-child(1)').prop('selected', true).change();
								adm_clicked = false;
								//$subselect.empty().change();
								console.log("iii");
								console.log("pop pow kraj");
								//map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [320, 0]});
							//}
							/*setTimeout(function () {
								select_twice = false;
							}, 0);*/
							cind=1;
							polind = 1;
							filtered = false;
						} else if($(this).text().substring(0,3)=='Okr'){
							/*setTimeout(function () {
								map.fitBounds(wojewods[kod.substring(0,2)].getBounds());
							}, 1000);*/
							//select_twice = true;
							console.log($(this));
							//link_clicked = true;
							//var skod = kod.substring(0,2).toString();
							//var sind = kod.substring(0,2)/2+1;
							var sind = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', kod)[0].properties.Okr;
							//console.log(kod+'-'+skod+'-'+cind+'-'+sind);
							//console.log(wojewods);
							//console.log(wojewods[skod.toString()]);
							
							//console.log($('#subfilter :nth-child(1)'));
							//$select.change(subch);
							//console.log($('#subfilter :nth-child(1)'));
							
							if ($select.val()!='Poland'){
								//item_clicked = true;
								$('#subfilter :nth-child(1)').prop('selected', true).change();
								//item_clicked = false;
								console.log('woj link clicked ' + filtered);
								//filtered = false;
								//map.closePopup();
							}
							//if (sind!=cind){
								adm_clicked = true;
								//$('#filter :nth-child('+(sind)+')').prop('selected', true).change();
								$("#filter option").filter(function() {
									//may want to use $.trim in here
									return $(this).text().substring(6,8) == sind;
								}).prop('selected', true).change();
								adm_clicked = false;
								//console.log('Ranking (woj) subch');
								$select.change(subch);
								/*setTimeout(function () {
									$('#filter :nth-child('+sind+')').prop('selected', true).change();
									//chart.update();
								}, 500);*/
								console.log('woj link clicked ' + filtered);
								
							//}else{
								//
								//console.log('same woj link clicked ' + filtered);
								//map.fitBounds(wojewods[skod].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							//}
							/*setTimeout(function () {
								select_twice = false;
							}, 0);*/
							//map.fitBounds(wojewods[kod.substring(0,2)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							cind=sind;
							polind =0;
							filtered = true;
							//console.log('woj link clicked ' + filtered);
							//map.closePopup();
						} else if ($(this).text().substring(0,3)=='pow'){
							/*setTimeout(function () {
								map.fitBounds(pow_ats[kod.substring(0,4)].getBounds());
							}, 1000);*/
							woj_zoom = false;
							select_twice = true;
							//map.closePopup();
							//var pind = kod.substring(2,4)/1+1;
							
							console.log($select);
							console.log($select.val());
							//if ($select.val()=='Poland'){
								//console.log("Tak - Poland!");
							var wind = json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', kod)[0].properties.Okr;
							//if (wind!=cind){
								//$('#filter :nth-child('+wind+')').prop('selected', true).change();
								$("#filter option").filter(function() {
									//may want to use $.trim in here
									return $(this).text().substring(6,8) == wind;
								}).prop('selected', true).change();
								console.log('Ranking (pow) subch');
								$select.change(subch);
								console.log('pow link clicked ' + filtered);
							//}
							//$select.change(subch);
							//subb = 1;
							//$('#subfilter :nth-child('+pind+')').prop('selected', true).change();
							adm_clicked = true;
							//manually_zoomed = false;
							$("#subfilter option").filter(function() {
							  //may want to use $.trim in here
							  return $(this).text().substring(0,4) == kod.substring(0,4);
							}).prop('selected', true).change();
							//adm_clicked = false;
							console.log('pow link clicked ' + filtered);
							//map.fitBounds(pow_ats[kod.substring(0,4)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							cind=wind;
							polind =0;
							filtered = true;
							setTimeout(function () {
								select_twice = false;
								adm_clicked = false;//
								//resetLabels([layer_Powiaty_Simplified_2]);
							}, 0);
						}else{
							//layers[kod].openPopup();
						}
					});
				});
				
			});
			//if(!block_centering||!select_twice){
			/*setTimeout(function () {
				console.log("programmaticMapManipulation: " + programmaticMapManipulation);
			}, 3200);*/
				setTimeout(function () {
					if (layers[current_KOD].isPopupOpen()||r_layers[current_KOD].isPopupOpen()){
						//pop_moving = true;
						//map.spin(true);
						setTimeout(function () {
							
							px = map.project(e.target._popup._latlng); // find the pixel location on the map where the popup anchor is
							console.log(e);
							px.y -= e.target._popup._container.clientHeight/2+32; // find the height of the popup container, divide by 2, subtract from the Y axis of marker location
							px.x += 128;
						}, 500);
						
						setTimeout(function () {
							map.panTo(map.unproject(px),{animate: true, duration: 0.8}); // pan to new center
							pop_moving = false;
							//programmaticMapManipulation = false;
						}, 600);
						//alert("Popup shifted");
						//setTimeout(function () {
							//pop_moving = false;
							//map.spin(false);
						//}, 0);
					}
					
				}, 0);
			//}
		});
		map.on('popupclose', function(e) {
			//$('.leaflet-sbs-range').css("z-index", "9999");
			$('.leaflet-sbs-range').attr('style', 'z-index: 9990 !important');
			$('.leaflet-sbs-divider').css("z-index", "999");
			layer_current.resetStyle();
			layer_current_cmy.resetStyle();
			already_filtered = true;
			layer_code = layer_current_cmy._leaflet_id;
			party = 0;
			
			changeLayer_(layer_code, layer_list);
			changerToChart($changer);
			chart.data.datasets[2].data =[];
			chart.data.datasets[0].data = checkPoint();
			//map.spin(true);
			pop_moving = true;
			if ($select.val()=='Poland'){
				//resetLabels();
				chart.data.datasets[1].data = scatterPlotDataArray;
				drawReg(scatterPlotDataArray);
				if($changer.prop('selectedIndex')<6){
					setChart();
				}else{
					fitChart();
				}
				if (!manually_zoomed){
					if(!block_centering||!select_twice){
						programmaticMapManipulation = true;
						map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						setTimeout(function () {
							programmaticMapManipulation = false;
						},0);
						//alert("Popup closed! - kraj");
					}
				}else{
					if(!block_centering){
						var cbounds = layers[current_KOD]/*wojewods[woj]*/.getBounds();
						var vzoom = map.getZoom();
						map.setMaxZoom(vzoom);
						if  (vzoom == 6){
							map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						}else{
							map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						}
						map.setMaxZoom(10);
					}
				}
			}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
				chart.data.datasets[1].data = filterChart();
				drawReg(filterChart());
				fitChart();
				var okr_ = $select.val();
				if (json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', current_KOD)[0].properties.Okr!=okr_){
					chart.data.datasets[0].data = [];
					//chart.data.datasets[0].data.push(0);
				}
				if (!manually_zoomed){
					if(!block_centering||!select_twice){
						programmaticMapManipulation = true;
						map.fitBounds(okrs[okr_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						//alert("Popup closed! - kraj");
						setTimeout(function () {
							programmaticMapManipulation = false;
						},0);
					}
				}else{
					if(!block_centering){
						var cbounds = layers[current_KOD]/*wojewods[woj]*/.getBounds();
						var vzoom = map.getZoom();
						map.setMaxZoom(vzoom);
						if  (vzoom == 6){
							map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						}else{
							map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						}
						map.setMaxZoom(10);
					}
				}
			}else {
				chart.data.datasets[1].data = subfilterChart();
				drawReg(subfilterChart());
				fitChart();
				var pow_ = $subselect.val().substring(0,4);
				if (current_KOD.substring(0,4)!=pow_){
					chart.data.datasets[0].data = [];
					//chart.data.datasets[0].data.push(0);
				}
				if (!manually_zoomed){
					
					if(!block_centering||!select_twice){
						programmaticMapManipulation = true;
						map.fitBounds(pow_ats[pow_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						setTimeout(function () {
							programmaticMapManipulation = false;
						},0);
					}
				}else{
					if(!block_centering){
						var cbounds = layers[current_KOD]/*wojewods[woj]*/.getBounds();
						var vzoom = map.getZoom();
						map.setMaxZoom(vzoom);
						if  (vzoom == 6){
							map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						}else{
							map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						}
						map.setMaxZoom(10);
					}
				}
			}
			setTimeout(function () {
				pop_moving = false;
				//map.spin(false);
			},0);
			chart.update();
			//resetLabels([layer_Powiaty_Simplified_2]);
		});
		function updateData_cmy(dim1, dim2, perc, dcol){
			return layer_current_cmy.eachLayer(function (evt, idx) {
				var p = evt.feature.properties;
				layers[p.JPT_KOD_JE] = evt;
				rotateData(p, p[dim1], p[dim2], p[perc]);
				pointBackgroundColors.push(colorconvert(p[dcol],0.8));
				pointFBackgroundColors.push(p[dcol]);
				pointBBackgroundColors.push(colorconvert(p[dcol],0.32));
				//pointRBBorderColors.push(colorconvert(p[dcol],0.32));
				
			});
		}
		function updateData(clayer){
			return clayer.eachLayer(function (layer) {
				var p = layer.feature.properties;
				r_layers[p.JPT_KOD_JE] = layer;
				pointRBackgroundColors.push(colorconvert(layer.options.fillColor,0.8));
				pointRFBackgroundColors.push(layer.options.fillColor);
				pointRBBackgroundColors.push(colorconvert(layer.options.fillColor,0.32));
			});
		}
		
		function changeLayer_(idl, opt){
			pointBackgroundColors =[];
			pointBBackgroundColors =[];
			pointFBackgroundColors =[];
			pointRBackgroundColors =[];
			pointRBBackgroundColors =[];
			pointRFBackgroundColors =[];
			layers = {};
			r_layers = {};
			searchControl._layer = layer_current_cmy;
			scatterPlotDataArray_xy = [];
			scatterPlotDataArray_xz= [];
			scatterPlotDataArray_yx = [];
			scatterPlotDataArray_yz = [];
			scatterPlotDataArray_zx = [];
			scatterPlotDataArray_zy = [];
			scatterPlotDataArray_xp = [];
			scatterPlotDataArray_yp = [];
			scatterPlotDataArray_zp = [];
			scatterPlotDataArray_px = [];
			scatterPlotDataArray_py = [];
			scatterPlotDataArray_pz = [];
			switch(idl){
				case opt[0]:
					updateData_cmy("P1_1", "P1_2", "P1_p", "P1_rgb");
					layer_nr = 1;
					updateLabels(1);
					chart.options.title.text = ['Participation of candidates in the electoral outcome', 'and support for' + name_1 + ':'];
					updateData(layer_P1);
					break;
				case opt[1]:
					updateData_cmy("P2_1", "P2_2", "P2_p", "P2_rgb");
					layer_nr = 2;
					updateLabels(2);
					chart.options.title.text = ['Participation of candidates in the electoral outcome', 'and support for' + name_2 + ':'];
					updateData(layer_P2);
					break;
				case opt[2]:
					updateData_cmy("P3_1", "P3_2", "P3_p", "P3_rgb");
					layer_nr = 3;
					updateLabels(3);
					chart.options.title.text = ['Participation of candidates in the electoral outcome', 'and support for' + name_3 + ':'];
					updateData(layer_P3);
					break;
				case opt[3]:
					updateData_cmy("P4_1", "P4_2", "P4_p", "P4_rgb");
					layer_nr = 4;
					updateLabels(4);
					chart.options.title.text = ['Participation of candidates in the electoral outcome', 'and support for' + name_4 + ':'];
					updateData(layer_P4);
					break;
				case opt[4]:
					updateData_cmy("P5_1", "P5_2", "P5_p", "P5_rgb");
					layer_nr = 5;
					updateLabels(5);
					chart.options.title.text = ['Participation of candidates in the electoral outcome', 'and support for' + name_5 + ':'];
					updateData(layer_P5);
					break;
				default:
					updateData_cmy("P1_1", "P1_2", "P1_p", "P1_rgb");
					layer_nr = 1;
					updateLabels(1);
					chart.options.title.text = ['Participation of candidates in the electoral outcome', 'and support for' + name_1 + ':'];
					updateData(layer_current);
			}
			
			
		}
		function changeIcon_(idl){
			switch(idl){
				case l1:
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/1.png" style="width: 200px; opacity: 0.9; margin-bottom: -32px;">');
					$('#ltitle').html('Support in municipalities for' + name_1 + ':');
					$('#vlegend').html(drawLegend(fcolors, pisbreaks));
					break;
				case l2:
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2.png" style="width: 200px; opacity: 0.9; margin-bottom: 0px;">');
					$('#ltitle').html('Support in municipalities for' + name_2 + ':');
					$('#vlegend').html(drawLegend(fcolors, kobreaks));
					break;
				case l3:
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/3.png" style="width: 200px; opacity: 0.9; margin-bottom: 12px;">');
					$('#ltitle').html('Support in municipalities for' + name_3 + ':');
					$('#vlegend').html(drawLegend(fcolors, lbreaks));
					break;
				case l4:
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/4.png" style="width: 200px; opacity: 0.9; margin-bottom: -60px;">');
					$('#ltitle').html('Support in municipalities for' + name_4 + ':');
					$('#vlegend').html(drawLegend(fcolors, pslbreaks));
					break;
				case l5:
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/5.png" style="width: 200px; opacity: 0.9; margin-bottom: 4px;">');
					$('#ltitle').html('Support in municipalities for' + name_5 + ':');
					$('#vlegend').html(drawLegend(fcolors, konfbreaks));
					break;
				default:
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/1.png" style="width: 200px; opacity: 0.9; margin-bottom: -32px;">');
					$('#ltitle').html('Support in municipalities for' + name_1 + ':');
					$('#vlegend').html(drawLegend(fcolors, pisbreaks));
			}
			
		}
		
		map.on('baselayerchange', function (eventLayer) {
			console.log(eventLayer.layer.getLayers()[0]);
			layer_current_cmy = eventLayer.layer.getLayers()[0];
			layer_current_tot = eventLayer.layer;
			layer_current = eventLayer.layer.getLayers()[1];
			console.log(layer_current);
			layer_code = layer_current_cmy._leaflet_id;
			changeLayer_(layer_code, layer_list);
			changeIcon_(layer_code);
			console.log(pointBackgroundColors);
			//changerToChart($changer);
			console.log(pointRFBackgroundColors);
			//chart.data.datasets[1].pointBackgroundColor = pointBackgroundColors;
			changerToChart($changer);
			//chart.data.datasets[1].data = scatterPlotDataArray;
			//$select.change(subch);
			chart.data.datasets[0].data = checkPoint();
			if ($select.val()=='Poland'){
				//resetLabels();
				chart.data.datasets[1].data = scatterPlotDataArray;
				drawReg(scatterPlotDataArray);
				if($changer.prop('selectedIndex')<6){
					setChart();
				}else{
					fitChart();
				}
			}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
				chart.data.datasets[1].data = filterChart();
				drawReg(filterChart());
				fitChart();
				var okr_ = $select.val();
				if (json_GminydemDPolygon_0.getFeaturesByProperty('JPT_KOD_JE', current_KOD)[0].properties.Okr!=$select.val()){
					chart.data.datasets[0].data = [];
					//chart.data.datasets[0].data.push(0);
				}
			}else {
				chart.data.datasets[1].data = subfilterChart();
				drawReg(subfilterChart());
				fitChart();
				var pow_ = $subselect.val().substring(0,4);
				if (current_KOD.substring(0,4)!=pow_){
					chart.data.datasets[0].data = [];
					//chart.data.datasets[0].data.push(0);
				}
			}
			
			
			//changerToChart($changer);
			chart.update();
		});
		
		map.on('overlayadd', function (eventLayer) {
			//if (eventLayer.name==||eventLayer.name==
			var i = 0;
			layer_Powiaty_Simplified_2.eachLayer(function(layer) {
				layer.closeTooltip();
				layer.openTooltip(lab_centers[i]);
				i++;
			});
			//resetLabels([layer_Powiaty_Simplified_2]);
			
			if (/*!filtered&&currentAttrValue!='#tab1'*/$select.val()=='Poland'){
				layer_Okr_2.setStyle({color: 'rgba(80,80,80,1.0)'/*, fillColor: 'rgba(255,224,224,0.0)'*/, fillPattern: patt_blank});
				layer_Powiaty_Simplified_1.setStyle({color: 'rgba(96,96,96,1.0)'/*, fillColor: 'rgba(255,224,224,0.0)'*/, fillPattern: patt_blank});
				//map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.75});
				
			}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
				
				var okr_ = $select.val();
				okrs[okr_].setStyle({color: 'rgba(160,0,0,1.0)', fillPattern: stripes});
				okrs[okr_].bringToFront();
				//map.fitBounds(wojewods[woj].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.75});
			}else {
				var pow_ = $subselect.val().substring(0,4);
				pow_ats[pow_].setStyle({color: 'rgba(160,32,32,1.0)'/*, fillColor: 'rgba(255,224,224,0.25)'*/, fillPattern: stripes});
				ptemp = plabels[pow_]._tooltip._container.innerHTML.replace(tool_unchecked, tool_checked);
				plabels[pow_]._tooltip._container.innerHTML = ptemp;
				pow_ats[pow_].bringToFront();
				pow_last = pow_;
				//map.fitBounds(pow_ats[pow_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.75});

			}
			var i = 0;
			layer_Powiaty_Simplified_1.eachLayer(function(layer) {
				layer.closeTooltip();
				layer.openTooltip(lab_centers[i]);
				i++;
			});
			resetLabels([layer_Powiaty_Simplified_1]);
			
		});
		
		
		
		var visible;
		function zoomToLabels(){
			resetLabels([layer_Powiaty_Simplified_2]);
			var zoom;
			zoom = map.getZoom();
			//setTimeout(function () {
			
			//if($select.val()=='Poland'){
			/*if (zoom < tooltipThreshold && (!lastZoom || lastZoom >= tooltipThreshold)) {
				map.getPane('labels').style.display = 'none';
				map.getPane('labels').style['text-align'] = 'center';
				resetLabels([layer_Powiaty_Simplified_2]);
			} else if (zoom >= tooltipThreshold && (!lastZoom || lastZoom < tooltipThreshold)) { 
				map.getPane('labels').style.display = 'inline-block';
				map.getPane('labels').style['text-align'] = 'center';
			}*/
			//}
			//}, 500);
			//setTimeout(function () {
			if (zoom < tooltipThreshold/* && (!lastZoom || lastZoom >= tooltipThreshold)*/) {
				//alert("Za mało!!");
				map.getPane('labels').style.display = 'none';
			} else if (zoom >= tooltipThreshold/* && (!lastZoom || lastZoom < tooltipThreshold)*/) {
				map.getPane('labels').style.display = 'inline-block';
				map.getPane('labels').style['text-align'] = 'center';
				/*if ((zoom - prezoom) > 1){
					console.log("zoom - prezoom > 1");
					resetLabels([layer_Powiaty_Simplified_2]);
					map.getPane('labels').style.display = 'inline-block';
					map.getPane('labels').style['text-align'] = 'center';
				}*/
			}else{
				//
			}
			//}, 600);
			selected = false;
			lastZoom = zoom;
			var i = 0;
			setTimeout(function () {
				layer_Powiaty_Simplified_2.eachLayer(function(layer) {
					var slbl = lbl[i].getTooltip();
					slbl.setLatLng(lab_centers[i]);
					i++;
				});
				resetLabels([layer_Powiaty_Simplified_2]);
				
			},50);
		}
		
		map.on('zoomstart', function () {
			prezoom = map.getZoom();
			//alert("Zooming!");
			/*if (!already_selected&&!popup_close_first_clicked){
				auto_zoom = false;
			}
			console.log("already_selected: " + already_selected);
			console.log("popup_close_first_clicked: " + popup_close_first_clicked);*/
			
			if (layers[current_KOD].isPopupOpen()){
				console.log("Zoom - popup zamknięty");
				//setTimeout(function () {
					pop_op=true;
				//}, 0);
				//block_centering = true;
				
				//setTimeout(function () {
					//map.closePopup();
				//}, 0);
			}
			
		});
		
		map.on('zoomend', function () {
			
			var currentZoom = map.getZoom();
			layer_Powiaty_Simplified_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.08});
			layer_Powiaty_Simplified_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.44});
			layer_Okr_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.6});
			layer_Okr_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.56});
			if ($select.val()=='Poland'){
				console.log("Bez filtrowania");
			}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
				//layer_Powiaty_Simplified_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.08});
				//layer_Powiaty_Simplified_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.44});
				//layer_Okr_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.6});
				var okr_ = $select.val();
				okrs[okr_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.24});
				okrs2[okr_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*3.36});
				//layer_Okr_2._layers.indexOf(okrs[okr_]).setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*3.2});
				console.log(layer_Okr_2._layers);
				console.log(okrs);
				okrs[okr_].bringToFront();
				//layer_Okr_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.56});
			}else {
				var pow_ = $subselect.val().substring(0,4);
				pow_ats[pow_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.44});
				pow_ats2[pow_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.16});
				pow_ats[pow_].bringToFront();
			}
			/*layer_Powiaty_Simplified_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.08});
			layer_Powiaty_Simplified_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.44});
			layer_Okr_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.6});
			layer_Okr_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.56});*/
			/*layer_Granicewojewdztw_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.33});
			layer_Okr_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*3.6});*/
			zoomToLabels(currentZoom);
			console.log(plabels);
			console.log("End of zoom");
			if (pop_op){
				
				setTimeout(function () {
					//layers[current_KOD].openPopup();
					pop_op=false;
				}, 0);
			}
			setTimeout(function () {
				setTimeout(function () {
					zooming = false;
				}, 500);
				//zoomToLabels();
				
				//resetLabels([layer_Powiaty_Simplified_2]);
				//map.spin(false);
			}, 0);
			var i = 0;
			setTimeout(function () {
				layer_Powiaty_Simplified_2.eachLayer(function(layer) {
					var slbl = lbl[i].getTooltip();
					slbl.setLatLng(lab_centers[i]);
					i++;
				});
				resetLabels([layer_Powiaty_Simplified_2]);
				
			},50);
			//px = map.project(layer_current.target._popup._latlng); // find the pixel location on the map where the popup anchor is
			//block_centering = false;
		});
		map.on('zoomstart', function () {
			//alert("manually_zoomed: " + manually_zoomed);
			//map.spin(true);
			if (!programmaticMapManipulation){
				manually_zoomed = true;
			}
		});
		map.on('movestart', function () {
			//if (programmaticMapManipulation||pop_moving){
				map.spin(true);
			//};
		});
		map.on('moveend', function () {
			map.spin(false);
			setTimeout(function () {
				map.spin(false);
			}, 3000);
		});
		zooming = true;
        //osmGeocoder.addTo(map);
        //setBounds();
        </script>
    </body>
</html>
